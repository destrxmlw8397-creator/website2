<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>‡¶™‡ßç‡¶∞‡ßã ‡¶∂‡¶™ - ‡¶Ü‡¶≤‡¶ü‡¶ø‡¶Æ‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶´‡ßá‡¶∂‡¶®‡¶æ‡¶≤ POS ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</title>
    
    <!-- Core CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Font Awesome & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- Dropbox API -->
    <script src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="YOUR_APP_KEY"></script>
    
    <!-- PWA Support -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f3f4f6;
            --success: #10b981;
            --info: #3b82f6;
        }
        
        body {
            font-family: 'Hind Siliguri', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        /* Language Selector */
        .language-selector {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10001;
            background: white;
            border-radius: 30px;
            padding: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .lang-btn {
            padding: 8px 16px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .lang-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .lang-btn:not(.active) {
            background: #f3f4f6;
            color: #374151;
        }
        
        /* Modal Styles */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 9999; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            backdrop-filter: blur(5px);
            overflow-y: auto; 
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
            border-radius: 15px;
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* POS Grid */
        .pos-grid { 
            display: grid; 
            grid-template-columns: 1fr 350px; 
            gap: 20px; 
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .pos-grid { 
                grid-template-columns: 1fr; 
                gap: 10px;
            }
            
            .pos-grid > div:first-child { order: 1; }
            .pos-grid > div:last-child { order: 2; }
            
            .mobile-menu-active { 
                display: block !important; 
                position: fixed !important;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                z-index: 9998;
                overflow-y: auto;
                animation: slideIn 0.3s ease-out;
            }
            
            @keyframes slideIn {
                from { transform: translateX(-100%); }
                to { transform: translateX(0); }
            }
            
            .modal-content { width: 95% !important; margin: 10px auto; }
            .stats-grid { grid-template-columns: repeat(2, 1fr) !important; }
            .text-2xl { font-size: 1.2rem !important; }
            .p-6 { padding: 1rem !important; }
            .product-card { padding: 0.75rem !important; }
            .product-card p { font-size: 0.85rem !important; }
            .cart-item { flex-direction: column !important; align-items: flex-start !important; gap: 0.5rem !important; padding: 0.75rem !important; }
            #pos-search { font-size: 16px !important; padding: 12px !important; }
            .touch-target { min-height: 48px !important; }
            button, .btn-primary, .btn-success, .btn-danger { font-size: 16px !important; padding: 12px !important; }
            input, select, textarea { font-size: 16px !important; padding: 12px !important; }
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #barcode-print-area, #barcode-print-area * { visibility: visible; }
            #bulk-barcode-print-area, #bulk-barcode-print-area * { visibility: visible; }
            #a4-print-section, #a4-print-section * { visibility: visible; }
            
            #print-section { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 80mm; 
                padding: 5px;
            }
            #a4-print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                padding: 10mm;
                background: white;
            }
            #bulk-barcode-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: flex !important;
                flex-wrap: wrap;
                gap: 5px;
            }
            .no-print { display: none !important; }
        }

        /* Dark Mode */
        .dark-mode { 
            background: #1a1a1a; 
            color: #e5e5e5; 
        }
        
        .dark-mode .bg-white { 
            background-color: #2d2d2d; 
            color: #fff; 
        }
        
        .dark-mode header h1, 
        .dark-mode h3 { 
            color: #fff; 
        }

        /* Scrollbar */
        ::-webkit-scrollbar { 
            width: 8px; 
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb { 
            background: var(--primary); 
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Invoice Table */
        .a4-table th, 
        .a4-table td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }

        /* Auth Screen */
        #auth-screen {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, #818cf8 100%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 10000;
            padding: 10px;
        }
        
        /* Badges */
        .pending-badge {
            background-color: var(--warning);
            color: #000;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .owner-badge {
            background-color: #8b5cf6;
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 999px;
            display: inline-block;
        }
        
        .staff-badge {
            background-color: var(--secondary);
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 999px;
            display: inline-block;
        }
        
        /* Permission Chips */
        .permission-chip {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            margin: 2px;
            background-color: #e5e7eb;
            color: #374151;
            transition: all 0.3s;
        }
        
        .permission-chip.active {
            background-color: var(--secondary);
            color: white;
        }
        
        .permission-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Touch Targets */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(79, 70, 229, 0.4);
        }
        
        .btn-primary:active { transform: translateY(0); }
        
        .btn-success {
            background: linear-gradient(135deg, var(--secondary) 0%, #059669 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        /* Product Cards */
        .product-card {
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: var(--primary);
        }
        
        .product-card.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .product-card.out-of-stock:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Cart Items */
        .cart-item {
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .cart-item:hover {
            border-left-color: var(--primary);
            background-color: #f9fafb;
        }
        
        /* Forms */
        input, select, textarea {
            transition: all 0.3s;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
            z-index: 10001;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.success { border-left-color: var(--secondary); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        
        /* Stat Cards */
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            transition: all 0.3s;
            border-left: 4px solid var(--primary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        /* Product Image Gallery */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .gallery-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .gallery-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            transition: all 0.3s;
        }
        
        .gallery-item:hover img {
            transform: scale(1.1);
        }
        
        .gallery-item .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .gallery-item:hover .remove-image {
            opacity: 1;
        }
        
        /* Branch Selector */
        .branch-selector {
            position: fixed;
            top: 70px;
            right: 10px;
            z-index: 1000;
            background: white;
            border-radius: 30px;
            padding: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        /* Offline Badge */
        .offline-badge {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: var(--warning);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        
        /* Drag & Drop */
        .draggable {
            cursor: move;
            transition: all 0.3s;
        }
        
        .draggable.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        /* Keyboard Shortcuts Hint */
        .shortcuts-hint {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: var(--dark);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 12px;
            z-index: 1000;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.3s;
        }
        
        .shortcuts-hint:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        /* Warranty Badge */
        .warranty-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 8px;
        }
        
        /* Serial Number Input */
        .serial-input {
            font-family: monospace;
            letter-spacing: 2px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans transition-colors duration-300" data-layout="desktop" data-language="bn" data-offline="false">

    <!-- Language Selector -->
    <div class="language-selector">
        <button class="lang-btn active" onclick="setLanguage('bn')">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>
        <button class="lang-btn" onclick="setLanguage('en')">English</button>
    </div>
    
    <!-- Branch Selector -->
    <div class="branch-selector hidden" id="branchSelector">
        <select id="branchSelect" onchange="switchBranch(this.value)" class="border-0 bg-transparent px-3 py-2">
            <option value="main">‡¶Æ‡ßÇ‡¶≤ ‡¶∂‡¶æ‡¶ñ‡¶æ</option>
        </select>
    </div>
    
    <!-- Offline Mode Badge -->
    <div class="offline-badge hidden" id="offlineBadge">
        <i class="fas fa-wifi-slash mr-1"></i> ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßã‡¶°
    </div>
    
    <!-- Keyboard Shortcuts Hint -->
    <div class="shortcuts-hint" onclick="showShortcuts()">
        <i class="fas fa-keyboard mr-1"></i> ‡¶∂‡¶∞‡ßç‡¶ü‡¶ï‡¶æ‡¶ü
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-md text-center max-h-[90vh] overflow-y-auto">
            <div class="flex justify-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-store text-white text-4xl"></i>
                </div>
            </div>
            <h2 class="text-2xl md:text-3xl font-bold text-indigo-700 mb-6 shop-name-display">‡¶™‡ßç‡¶∞‡ßã ‡¶∂‡¶™</h2>
            
            <!-- Login Form -->
            <div id="login-form">
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block lang-username">‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ</label>
                    <input type="text" id="auth-username" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block lang-password">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</label>
                    <input type="password" id="auth-pass" placeholder="********" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-bold mb-4 touch-target hover:from-indigo-700 hover:to-purple-700 transition-all">
                    <i class="fas fa-sign-in-alt mr-2"></i><span class="lang-login">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                </button>
                <p class="text-sm text-gray-500"><span class="lang-no-account">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï?</span> <a href="#" onclick="toggleAuthForms()" class="text-indigo-600 underline font-bold lang-register">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</a></p>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form" class="hidden">
                <div class="bg-indigo-50 p-3 rounded-lg mb-4">
                    <p class="text-sm text-indigo-600 font-bold lang-only-owner">‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø</p>
                </div>
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block lang-username">‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ</label>
                    <input type="text" id="reg-username" placeholder="‡ß© ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block lang-password">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</label>
                    <input type="password" id="reg-pass" placeholder="‡ß™ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block lang-shop-name">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="reg-shop-name" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∞‡¶π‡¶ø‡¶Æ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block lang-phone">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
                    <input type="text" id="reg-phone" placeholder="‡ß¶‡ßß‡ß≠XXXXXXXX" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <button onclick="handleOwnerSignup()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 rounded-lg font-bold mb-4 touch-target hover:from-green-700 hover:to-emerald-700 transition-all">
                    <i class="fas fa-user-plus mr-2"></i><span class="lang-register-complete">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                </button>
                <p class="text-sm text-gray-500"><span class="lang-have-account">‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá?</span> <a href="#" onclick="toggleAuthForms()" class="text-indigo-600 underline font-bold lang-login-link">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</a></p>
            </div>
        </div>
    </div>

    <!-- Admin Approval Modal -->
    <div id="adminApprovalModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-2/3 p-4 md:p-6 shadow-xl modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-indigo-600 lang-pending-owners">üë• ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï</h2>
                <button onclick="closeModal('adminApprovalModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="pending-users-list" class="space-y-3 overflow-y-auto max-h-[60vh]"></div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('adminApprovalModal')" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 transition-all touch-target lang-close">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Permission Edit Modal -->
    <div id="permissionEditModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/2 p-4 md:p-6 shadow-xl modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-purple-600 lang-edit-permission">‚úèÔ∏è ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶® ‡¶è‡¶°‡¶ø‡¶ü</h2>
                <button onclick="closeModal('permissionEditModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <input type="hidden" id="edit-staff-username">
            
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="text-sm text-gray-600 mb-1 block lang-staff-username">‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ</label>
                        <input type="text" id="edit-staff-username-display" class="w-full border p-2 rounded bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600 mb-1 block lang-staff-name">‡¶∏‡ßç‡¶ü‡¶æ‡¶´‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                        <input type="text" id="edit-staff-name" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600 mb-1 block lang-staff-phone">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
                        <input type="text" id="edit-staff-phone" class="w-full border p-2 rounded">
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="font-bold text-sm mb-3 lang-set-permissions">‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-pos" class="rounded"> <span class="lang-pos">POS ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-product-list" class="rounded"> <span class="lang-product-list">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-due-collection" class="rounded"> <span class="lang-due-collection">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-return" class="rounded"> <span class="lang-return">‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-daily-closing" class="rounded"> <span class="lang-daily-closing">‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-customer-view" class="rounded"> <span class="lang-customer-view">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-product-add" class="rounded"> <span class="lang-product-add">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-product-edit" class="rounded"> <span class="lang-product-edit">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-expense-view" class="rounded"> <span class="lang-expense-view">‡¶ñ‡¶∞‡¶ö ‡¶¶‡ßá‡¶ñ‡¶æ</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('permissionEditModal')" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 transition-all touch-target lang-cancel">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button onclick="saveStaffPermissions()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-all touch-target">
                    <i class="fas fa-save mr-2"></i><span class="lang-save">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Staff Management Modal -->
    <div id="staffManagementModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-2/3 p-4 md:p-6 shadow-xl modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-purple-600 lang-staff-management">üë• ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                <button onclick="closeModal('staffManagementModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Add New Staff -->
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-4 rounded-lg mb-6">
                <h3 class="font-bold mb-3 text-purple-700 lang-add-new-staff">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" id="staff-username" placeholder="‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ" class="border p-2 rounded touch-target">
                    <input type="password" id="staff-password" placeholder="‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="border p-2 rounded touch-target">
                    <input type="text" id="staff-name" placeholder="‡¶∏‡ßç‡¶ü‡¶æ‡¶´‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="border p-2 rounded touch-target">
                    <input type="text" id="staff-phone" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" class="border p-2 rounded touch-target">
                </div>
                
                <div class="mt-4">
                    <h4 class="font-bold text-sm mb-2 lang-set-permissions">‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-pos" checked class="rounded"> <span class="lang-pos">POS ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-product-list" checked class="rounded"> <span class="lang-product-list">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-due-collection" checked class="rounded"> <span class="lang-due-collection">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-return" checked class="rounded"> <span class="lang-return">‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-daily-closing" class="rounded"> <span class="lang-daily-closing">‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-customer-view" class="rounded"> <span class="lang-customer-view">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-product-add" class="rounded"> <span class="lang-product-add">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-product-edit" class="rounded"> <span class="lang-product-edit">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-expense-view" class="rounded"> <span class="lang-expense-view">‡¶ñ‡¶∞‡¶ö ‡¶¶‡ßá‡¶ñ‡¶æ</span>
                        </label>
                    </div>
                </div>
                
                <button onclick="addStaff()" class="mt-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-8 py-2 rounded-lg font-bold hover:from-purple-700 hover:to-indigo-700 transition-all touch-target">
                    <i class="fas fa-user-plus mr-2"></i><span class="lang-create-staff">‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                </button>
            </div>
            
            <!-- Staff List -->
            <h3 class="font-bold mb-3 text-gray-700 lang-staff-list">üìã ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h3>
            <div id="staff-list" class="space-y-3 mb-6 overflow-y-auto max-h-[40vh]"></div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('staffManagementModal')" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 transition-all touch-target lang-close">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Branch Management Modal -->
    <div id="branchManagementModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-2/3 p-4 md:p-6 shadow-xl modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-green-600 lang-branch-management-title">üè¢ ‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                <button onclick="closeModal('branchManagementModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Add New Branch -->
            <div class="bg-green-50 p-4 rounded-lg mb-6">
                <h3 class="font-bold mb-3 text-green-700 lang-add-branch">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" id="branch-name" placeholder="‡¶∂‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ" class="border p-2 rounded touch-target">
                    <input type="text" id="branch-location" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" class="border p-2 rounded touch-target">
                    <input type="text" id="branch-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" class="border p-2 rounded touch-target">
                </div>
                <button onclick="addBranch()" class="mt-4 bg-green-600 text-white px-8 py-2 rounded-lg font-bold hover:bg-green-700 transition-all touch-target">
                    <i class="fas fa-plus-circle mr-2"></i><span class="lang-add-branch-btn">‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                </button>
            </div>
            
            <!-- Branch List -->
            <h3 class="font-bold mb-3 text-gray-700 lang-branch-list">üìã ‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h3>
            <div id="branch-list" class="space-y-3 mb-6 overflow-y-auto max-h-[40vh]"></div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('branchManagementModal')" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 transition-all touch-target lang-close">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Cloud Backup Modal -->
    <div id="backupModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/2 p-4 md:p-6 shadow-xl modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-blue-600 lang-cloud-backup-title">‚òÅÔ∏è ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</h2>
                <button onclick="closeModal('backupModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <!-- Google Drive Backup -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold mb-3 flex items-center">
                        <i class="fab fa-google-drive text-blue-500 mr-2"></i> Google Drive
                    </h3>
                    <button onclick="backupToGoogleDrive()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-all touch-target w-full mb-2">
                        <i class="fas fa-upload mr-2"></i><span class="lang-backup-to-drive">Google Drive ‡¶è ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</span>
                    </button>
                    <button onclick="restoreFromGoogleDrive()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-all touch-target w-full">
                        <i class="fas fa-download mr-2"></i><span class="lang-restore-from-drive">Google Drive ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</span>
                    </button>
                </div>
                
                <!-- Dropbox Backup -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold mb-3 flex items-center">
                        <i class="fab fa-dropbox text-blue-500 mr-2"></i> Dropbox
                    </h3>
                    <button onclick="backupToDropbox()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-all touch-target w-full mb-2">
                        <i class="fas fa-upload mr-2"></i><span class="lang-backup-to-dropbox">Dropbox ‡¶è ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</span>
                    </button>
                    <button onclick="restoreFromDropbox()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-all touch-target w-full">
                        <i class="fas fa-download mr-2"></i><span class="lang-restore-from-dropbox">Dropbox ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</span>
                    </button>
                </div>
                
                <!-- Auto Backup Schedule -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold mb-3 lang-auto-backup">üîÑ ‡¶Ö‡¶ü‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∂‡¶ø‡¶°‡¶ø‡¶â‡¶≤</h3>
                    <select id="backup-schedule" class="w-full border p-2 rounded mb-2">
                        <option value="daily">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶®</option>
                        <option value="weekly">‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá</option>
                        <option value="monthly">‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶Æ‡¶æ‡¶∏‡ßá</option>
                        <option value="yearly">‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶¨‡¶õ‡¶∞‡ßá</option>
                    </select>
                    <button onclick="setAutoBackup()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-all touch-target w-full">
                        <i class="fas fa-clock mr-2"></i><span class="lang-set-schedule">‡¶∂‡¶ø‡¶°‡¶ø‡¶â‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                    </button>
                </div>
                
                <!-- Multi-device Sync -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold mb-3">üì± ‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï</h3>
                    <div class="flex items-center justify-between mb-2">
                        <span>‡¶è‡¶á ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏</span>
                        <span class="text-green-600"><i class="fas fa-check-circle"></i> ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º</span>
                    </div>
                    <div class="flex items-center justify-between mb-2">
                        <span>‡¶Ö‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏</span>
                        <span class="text-gray-500">‡ß¶ ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§</span>
                    </div>
                    <button onclick="syncDevices()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-all touch-target w-full">
                        <i class="fas fa-sync mr-2"></i> ‡¶è‡¶ñ‡¶® ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
                
                <!-- Data Recovery -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold mb-3">üíæ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶ï‡¶≠‡¶æ‡¶∞‡¶ø</h3>
                    <button onclick="showRecoveryPoints()" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition-all touch-target w-full">
                        <i class="fas fa-history mr-2"></i> ‡¶∞‡¶ø‡¶ï‡¶≠‡¶æ‡¶∞‡¶ø ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                    </button>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('backupModal')" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 transition-all touch-target lang-close">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Advanced Inventory Modal -->
    <div id="inventoryModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-2/3 p-4 md:p-6 shadow-xl modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-cyan-600">üìä ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶≠‡¶æ‡¶®‡ßç‡¶∏‡¶° ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø</h2>
                <button onclick="closeModal('inventoryModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Batch/Lot Tracking -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <h3 class="font-bold mb-3">üîñ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö/‡¶≤‡¶ü ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" id="batch-search" placeholder="‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®" class="border p-2 rounded">
                    <button onclick="searchBatch()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
                </div>
                <div id="batch-results" class="mt-3 max-h-40 overflow-y-auto"></div>
            </div>
            
            <!-- Serial Number Tracking -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <h3 class="font-bold mb-3">üî¢ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" id="serial-search" placeholder="‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®" class="border p-2 rounded">
                    <button onclick="searchSerial()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
                </div>
                <div id="serial-results" class="mt-3 max-h-40 overflow-y-auto"></div>
            </div>
            
            <!-- Warehouse Management -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <h3 class="font-bold mb-3">üè≠ ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡¶π‡¶æ‡¶â‡¶∏ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" id="warehouse-name" placeholder="‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡¶π‡¶æ‡¶â‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="border p-2 rounded">
                    <input type="text" id="warehouse-location" placeholder="‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®" class="border p-2 rounded">
                </div>
                <button onclick="addWarehouse()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    <i class="fas fa-plus mr-1"></i> ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡¶π‡¶æ‡¶â‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <div id="warehouse-list" class="mt-3 max-h-40 overflow-y-auto"></div>
            </div>
            
            <!-- Minimum Stock Alert & Auto PO -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-bold mb-3">‚ö†Ô∏è ‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="number" id="min-stock-threshold" placeholder="‡¶•‡ßç‡¶∞‡ßá‡¶∂‡¶π‡ßã‡¶≤‡ßç‡¶° (‡¶Ø‡ßá‡¶Æ‡¶®: 5)" class="border p-2 rounded">
                    <button onclick="setMinStockThreshold()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
                <div id="low-stock-list" class="mt-3 max-h-40 overflow-y-auto"></div>
                <button onclick="generateAutoPO()" class="mt-2 bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 w-full">
                    <i class="fas fa-file-invoice mr-1"></i> ‡¶Ö‡¶ü‡ßã ‡¶™‡¶ø‡¶ì ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('inventoryModal')" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 transition-all touch-target">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Advanced Reports Modal -->
    <div id="advancedReportsModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-3/4 p-4 md:p-6 shadow-xl modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-indigo-600">üìà ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶≠‡¶æ‡¶®‡ßç‡¶∏‡¶° ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2>
                <button onclick="closeModal('advancedReportsModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Report Type Selector -->
            <div class="flex gap-2 mb-4">
                <select id="report-type" class="border p-2 rounded">
                    <option value="daily">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</option>
                    <option value="weekly">‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</option>
                    <option value="monthly">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</option>
                    <option value="yearly">‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</option>
                    <option value="custom">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</option>
                </select>
                <input type="date" id="report-start-date" class="border p-2 rounded">
                <input type="date" id="report-end-date" class="border p-2 rounded">
                <button onclick="generateAdvancedReport()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü</button>
            </div>
            
            <!-- Report Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <div class="chart-container">
                    <h3 class="font-bold mb-2">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶™‡ßç‡¶∞‡¶¨‡¶£‡¶§‡¶æ</h3>
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="font-bold mb-2">‡¶≤‡¶æ‡¶≠/‡¶≤‡¶∏ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£</h3>
                    <canvas id="profitLossAdvancedChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="font-bold mb-2">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="font-bold mb-2">‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</h3>
                    <canvas id="branchChart"></canvas>
                </div>
            </div>
            
            <!-- Report Table -->
            <div class="overflow-x-auto mb-4">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-2 border">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                            <th class="p-2 border">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</th>
                            <th class="p-2 border">‡¶≤‡¶æ‡¶≠</th>
                            <th class="p-2 border">‡¶ñ‡¶∞‡¶ö</th>
                            <th class="p-2 border">‡¶®‡¶ø‡¶ü</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body"></tbody>
                </table>
            </div>
            
            <!-- Export Options -->
            <div class="flex gap-2 justify-end">
                <button onclick="exportReportPDF()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    <i class="fas fa-file-pdf mr-1"></i> PDF
                </button>
                <button onclick="exportReportExcel()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    <i class="fas fa-file-excel mr-1"></i> Excel
                </button>
                <button onclick="printReport()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    <i class="fas fa-print mr-1"></i> ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
                </button>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('advancedReportsModal')" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 transition-all touch-target">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Product Modal with Image Upload -->
    <div id="productModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/3 p-6 shadow-xl modal-content">
            <h2 id="productModalTitle" class="text-xl font-bold mb-4 border-b pb-2 lang-add-product-title">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            <div class="space-y-4">
                <input type="hidden" id="p-index">
                
                <!-- Product Images -->
                <div>
                    <label class="text-sm text-gray-500 mb-1 block lang-product-images">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø</label>
                    <input type="file" id="p-images" accept="image/*" multiple onchange="previewProductImages(event)" class="w-full border p-1 rounded">
                    <div id="product-image-gallery" class="image-gallery mt-2"></div>
                </div>
                
                <div class="flex gap-1">
                    <input type="text" id="p-barcode" placeholder="‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶°" class="flex-1 border p-2 rounded">
                    <button onclick="generateRandomBarcode()" class="bg-gray-200 px-2 rounded text-xs">‡¶Ö‡¶ü‡ßã</button>
                </div>
                <input type="text" id="p-name" placeholder="‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full border p-2 rounded">
                
                <!-- Category -->
                <select id="p-category" class="w-full border p-2 rounded">
                    <option value="">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    <option value="electronics">‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏</option>
                    <option value="clothing">‡¶™‡ßã‡¶∂‡¶æ‡¶ï</option>
                    <option value="food">‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø</option>
                    <option value="other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
                </select>
                
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="p-buy" placeholder="‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="w-full border p-2 rounded">
                    <input type="number" id="p-sell" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="w-full border p-2 rounded">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="p-qty" placeholder="‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" class="w-full border p-2 rounded">
                    <select id="p-unit" class="w-full border p-2 rounded">
                        <option value="Pcs">Pcs (‡¶™‡¶ø‡¶∏)</option>
                        <option value="Kg">Kg (‡¶ï‡ßá‡¶ú‡¶ø)</option>
                        <option value="Ltr">Ltr (‡¶≤‡¶ø‡¶ü‡¶æ‡¶∞)</option>
                        <option value="Pkt">Pkt (‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü)</option>
                        <option value="Gm">Gm (‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ)</option>
                        <option value="Dozen">Dozen (‡¶°‡¶ú‡¶®)</option>
                    </select>
                </div>

                <!-- Batch/Lot Tracking -->
                <div>
                    <label class="text-sm text-gray-500 mb-1 block lang-batch-number">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö/‡¶≤‡¶ü ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
                    <input type="text" id="p-batch" placeholder="‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" class="w-full border p-2 rounded">
                </div>
                
                <!-- Serial Numbers -->
                <div>
                    <label class="text-sm text-gray-500 mb-1 block lang-serial-numbers">‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®)</label>
                    <textarea id="p-serials" placeholder="SN001, SN002, SN003" class="w-full border p-2 rounded serial-input" rows="2"></textarea>
                </div>

                <!-- Warehouse -->
                <div>
                    <label class="text-sm text-gray-500 mb-1 block lang-warehouse">‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡¶π‡¶æ‡¶â‡¶∏</label>
                    <select id="p-warehouse" class="w-full border p-2 rounded">
                        <option value="main">‡¶Æ‡ßÇ‡¶≤ ‡¶ó‡ßã‡¶°‡¶æ‡¶â‡¶®</option>
                    </select>
                </div>

                <!-- Warranty -->
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-sm text-gray-500 mb-1 block">‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü‡¶ø</label>
                        <input type="number" id="p-warranty" placeholder="‡¶∏‡¶Æ‡¶Ø‡¶º‡¶ï‡¶æ‡¶≤" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-sm text-gray-500 mb-1 block">&nbsp;</label>
                        <select id="p-warranty-unit" class="w-full border p-2 rounded">
                            <option value="days">‡¶¶‡¶ø‡¶®</option>
                            <option value="months">‡¶Æ‡¶æ‡¶∏</option>
                            <option value="years">‡¶¨‡¶õ‡¶∞</option>
                        </select>
                    </div>
                </div>

                <div class="text-xs text-gray-500 lang-expiry-date">‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡ßÄ‡¶∞‡ßç‡¶£‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</div>
                <input type="date" id="p-expiry" class="w-full border p-2 rounded">
                
                <!-- Tax Rate -->
                <div>
                    <label class="text-sm text-gray-500 mb-1 block">‡¶ü‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏ ‡¶∞‡ßá‡¶ü (%)</label>
                    <input type="number" id="p-tax" value="0" class="w-full border p-2 rounded">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('productModal')" class="bg-gray-400 text-white px-4 py-2 rounded lang-cancel">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button onclick="addProduct()" class="bg-indigo-600 text-white px-4 py-2 rounded lang-save">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Advanced Return Modal -->
    <div id="returnModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/2 p-6 shadow-xl modal-content">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 text-orange-600">‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® / ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶´‡ßá‡¶∞‡¶§</h2>
            <div class="space-y-4">
                <div class="flex gap-2">
                    <input type="text" id="return-inv-input" placeholder="‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶®‡¶Ç (‡¶Ø‡ßá‡¶Æ‡¶®: INV-001)" class="flex-1 border p-2 rounded">
                    <button onclick="findInvoiceForReturn()" class="bg-orange-600 text-white px-4 py-2 rounded">‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
                </div>
                <div id="return-items-area" class="max-h-80 overflow-y-auto space-y-2"></div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="closeModal('returnModal')" class="bg-gray-400 text-white px-4 py-2 rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- All Other Modals -->
    <div id="bulkBarcodeModal" class="modal"><!-- content from original --></div>
    <div id="supplierModal" class="modal"><!-- content from original --></div>
    <div id="settingsModal" class="modal"><!-- content from original --></div>
    <div id="dueCollectionModal" class="modal"><!-- content from original --></div>
    <div id="stockHistoryModal" class="modal"><!-- content from original --></div>
    <div id="posModal" class="modal"><!-- content from original --></div>
    <div id="invoicePreviewModal" class="modal"><!-- content from original --></div>
    <div id="profitReportModal" class="modal"><!-- content from original --></div>
    <div id="productListModal" class="modal"><!-- content from original --></div>
    <div id="expenseModal" class="modal"><!-- content from original --></div>
    <div id="barcode-print-area" class="hidden"></div>
    <div id="bulk-barcode-print-area" class="hidden"></div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let currentUserRole = null;
        let currentUserOwner = null;
        let currentUserPermissions = {};
        let currentLanguage = 'bn';
        let currentBranch = 'main';
        let isOnline = navigator.onLine;
        
        let users = [];
        let pendingUsers = [];
        let products = [];
        let salesRecords = [];
        let expenses = [];
        let stockHistory = [];
        let customers = {};
        let suppliers = [];
        let branches = [{ id: 'main', name: '‡¶Æ‡ßÇ‡¶≤ ‡¶∂‡¶æ‡¶ñ‡¶æ', location: '', phone: '' }];
        let warehouses = [{ id: 'main', name: '‡¶Æ‡ßÇ‡¶≤ ‡¶ó‡ßã‡¶°‡¶æ‡¶â‡¶®' }];
        let cart = [];
        let backupSchedule = null;
        let offlineQueue = [];
        let recoveryPoints = [];
        
        let totalSales = 0, totalProfit = 0, totalExpense = 0, totalDue = 0, totalStockValue = 0;
        let invoiceCount = 1;
        let minStockThreshold = 5;
        
        let config = { 
            shopName: "‡¶™‡ßç‡¶∞‡ßã ‡¶∂‡¶™", 
            vat: 5, 
            invoiceNote: "‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶§ ‡¶Æ‡¶æ‡¶≤ ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü ‡¶®‡¶æ‡•§", 
            logo: "",
            dailyTarget: 0,
            monthlyTarget: 0,
            yearlyTarget: 0,
            currency: "‡ß≥",
            dateFormat: "dd/mm/yyyy",
            autoBackup: false,
            backupSchedule: "daily",
            taxRates: [{ name: "VAT", rate: 5 }]
        };
        
        let isMobileMenuOpen = false;
        let productImages = [];

        // ==================== LANGUAGE SUPPORT ====================
        const translations = {
            bn: {
                'login': '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                'username': '‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ',
                'password': '‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°',
                'no-account': '‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï?',
                'register': '‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                'only-owner': '‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø',
                'shop-name': '‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ',
                'phone': '‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞',
                'register-complete': '‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                'have-account': '‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá?',
                'login-link': '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                'dashboard': '‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°',
                'add-product': '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°',
                'bulk-barcode': '‡¶¨‡¶æ‡¶≤‡ßç‡¶ï ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶°',
                'supplier': '‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á‡ßü‡¶æ‡¶∞',
                'stock-history': '‡¶∏‡ßç‡¶ü‡¶ï ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø',
                'add-expense': '‡¶ñ‡¶∞‡¶ö ‡¶è‡¶°',
                'profit-report': '‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü',
                'settings': '‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏',
                'staff-management': '‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü',
                'branch-management': '‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü',
                'cloud-backup': '‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™',
                'product-list': '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü',
                'due-collection': '‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü',
                'return': '‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®',
                'open-pos': '‡¶ì‡¶™‡ßá‡¶® POS (F2)',
                'daily-closing': '‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç',
                'user-approval': '‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠‡¶æ‡¶≤',
                'backup': '‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™',
                'logout': '‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü',
                'dark-mode': '‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶Æ‡ßã‡¶°',
                'total-sales': '‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø',
                'total-profit': '‡¶Æ‡ßã‡¶ü ‡¶≤‡¶æ‡¶≠',
                'total-expense': '‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö',
                'net-profit': '‡¶®‡¶ø‡¶ü ‡¶≤‡¶æ‡¶≠',
                'total-due': '‡¶¨‡¶æ‡¶ï‡¶ø',
                'stock-value': '‡¶∏‡ßç‡¶ü‡¶ï ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø',
                'sales-chart': '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶´ (‡¶ó‡¶§ ‡ß≠ ‡¶¶‡¶ø‡¶®)',
                'top-products': '‡¶¨‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡ßá‡¶≤‡¶ø‡¶Ç ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü',
                'profit-loss': '‡¶≤‡¶æ‡¶≠/‡¶≤‡¶∏ ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï ‡¶ó‡ßç‡¶∞‡¶æ‡¶´',
                'monthly-sales': '‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü',
                'stock-alert': '‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü!',
                'expiry-alert': '‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶•‡ßá!',
                'target-alert': '‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü!',
                'recent-sales': '‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø',
                'invoice': '‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏',
                'customer': '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞',
                'amount': '‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£',
                'status': '‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ',
                'seller': '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ',
                'reset-data': '‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ',
                'pos': 'POS ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø',
                'product-list-perm': '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü',
                'due-collection-perm': '‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü',
                'return-perm': '‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®',
                'daily-closing-perm': '‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç',
                'customer-view': '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ',
                'product-add': '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°',
                'product-edit': '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü',
                'expense-view': '‡¶ñ‡¶∞‡¶ö ‡¶¶‡ßá‡¶ñ‡¶æ',
                'close': '‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®',
                'cancel': '‡¶¨‡¶æ‡¶§‡¶ø‡¶≤',
                'save': '‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®',
                'edit': '‡¶è‡¶°‡¶ø‡¶ü',
                'delete': '‡¶°‡¶ø‡¶≤‡¶ø‡¶ü',
                'search': '‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®',
                'print': '‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü',
                'preview': '‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â',
                'product-images': '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø',
                'batch-number': '‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö/‡¶≤‡¶ü ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞',
                'serial-numbers': '‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞',
                'warehouse': '‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡¶π‡¶æ‡¶â‡¶∏',
                'expiry-date': '‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡ßÄ‡¶∞‡ßç‡¶£‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ',
                'branch-management-title': '‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü',
                'add-branch': '‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®',
                'branch-name': '‡¶∂‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ',
                'branch-location': '‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ',
                'branch-phone': '‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞',
                'add-branch-btn': '‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®',
                'branch-list': '‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü',
                'transfer-stock': '‡¶∏‡ßç‡¶ü‡¶ï ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞',
                'cloud-backup-title': '‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™',
                'backup-to-drive': 'Google Drive ‡¶è ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™',
                'restore-from-drive': 'Google Drive ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞',
                'backup-to-dropbox': 'Dropbox ‡¶è ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™',
                'restore-from-dropbox': 'Dropbox ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞',
                'auto-backup': '‡¶Ö‡¶ü‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∂‡¶ø‡¶°‡¶ø‡¶â‡¶≤',
                'set-schedule': '‡¶∂‡¶ø‡¶°‡¶ø‡¶â‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®',
                'staff-username': '‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ',
                'staff-name': '‡¶∏‡ßç‡¶ü‡¶æ‡¶´‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ',
                'staff-phone': '‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞',
                'set-permissions': '‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:',
                'edit-permission': '‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶® ‡¶è‡¶°‡¶ø‡¶ü',
                'add-new-staff': '‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®',
                'create-staff': '‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®',
                'staff-list': '‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü',
                'pending-owners': '‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï',
                'fill-all-fields': '‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®',
                'username-min-3': '‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß© ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá',
                'password-min-4': '‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß™ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá',
                'username-exists': '‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§!',
                'pending-exists': '‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠‡¶æ‡¶≤‡ßá‡¶∞ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶õ‡ßá!',
                'reg-success': '‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶´‡¶≤! ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠‡¶æ‡¶≤‡ßá‡¶∞ ‡¶™‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§',
                'login-success': '‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤!',
                'login-failed': '‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!',
                'logout-success': '‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®',
                'welcome': '‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ',
                'permission-denied': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶á ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!',
                'stock-out': '‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡ßá‡¶∑!',
                'stock-exceed': '‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡ßü!',
                'cart-empty': '‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!',
                'sale-complete': '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá!',
                'payment-success': '‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!',
                'return-success': '‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!',
                'supplier-added': '‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á‡ßü‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!',
                'expense-added': '‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!',
                'settings-saved': '‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!',
                'backup-start': '‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá!',
                'data-reset': '‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá',
                'branch-added': '‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!',
                'stock-transferred': '‡¶∏‡ßç‡¶ü‡¶ï ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!',
                'target-reached': '‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡ßü‡ßá‡¶õ‡ßá!',
                'install-pwa': '‡¶π‡ßã‡¶Æ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®',
                'offline-mode': '‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßã‡¶°',
                'online-mode': '‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßã‡¶°',
                'return-reason': '‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£',
                'damaged': '‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡¶∑‡ßç‡¶ü',
                'expired': '‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡ßÄ‡¶∞‡ßç‡¶£',
                'wrong-item': '‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶£‡ßç‡¶Ø',
                'customer-return': '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶´‡ßá‡¶∞‡¶§',
                'warranty-claim': '‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü‡¶ø ‡¶ï‡ßç‡¶≤‡ßá‡¶á‡¶Æ',
                'warranty-period': '‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶ï‡¶æ‡¶≤',
                'warranty-until': '‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü‡¶ø ‡¶∂‡ßá‡¶∑ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ',
                'exchange': '‡¶è‡¶ï‡ßç‡¶∏‡¶ö‡ßá‡¶û‡ßç‡¶ú',
                'refund': '‡¶∞‡¶ø‡¶´‡¶æ‡¶®‡ßç‡¶°'
            },
            en: {
                'login': 'Login',
                'username': 'Username',
                'password': 'Password',
                'no-account': 'Shop Owner?',
                'register': 'Register',
                'only-owner': 'Only for shop owners',
                'shop-name': 'Shop Name',
                'phone': 'Mobile Number',
                'register-complete': 'Complete Registration',
                'have-account': 'Already have an account?',
                'login-link': 'Login',
                'dashboard': 'Dashboard',
                'add-product': 'Add Product',
                'bulk-barcode': 'Bulk Barcode',
                'supplier': 'Supplier',
                'stock-history': 'Stock History',
                'add-expense': 'Add Expense',
                'profit-report': 'Profit Report',
                'settings': 'Settings',
                'staff-management': 'Staff Management',
                'branch-management': 'Branch Management',
                'cloud-backup': 'Cloud Backup',
                'product-list': 'Product List',
                'due-collection': 'Due Collection',
                'return': 'Sales Return',
                'open-pos': 'Open POS (F2)',
                'daily-closing': 'Daily Closing',
                'user-approval': 'User Approval',
                'backup': 'Backup',
                'logout': 'Logout',
                'dark-mode': 'Dark Mode',
                'total-sales': 'Total Sales',
                'total-profit': 'Total Profit',
                'total-expense': 'Total Expense',
                'net-profit': 'Net Profit',
                'total-due': 'Due',
                'stock-value': 'Stock Value',
                'sales-chart': 'Sales Chart (Last 7 Days)',
                'top-products': 'Best Selling Products',
                'profit-loss': 'Profit/Loss Comparison',
                'monthly-sales': 'Monthly Sales Report',
                'stock-alert': 'Stock Alert!',
                'expiry-alert': 'Expiry Alert!',
                'target-alert': 'Target Alert!',
                'recent-sales': 'Recent Sales',
                'invoice': 'Invoice',
                'customer': 'Customer',
                'amount': 'Amount',
                'status': 'Status',
                'seller': 'Seller',
                'reset-data': 'Reset Data',
                'pos': 'POS Sales',
                'product-list-perm': 'Product List',
                'due-collection-perm': 'Due Collection',
                'return-perm': 'Return',
                'daily-closing-perm': 'Daily Closing',
                'customer-view': 'View Customers',
                'product-add': 'Add Product',
                'product-edit': 'Edit Product',
                'expense-view': 'View Expense',
                'close': 'Close',
                'cancel': 'Cancel',
                'save': 'Save',
                'edit': 'Edit',
                'delete': 'Delete',
                'search': 'Search',
                'print': 'Print',
                'preview': 'Preview',
                'product-images': 'Product Images',
                'batch-number': 'Batch/Lot Number',
                'serial-numbers': 'Serial Numbers',
                'warehouse': 'Warehouse',
                'expiry-date': 'Expiry Date',
                'branch-management-title': 'Branch Management',
                'add-branch': 'Add New Branch',
                'branch-name': 'Branch Name',
                'branch-location': 'Location',
                'branch-phone': 'Phone Number',
                'add-branch-btn': 'Add Branch',
                'branch-list': 'Branch List',
                'transfer-stock': 'Transfer Stock',
                'cloud-backup-title': 'Cloud Backup',
                'backup-to-drive': 'Backup to Google Drive',
                'restore-from-drive': 'Restore from Google Drive',
                'backup-to-dropbox': 'Backup to Dropbox',
                'restore-from-dropbox': 'Restore from Dropbox',
                'auto-backup': 'Auto Backup Schedule',
                'set-schedule': 'Set Schedule',
                'staff-username': 'Staff Username',
                'staff-name': 'Staff Name',
                'staff-phone': 'Mobile Number',
                'set-permissions': 'Set Permissions:',
                'edit-permission': 'Edit Staff Permission',
                'add-new-staff': 'Add New Staff',
                'create-staff': 'Create Staff',
                'staff-list': 'Staff List',
                'pending-owners': 'Pending Shop Owners',
                'fill-all-fields': 'Please fill all fields',
                'username-min-3': 'Username must be at least 3 characters',
                'password-min-4': 'Password must be at least 4 characters',
                'username-exists': 'This username already exists!',
                'pending-exists': 'This username is pending approval!',
                'reg-success': 'Registration successful! You can login after admin approval.',
                'login-success': 'Login successful!',
                'login-failed': 'Invalid username or password!',
                'logout-success': 'Logout completed',
                'welcome': 'Welcome',
                'permission-denied': 'You do not have permission to use this feature!',
                'stock-out': 'Out of stock!',
                'stock-exceed': 'Cannot exceed available stock!',
                'cart-empty': 'Cart is empty!',
                'sale-complete': 'Sale completed successfully!',
                'payment-success': 'Payment received!',
                'return-success': 'Item returned successfully!',
                'supplier-added': 'Supplier added!',
                'expense-added': 'Expense added!',
                'settings-saved': 'Settings saved!',
                'backup-start': 'Backup downloading!',
                'data-reset': 'Data will be reset',
                'branch-added': 'New branch added!',
                'stock-transferred': 'Stock transferred successfully!',
                'target-reached': 'Target achieved!',
                'install-pwa': 'Add to Home Screen',
                'offline-mode': 'Offline Mode',
                'online-mode': 'Online Mode',
                'return-reason': 'Return Reason',
                'damaged': 'Damaged',
                'expired': 'Expired',
                'wrong-item': 'Wrong Item',
                'customer-return': 'Customer Return',
                'warranty-claim': 'Warranty Claim',
                'warranty-period': 'Warranty Period',
                'warranty-until': 'Warranty Until',
                'exchange': 'Exchange',
                'refund': 'Refund'
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            document.body.setAttribute('data-language', lang);
            
            document.querySelectorAll('[class^="lang-"]').forEach(el => {
                const key = el.className.split(' ').find(c => c.startsWith('lang-'))?.replace('lang-', '');
                if (key && translations[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translations[lang][key];
                    } else {
                        el.innerHTML = translations[lang][key];
                    }
                }
            });
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if ((lang === 'bn' && btn.innerText === '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ') || 
                    (lang === 'en' && btn.innerText === 'English')) {
                    btn.classList.add('active');
                }
            });
            
            localStorage.setItem('preferred_language', lang);
        }

        // ==================== PWA SUPPORT ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registered');
                }).catch(err => {
                    console.log('ServiceWorker registration failed');
                });
            });
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showToast(translations[currentLanguage]['install-pwa'], 'info');
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // ==================== ONLINE/OFFLINE DETECTION ====================
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const badge = document.getElementById('offlineBadge');
            if (isOnline) {
                badge.classList.add('hidden');
                syncOfflineData();
            } else {
                badge.classList.remove('hidden');
            }
        }

        // ==================== INITIALIZATION ====================
        function initializeSystem() {
            const storedUsers = localStorage.getItem('all_users');
            if (storedUsers) {
                users = JSON.parse(storedUsers);
            } else {
                users = [{ 
                    username: 'admin', 
                    password: 'admin', 
                    role: 'admin',
                    approved: true,
                    createdAt: new Date().toISOString()
                }];
                localStorage.setItem('all_users', JSON.stringify(users));
            }
            
            const storedPending = localStorage.getItem('pending_owners');
            if (storedPending) {
                pendingUsers = JSON.parse(storedPending);
            } else {
                pendingUsers = [];
                localStorage.setItem('pending_owners', JSON.stringify(pendingUsers));
            }
            
            const storedBranches = localStorage.getItem('branches');
            if (storedBranches) {
                branches = JSON.parse(storedBranches);
            }
            
            const storedWarehouses = localStorage.getItem('warehouses');
            if (storedWarehouses) {
                warehouses = JSON.parse(storedWarehouses);
            }
            
            const savedLayout = localStorage.getItem('layout_preference');
            if (savedLayout === 'desktop' || savedLayout === 'mobile') {
                document.body.setAttribute('data-layout', savedLayout);
            }
        }

        function getUserStorageKey(baseKey) {
            if (!currentUser) return baseKey;
            if (currentUserRole === 'staff' && currentUserOwner) {
                return `${currentUserOwner}_${baseKey}`;
            }
            return `${currentUser}_${baseKey}`;
        }

        // ==================== AUTH FUNCTIONS ====================
        function toggleAuthForms() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('signup-form').classList.toggle('hidden');
        }

        function handleOwnerSignup() {
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-pass').value.trim();
            const shopName = document.getElementById('reg-shop-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            
            if (!username || !password || !shopName || !phone) {
                showToast(translations[currentLanguage]['fill-all-fields'], "error");
                return;
            }

            if (username.length < 3) {
                showToast(translations[currentLanguage]['username-min-3'], "error");
                return;
            }

            if (password.length < 4) {
                showToast(translations[currentLanguage]['password-min-4'], "error");
                return;
            }

            if (users.some(u => u.username === username)) {
                showToast(translations[currentLanguage]['username-exists'], "error");
                return;
            }

            if (pendingUsers.some(u => u.username === username)) {
                showToast(translations[currentLanguage]['pending-exists'], "warning");
                return;
            }

            pendingUsers.push({ 
                username, 
                password,
                shopName,
                phone,
                role: 'owner',
                registeredAt: new Date().toISOString(),
                status: 'pending'
            });
            
            localStorage.setItem('pending_owners', JSON.stringify(pendingUsers));
            showToast(translations[currentLanguage]['reg-success'], "success");
            
            document.getElementById('reg-username').value = '';
            document.getElementById('reg-pass').value = '';
            document.getElementById('reg-shop-name').value = '';
            document.getElementById('reg-phone').value = '';
            toggleAuthForms();
            
            if (currentUser === 'admin') {
                updatePendingBadge();
            }
        }

        function handleLogin() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-pass').value.trim();

            if (!username || !password) {
                showToast(translations[currentLanguage]['fill-all-fields'], "error");
                return;
            }

            if (username === 'admin' && password === 'admin') {
                currentUser = 'admin';
                currentUserRole = 'admin';
                currentUserOwner = null;
                currentUserPermissions = {};
                localStorage.setItem('currentUser', 'admin');
                localStorage.setItem('currentUserRole', 'admin');
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                updateUserDisplay();
                loadUserData();
                showToast(translations[currentLanguage]['login-success'], "success");
                return;
            }

            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                if (!user.approved) {
                    showToast(translations[currentLanguage]['pending-exists'], "warning");
                    return;
                }
                
                currentUser = username;
                currentUserRole = user.role;
                currentUserOwner = user.owner || null;
                currentUserPermissions = user.permissions || {};
                
                localStorage.setItem('currentUser', username);
                localStorage.setItem('currentUserRole', user.role);
                if (user.owner) localStorage.setItem('currentUserOwner', user.owner);
                if (user.permissions) localStorage.setItem('currentUserPermissions', JSON.stringify(user.permissions));
                
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                updateUserDisplay();
                loadUserData();
                applyPermissions();
                showToast(`${translations[currentLanguage]['welcome']} ${user.name || username}!`, "success");
            } else {
                showToast(translations[currentLanguage]['login-failed'], "error");
            }
        }

        function handleLogout() {
            currentUser = null;
            currentUserRole = null;
            currentUserOwner = null;
            currentUserPermissions = {};
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentUserRole');
            localStorage.removeItem('currentUserOwner');
            localStorage.removeItem('currentUserPermissions');
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('auth-username').value = '';
            document.getElementById('auth-pass').value = '';
            closeMobileMenu();
            showToast(translations[currentLanguage]['logout-success'], "info");
        }

        function updateUserDisplay() {
            const displayName = currentUser === 'admin' ? '‡¶è‡¶°‡¶Æ‡¶ø‡¶®' : currentUser;
            const roleText = currentUserRole === 'admin' ? '‡¶è‡¶°‡¶Æ‡¶ø‡¶®' : (currentUserRole === 'owner' ? '‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï' : '‡¶∏‡ßç‡¶ü‡¶æ‡¶´');
            
            document.querySelectorAll('#current-username-header, #current-username-sidebar, #current-username-mobile').forEach(el => {
                if (el) el.innerText = displayName;
            });
            
            document.querySelectorAll('#user-role-badge-header, #user-role-badge-sidebar, #user-role-badge-mobile').forEach(el => {
                if (el) {
                    el.innerText = roleText;
                    el.className = `text-xs ${currentUserRole === 'owner' ? 'owner-badge' : (currentUserRole === 'staff' ? 'staff-badge' : 'bg-purple-600')} px-2 py-1 rounded-full`;
                }
            });
            
            if (currentUserRole === 'owner' || currentUserRole === 'admin') {
                document.body.classList.add('role-owner');
                document.body.classList.remove('role-staff');
            } else {
                document.body.classList.add('role-staff');
                document.body.classList.remove('role-owner');
            }
        }

        function applyPermissions() {
            if (currentUserRole !== 'staff') return;
            
            const menuProductList = document.getElementById('menu-product-list');
            const menuDueCollection = document.getElementById('menu-due-collection');
            const menuReturn = document.getElementById('menu-return');
            const menuPos = document.getElementById('menu-pos');
            const menuDailyClosing = document.getElementById('menu-daily-closing');
            
            if (menuProductList) menuProductList.style.display = currentUserPermissions.productList ? 'block' : 'none';
            if (menuDueCollection) menuDueCollection.style.display = currentUserPermissions.dueCollection ? 'block' : 'none';
            if (menuReturn) menuReturn.style.display = currentUserPermissions.return ? 'block' : 'none';
            if (menuPos) menuPos.style.display = currentUserPermissions.pos ? 'block' : 'none';
            if (menuDailyClosing) menuDailyClosing.style.display = currentUserPermissions.dailyClosing ? 'block' : 'none';
            
            document.querySelectorAll('.owner-only').forEach(el => el.style.display = 'none');
            const resetBtn = document.getElementById('reset-data-btn');
            if (resetBtn) resetBtn.style.display = 'none';
            
            localStorage.setItem('currentUserPermissions', JSON.stringify(currentUserPermissions));
        }

        // ==================== STAFF MANAGEMENT ====================
        function addStaff() {
            if (currentUserRole !== 'owner') {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            
            const username = document.getElementById('staff-username').value.trim();
            const password = document.getElementById('staff-password').value.trim();
            const name = document.getElementById('staff-name').value.trim();
            const phone = document.getElementById('staff-phone').value.trim();
            
            if (!username || !password || !name) {
                showToast(translations[currentLanguage]['fill-all-fields'], "error");
                return;
            }
            
            if (users.some(u => u.username === username)) {
                showToast(translations[currentLanguage]['username-exists'], "error");
                return;
            }
            
            const permissions = {
                pos: document.getElementById('perm-pos').checked,
                productList: document.getElementById('perm-product-list').checked,
                dueCollection: document.getElementById('perm-due-collection').checked,
                return: document.getElementById('perm-return').checked,
                dailyClosing: document.getElementById('perm-daily-closing').checked,
                customerView: document.getElementById('perm-customer-view').checked,
                productAdd: document.getElementById('perm-product-add').checked,
                productEdit: document.getElementById('perm-product-edit').checked,
                expenseView: document.getElementById('perm-expense-view').checked
            };
            
            const staffUser = {
                username,
                password,
                name,
                phone,
                role: 'staff',
                owner: currentUser,
                permissions,
                approved: true,
                createdAt: new Date().toISOString(),
                createdBy: currentUser
            };
            
            users.push(staffUser);
            localStorage.setItem('all_users', JSON.stringify(users));
            
            document.getElementById('staff-username').value = '';
            document.getElementById('staff-password').value = '';
            document.getElementById('staff-name').value = '';
            document.getElementById('staff-phone').value = '';
            
            renderStaffList();
            showToast(`${translations[currentLanguage]['create-staff']} ${name}!`, "success");
        }

        function renderStaffList() {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') return;
            
            const staffList = users.filter(u => u.role === 'staff' && u.owner === currentUser);
            const listDiv = document.getElementById('staff-list');
            if (!listDiv) return;
            
            if (staffList.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-4">‡¶ï‡ßã‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶®‡ßá‡¶á</p>';
            } else {
                listDiv.innerHTML = staffList.map(staff => `
                    <div class="bg-white p-4 rounded-lg border hover:shadow-md transition-all">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="mb-2 md:mb-0">
                                <div class="flex items-center gap-2">
                                    <p class="font-bold text-lg">${staff.name}</p>
                                    <span class="staff-badge text-xs">‡¶∏‡ßç‡¶ü‡¶æ‡¶´</span>
                                </div>
                                <p class="text-sm text-gray-600">@${staff.username}</p>
                                <p class="text-xs text-gray-500">‡¶´‡ßã‡¶®: ${staff.phone || 'N/A'}</p>
                                <p class="text-xs text-gray-500">‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§: ${new Date(staff.createdAt).toLocaleDateString('bn-BD')}</p>
                            </div>
                            <div class="flex gap-2 mt-2 md:mt-0">
                                <button onclick="openPermissionEditModal('${staff.username}')" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-all touch-target">
                                    <i class="fas fa-edit mr-1"></i> ‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶®
                                </button>
                                <button onclick="removeStaff('${staff.username}')" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition-all touch-target">
                                    <i class="fas fa-trash mr-1"></i> ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠
                                </button>
                            </div>
                        </div>
                        <div class="mt-3 flex flex-wrap gap-1">
                            ${Object.entries(staff.permissions || {}).map(([key, value]) => 
                                value ? `<span class="permission-chip active">${getPermissionName(key)}</span>` : ''
                            ).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }

        function getPermissionName(key) {
            const names = {
                pos: 'POS',
                productList: '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü',
                dueCollection: '‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü',
                return: '‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®',
                dailyClosing: '‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç',
                customerView: '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ',
                productAdd: '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°',
                productEdit: '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü',
                expenseView: '‡¶ñ‡¶∞‡¶ö ‡¶¶‡ßá‡¶ñ‡¶æ'
            };
            return names[key] || key;
        }

        function openPermissionEditModal(username) {
            const staff = users.find(u => u.username === username);
            if (!staff) return;
            
            document.getElementById('edit-staff-username').value = staff.username;
            document.getElementById('edit-staff-username-display').value = staff.username;
            document.getElementById('edit-staff-name').value = staff.name || '';
            document.getElementById('edit-staff-phone').value = staff.phone || '';
            
            document.getElementById('edit-perm-pos').checked = staff.permissions?.pos || false;
            document.getElementById('edit-perm-product-list').checked = staff.permissions?.productList || false;
            document.getElementById('edit-perm-due-collection').checked = staff.permissions?.dueCollection || false;
            document.getElementById('edit-perm-return').checked = staff.permissions?.return || false;
            document.getElementById('edit-perm-daily-closing').checked = staff.permissions?.dailyClosing || false;
            document.getElementById('edit-perm-customer-view').checked = staff.permissions?.customerView || false;
            document.getElementById('edit-perm-product-add').checked = staff.permissions?.productAdd || false;
            document.getElementById('edit-perm-product-edit').checked = staff.permissions?.productEdit || false;
            document.getElementById('edit-perm-expense-view').checked = staff.permissions?.expenseView || false;
            
            openModal('permissionEditModal');
        }

        function saveStaffPermissions() {
            const username = document.getElementById('edit-staff-username').value;
            const name = document.getElementById('edit-staff-name').value.trim();
            const phone = document.getElementById('edit-staff-phone').value.trim();
            
            const staffIndex = users.findIndex(u => u.username === username);
            if (staffIndex === -1) return;
            
            const permissions = {
                pos: document.getElementById('edit-perm-pos').checked,
                productList: document.getElementById('edit-perm-product-list').checked,
                dueCollection: document.getElementById('edit-perm-due-collection').checked,
                return: document.getElementById('edit-perm-return').checked,
                dailyClosing: document.getElementById('edit-perm-daily-closing').checked,
                customerView: document.getElementById('edit-perm-customer-view').checked,
                productAdd: document.getElementById('edit-perm-product-add').checked,
                productEdit: document.getElementById('edit-perm-product-edit').checked,
                expenseView: document.getElementById('edit-perm-expense-view').checked
            };
            
            users[staffIndex].name = name;
            users[staffIndex].phone = phone;
            users[staffIndex].permissions = permissions;
            
            localStorage.setItem('all_users', JSON.stringify(users));
            
            closeModal('permissionEditModal');
            renderStaffList();
            
            if (currentUser === username) {
                currentUserPermissions = permissions;
                applyPermissions();
                localStorage.setItem('currentUserPermissions', JSON.stringify(permissions));
            }
            
            showToast(`${username} ‡¶è‡¶∞ ‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!`, "success");
        }

        function removeStaff(username) {
            if (!confirm(`${username} ‡¶ï‡ßá ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶¨‡ßá‡¶®?`)) return;
            
            const index = users.findIndex(u => u.username === username);
            if (index !== -1) {
                users.splice(index, 1);
                localStorage.setItem('all_users', JSON.stringify(users));
                renderStaffList();
                showToast(`${username} ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, "success");
            }
        }

        // ==================== ADMIN FUNCTIONS ====================
        function updatePendingBadge() {
            if (currentUserRole !== 'admin') return;
            const pendingCount = pendingUsers.length;
            const badge = document.getElementById('pending-badge');
            
            if (pendingCount > 0) {
                if (badge) {
                    badge.classList.remove('hidden');
                    badge.innerText = `${pendingCount} new`;
                }
            } else {
                if (badge) badge.classList.add('hidden');
            }
        }

        function openAdminApprovalModal() {
            if (currentUserRole !== 'admin') {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            
            const listDiv = document.getElementById('pending-users-list');
            
            if (pendingUsers.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">‚úÖ ‡¶ï‡ßã‡¶® ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶®‡ßá‡¶á</p>';
            } else {
                listDiv.innerHTML = pendingUsers.map((user, index) => `
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between border-b pb-3 hover:bg-gray-50 p-3 rounded">
                        <div class="flex-1 mb-2 md:mb-0">
                            <p class="font-bold text-lg">${user.username}</p>
                            <p class="text-sm">‡¶¶‡ßã‡¶ï‡¶æ‡¶®: ${user.shopName}</p>
                            <p class="text-xs">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${user.phone}</p>
                            <p class="text-xs text-gray-500">
                                <i class="far fa-clock"></i> ‡¶∞‡ßá‡¶ú‡¶ø: ${new Date(user.registeredAt).toLocaleString('bn-BD')}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="approveOwner(${index})" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-all touch-target">
                                <i class="fas fa-check"></i> ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠
                            </button>
                            <button onclick="rejectOwner(${index})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm transition-all touch-target">
                                <i class="fas fa-times"></i> ‡¶∞‡¶ø‡¶ú‡ßá‡¶ï‡ßç‡¶ü
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            openModal('adminApprovalModal');
        }

        function approveOwner(index) {
            if (!confirm(`${pendingUsers[index].username} ‡¶ï‡ßá ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`)) return;
            
            const user = pendingUsers[index];
            
            users.push({ 
                username: user.username, 
                password: user.password,
                shopName: user.shopName,
                phone: user.phone,
                role: 'owner',
                approved: true,
                approvedAt: new Date().toISOString(),
                approvedBy: currentUser
            });
            
            pendingUsers.splice(index, 1);
            
            localStorage.setItem('all_users', JSON.stringify(users));
            localStorage.setItem('pending_owners', JSON.stringify(pendingUsers));
            
            const emptyData = [];
            localStorage.setItem(`${user.username}_shop_products`, JSON.stringify(emptyData));
            localStorage.setItem(`${user.username}_shop_sales`, JSON.stringify(emptyData));
            localStorage.setItem(`${user.username}_shop_expense_list`, JSON.stringify(emptyData));
            
            updatePendingBadge();
            openAdminApprovalModal();
            showToast(`${user.username} ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`, "success");
        }

        function rejectOwner(index) {
            if (!confirm(`${pendingUsers[index].username} ‡¶ï‡ßá ‡¶∞‡¶ø‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`)) return;
            pendingUsers.splice(index, 1);
            localStorage.setItem('pending_owners', JSON.stringify(pendingUsers));
            updatePendingBadge();
            openAdminApprovalModal();
            showToast(`‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, "info");
        }

        // ==================== UI FUNCTIONS ====================
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            isMobileMenuOpen = !isMobileMenuOpen;
            
            if (isMobileMenuOpen) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('mobile-menu-active');
                document.body.style.overflow = 'hidden';
            } else {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('mobile-menu-active');
                document.body.style.overflow = '';
            }
        }

        function closeMobileMenu() {
            if (window.innerWidth < 768 && isMobileMenuOpen) {
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('mobile-menu-active');
                isMobileMenuOpen = false;
                document.body.style.overflow = '';
            }
        }

        window.addEventListener('resize', function() {
            if (window.innerWidth >= 768) {
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('sidebar').classList.remove('mobile-menu-active');
                isMobileMenuOpen = false;
                document.body.style.overflow = '';
            }
        });

        function openModal(id) { 
            if(id === 'productModal' && !document.getElementById('p-index').value) {
                document.getElementById('productModalTitle').innerText = translations[currentLanguage]['add-product'];
            }
            
            if (currentUserRole === 'staff') {
                if (id === 'productModal' && !currentUserPermissions.productAdd) {
                    showToast(translations[currentLanguage]['permission-denied'], "error");
                    return;
                }
                if (id === 'expenseModal' && !currentUserPermissions.expenseView) {
                    showToast(translations[currentLanguage]['permission-denied'], "error");
                    return;
                }
                if (id === 'profitReportModal' && !currentUserPermissions.dailyClosing) {
                    showToast(translations[currentLanguage]['permission-denied'], "error");
                    return;
                }
            }
            
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = 'flex';
                
                if(id === 'productListModal') renderFullProductList(); 
                if(id === 'dueCollectionModal') searchDueRecords();
                if(id === 'bulkBarcodeModal') prepareBulkBarcodeSelect();
                if(id === 'branchManagementModal') renderBranchList();
                if(id === 'inventoryModal') renderInventoryData();
                
                if(id === 'posModal') {
                    document.getElementById('vat-rate-label').innerText = config.vat;
                    const barcodeInput = document.getElementById('barcode-input');
                    if(barcodeInput) barcodeInput.focus();
                    renderCustomerDatalist();
                }
                
                if(id === 'staffManagementModal') {
                    renderStaffList();
                }
            }
        }

        function closeModal(id) { 
            const modal = document.getElementById(id);
            if (modal) {
                if(id === 'productModal') {
                    document.getElementById('p-index').value = "";
                    document.getElementById('p-barcode').value = "";
                    document.getElementById('p-name').value = "";
                    document.getElementById('p-buy').value = "";
                    document.getElementById('p-sell').value = "";
                    document.getElementById('p-qty').value = "";
                    document.getElementById('p-expiry').value = "";
                    document.getElementById('p-unit').value = "Pcs";
                    productImages = [];
                    document.getElementById('product-image-gallery').innerHTML = '';
                }
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // ==================== TOAST NOTIFICATION ====================
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle')} text-${type === 'success' ? 'green' : (type === 'error' ? 'red' : 'blue')}-500"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ==================== DATA LOAD/SAVE ====================
        function loadUserData() {
            const storedProducts = localStorage.getItem(getUserStorageKey('shop_products'));
            const storedSales = localStorage.getItem(getUserStorageKey('shop_sales'));
            const storedExpense = localStorage.getItem(getUserStorageKey('shop_expense_list'));
            const storedStockHistory = localStorage.getItem(getUserStorageKey('shop_stock_history'));
            const storedCustomers = localStorage.getItem(getUserStorageKey('shop_customers'));
            const storedSuppliers = localStorage.getItem(getUserStorageKey('shop_suppliers'));
            const storedConfig = localStorage.getItem(getUserStorageKey('shop_config'));
            const storedInvoiceCount = localStorage.getItem(getUserStorageKey('shop_invoice_count'));

            if (storedProducts) products = JSON.parse(storedProducts);
            else products = [];
            
            if (storedSales) salesRecords = JSON.parse(storedSales);
            else salesRecords = [];
            
            if (storedExpense) expenses = JSON.parse(storedExpense);
            else expenses = [];
            
            if (storedStockHistory) stockHistory = JSON.parse(storedStockHistory);
            else stockHistory = [];
            
            if (storedCustomers) customers = JSON.parse(storedCustomers);
            else customers = {};
            
            if (storedSuppliers) suppliers = JSON.parse(storedSuppliers);
            else suppliers = [];
            
            if (storedConfig) config = JSON.parse(storedConfig);
            else config = { shopName: "‡¶™‡ßç‡¶∞‡ßã ‡¶∂‡¶™", vat: 5, invoiceNote: "‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶§ ‡¶Æ‡¶æ‡¶≤ ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü ‡¶®‡¶æ‡•§", logo: "" };
            
            if (storedInvoiceCount) invoiceCount = parseInt(storedInvoiceCount);
            else invoiceCount = 1;

            applyConfig();
            calculateDashboardStats();
            renderPOSProducts();
            renderRecentSales();
            initCharts();
            renderStockHistory();
            renderSupplierList();
            
            if (currentUserRole === 'admin') {
                updatePendingBadge();
            }
            
            if (currentUserRole === 'owner') {
                renderStaffList();
            }
            
            // Update branch selector
            const branchSelect = document.getElementById('branchSelect');
            if (branchSelect && branches.length > 1) {
                document.getElementById('branchSelector').classList.remove('hidden');
                branchSelect.innerHTML = branches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            }
        }

        function saveToStorage() {
            if (!currentUser) return;
            localStorage.setItem(getUserStorageKey('shop_products'), JSON.stringify(products));
            localStorage.setItem(getUserStorageKey('shop_sales'), JSON.stringify(salesRecords));
            localStorage.setItem(getUserStorageKey('shop_expense_list'), JSON.stringify(expenses));
            localStorage.setItem(getUserStorageKey('shop_invoice_count'), invoiceCount.toString());
            localStorage.setItem(getUserStorageKey('shop_customers'), JSON.stringify(customers));
            localStorage.setItem(getUserStorageKey('shop_suppliers'), JSON.stringify(suppliers));
            localStorage.setItem(getUserStorageKey('shop_stock_history'), JSON.stringify(stockHistory));
            localStorage.setItem(getUserStorageKey('shop_config'), JSON.stringify(config));
        }

        // ==================== PRODUCT FUNCTIONS ====================
        function addProduct() {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
                if (!currentUserPermissions.productAdd) {
                    showToast(translations[currentLanguage]['permission-denied'], "error");
                    return;
                }
            }
            
            let index = document.getElementById('p-index').value;
            let barcode = document.getElementById('p-barcode').value;
            let name = document.getElementById('p-name').value;
            let buy = parseFloat(document.getElementById('p-buy').value) || 0;
            let sell = parseFloat(document.getElementById('p-sell').value) || 0;
            let qty = parseFloat(document.getElementById('p-qty').value) || 0;
            let unit = document.getElementById('p-unit').value;
            let expiry = document.getElementById('p-expiry').value;
            let category = document.getElementById('p-category').value;
            let batch = document.getElementById('p-batch').value;
            let serials = document.getElementById('p-serials').value;
            let warehouse = document.getElementById('p-warehouse').value;
            let warranty = document.getElementById('p-warranty').value;
            let warrantyUnit = document.getElementById('p-warranty-unit').value;
            let tax = parseFloat(document.getElementById('p-tax').value) || 0;
            
            if(!name) {
                showToast(translations[currentLanguage]['fill-all-fields'], "error");
                return;
            }

            let productData = { 
                barcode, name, buy, sell, qty, unit, expiry, category, batch, 
                serials, warehouse, warranty, warrantyUnit, tax, images: productImages 
            };

            if(index !== "") {
                products[index] = productData;
                logStock(name, '‡¶è‡¶°‡¶ú‡¶æ‡¶∏‡ßç‡¶ü/‡¶Ü‡¶™‡¶°‡ßá‡¶ü', qty, unit);
                showToast(translations[currentLanguage]['product-edit'] + " " + translations[currentLanguage]['success'], "success");
            } else {
                products.push(productData);
                logStock(name, '‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®', qty, unit);
                showToast(translations[currentLanguage]['product-add'] + " " + translations[currentLanguage]['success'], "success");
            }
            
            saveToStorage();
            calculateDashboardStats();
            renderPOSProducts();
            closeModal('productModal');
        }

        function editProduct(index) {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
                if (!currentUserPermissions.productEdit) {
                    showToast(translations[currentLanguage]['permission-denied'], "error");
                    return;
                }
            }
            let p = products[index];
            document.getElementById('p-index').value = index;
            document.getElementById('p-barcode').value = p.barcode || "";
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-buy').value = p.buy;
            document.getElementById('p-sell').value = p.sell;
            document.getElementById('p-qty').value = p.qty;
            document.getElementById('p-unit').value = p.unit || "Pcs";
            document.getElementById('p-expiry').value = p.expiry || "";
            document.getElementById('p-category').value = p.category || "";
            document.getElementById('p-batch').value = p.batch || "";
            document.getElementById('p-serials').value = p.serials || "";
            document.getElementById('p-warehouse').value = p.warehouse || "main";
            document.getElementById('p-warranty').value = p.warranty || "";
            document.getElementById('p-warranty-unit').value = p.warrantyUnit || "days";
            document.getElementById('p-tax').value = p.tax || 0;
            
            if (p.images) {
                productImages = p.images;
                renderProductImages();
            }
            
            document.getElementById('productModalTitle').innerText = translations[currentLanguage]['edit'] + " " + translations[currentLanguage]['product'];
            openModal('productModal');
        }

        function deleteProduct(index) {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            if(confirm(translations[currentLanguage]['delete'] + "?")) {
                logStock(products[index].name, '‡¶°‡¶ø‡¶≤‡¶ø‡¶ü', products[index].qty, products[index].unit);
                products.splice(index, 1);
                saveToStorage();
                renderFullProductList();
                calculateDashboardStats();
                renderPOSProducts();
                showToast(translations[currentLanguage]['delete'] + " " + translations[currentLanguage]['success'], "success");
            }
        }

        function renderFullProductList() {
            const list = document.getElementById('full-product-list');
            if(!list) return;
            list.innerHTML = products.map((p, index) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-2 md:p-3">
                        <span class="text-xs text-gray-400">#${p.barcode || 'N/A'}</span><br>
                        <span class="font-medium ${p.qty < 5 ? 'text-red-500 font-bold' : ''}">${p.name}</span>
                    </td>
                    <td class="p-2 md:p-3">‡ß≥ ${p.buy}</td>
                    <td class="p-2 md:p-3">‡ß≥ ${p.sell}</td>
                    <td class="p-2 md:p-3">
                        ${p.qty} ${p.unit || 'Pcs'} ${p.qty < 5 ? '‚ö†Ô∏è' : ''}<br>
                        <span class="text-[10px] text-gray-500">${p.expiry || 'No Expiry'}</span>
                    </td>
                    <td class="p-2 md:p-3 text-center">
                        <button onclick="printBarcode('${p.barcode}','${p.name}',${p.sell})" title="‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü" class="text-gray-500 p-1 hover:text-indigo-600 transition-all touch-target">
                            <i class="fas fa-barcode"></i>
                        </button>
                        <button onclick="editProduct(${index})" class="text-blue-500 p-1 hover:text-blue-700 transition-all touch-target">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteProduct(${index})" class="text-red-500 p-1 hover:text-red-700 transition-all touch-target ${currentUserRole === 'staff' && !currentUserPermissions.productEdit ? 'hidden' : ''}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderPOSProducts() {
            let list = document.getElementById('pos-product-list');
            if(!list) return;
            list.innerHTML = products.map((p, index) => `
                <div onclick="addToCart(${index})" class="product-card ${p.qty <= 0 ? 'out-of-stock' : ''}">
                    <p class="font-bold truncate">${p.name}</p>
                    <p class="text-indigo-600 font-bold">‡ß≥ ${p.sell}</p>
                    <p class="text-xs ${p.qty < 5 ? 'text-red-500 font-bold' : 'text-gray-400'}">
                        ‡¶∏‡ßç‡¶ü‡¶ï: ${p.qty} ${p.unit || ''}
                    </p>
                </div>
            `).join('');
        }

        function generateRandomBarcode() {
            document.getElementById('p-barcode').value = Math.floor(Math.random() * 9000000000000) + 1000000000000;
        }

        function printBarcode(barcode, name, price) {
            const area = document.getElementById('barcode-print-area');
            area.innerHTML = `
                <div style="text-align:center; padding:10px; border:1px solid #000; width:40mm;">
                    <p style="font-size:10px; margin:0;">${config.shopName}</p>
                    <p style="font-size:12px; font-weight:bold; margin:0;">${name}</p>
                    <img src="https://bwipjs-api.metafloor.com/?bcid=code128&text=${barcode}&scale=1&rotate=N" style="width:35mm;">
                    <p style="font-size:12px; margin:0;">Price: ‡ß≥${price}</p>
                </div>
            `;
            window.print();
        }

        function prepareBulkBarcodeSelect() {
            let select = document.getElementById('bulk-p-select');
            if(!select) return;
            select.innerHTML = '<option value="">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>' + 
                products.map((p, idx) => `<option value="${idx}">${p.name} (‡¶∏‡ßç‡¶ü‡¶ï: ${p.qty})</option>`).join('');
        }

        function generateBulkBarcodes() {
            let idx = document.getElementById('bulk-p-select').value;
            let qty = parseInt(document.getElementById('bulk-p-qty').value) || 0;
            if(idx === "" || qty <= 0) {
                showToast(translations[currentLanguage]['fill-all-fields'], "error");
                return;
            }

            let p = products[idx];
            if(!p.barcode) {
                showToast("‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° ‡¶®‡ßá‡¶á!", "error");
                return;
            }

            let area = document.getElementById('bulk-barcode-print-area');
            let content = "";

            for(let i=0; i < qty; i++) {
                content += `
                    <div style="text-align:center; padding:5px; border:1px solid #ccc; width:45mm; height:30mm; margin:2px; display:inline-block; page-break-inside: avoid;">
                        <p style="font-size:8px; margin:0; overflow:hidden; white-space:nowrap;">${config.shopName}</p>
                        <p style="font-size:10px; font-weight:bold; margin:0; overflow:hidden; white-space:nowrap;">${p.name}</p>
                        <img src="https://bwipjs-api.metafloor.com/?bcid=code128&text=${p.barcode}&scale=1&rotate=N" style="width:38mm; height:12mm;">
                        <p style="font-size:10px; margin:0; font-weight:bold;">Price: ‡ß≥ ${p.sell}</p>
                    </div>
                `;
            }
            area.innerHTML = content;
            window.print();
        }

        function filterPOSProducts() {
            let query = document.getElementById('pos-search').value.toLowerCase();
            let items = document.getElementById('pos-product-list').children;
            for(let item of items) {
                let name = item.querySelector('p').innerText.toLowerCase();
                item.style.display = name.includes(query) ? 'block' : 'none';
            }
        }

        // ==================== CART FUNCTIONS ====================
        function addToCart(index) {
            let p = products[index];
            if(p.qty <= 0) {
                showToast(translations[currentLanguage]['stock-out'], "error");
                return;
            }
            
            let existingItem = cart.find(item => item.originalIndex === index);
            if(existingItem) {
                if(existingItem.orderQty < p.qty) {
                    existingItem.orderQty++;
                } else {
                    showToast(translations[currentLanguage]['stock-exceed'], "warning");
                }
            } else {
                cart.push({...p, originalIndex: index, orderQty: 1});
            }
            renderCart();
        }

        function updateCartQty(index, newQty) {
            let qty = parseFloat(newQty) || 0;
            let originalP = products[cart[index].originalIndex];
            
            if(qty > originalP.qty) {
                showToast(translations[currentLanguage]['stock-exceed'], "warning");
                qty = originalP.qty;
            }
            
            if(qty <= 0) {
                cart.splice(index, 1);
            } else {
                cart[index].orderQty = qty;
            }
            renderCart();
        }

        function renderCart() {
            let cartDiv = document.getElementById('cart-items');
            let subtotal = 0;
            let discount = parseFloat(document.getElementById('pos-discount').value) || 0;

            if(cart.length === 0) {
                cartDiv.innerHTML = '<p class="text-gray-400 text-sm italic text-center py-5">‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶®‡ßá‡¶á</p>';
                document.getElementById('cart-subtotal').innerText = '‡ß≥ ‡ß¶';
                document.getElementById('cart-vat').innerText = '‡ß≥ ‡ß¶';
                document.getElementById('cart-total').innerText = '‡ß≥ ‡ß¶';
                document.getElementById('cart-count').innerText = '0 ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ';
                return;
            }
            
            cartDiv.innerHTML = cart.map((item, index) => {
                let lineTotal = item.sell * item.orderQty;
                subtotal += lineTotal;
                return `
                <div class="cart-item flex items-center justify-between text-xs bg-white p-2 border-b gap-2">
                    <div class="flex-1">
                        <p class="font-bold">${item.name}</p>
                        <p class="text-gray-500">‡ß≥ ${item.sell} / ${item.unit || 'Pcs'}</p>
                    </div>
                    <div class="flex items-center gap-1">
                        <span>√ó</span>
                        <input type="number" value="${item.orderQty}" onchange="updateCartQty(${index}, this.value)" class="w-12 border rounded text-center p-1 text-sm">
                        <span class="text-[10px] text-gray-400">${item.unit || ''}</span>
                    </div>
                    <span class="font-bold w-16 text-right">‡ß≥ ${lineTotal}</span>
                </div>`;
            }).join('');
            
            let taxAmount = 0;
            if (config.taxRates) {
                config.taxRates.forEach(rate => {
                    taxAmount += (subtotal * rate.rate) / 100;
                });
            } else {
                taxAmount = (subtotal * config.vat) / 100;
            }
            
            let finalTotal = (subtotal + taxAmount) - discount;

            document.getElementById('cart-subtotal').innerText = '‡ß≥ ' + subtotal.toLocaleString();
            document.getElementById('cart-vat').innerText = '‡ß≥ ' + taxAmount.toLocaleString();
            document.getElementById('cart-total').innerText = '‡ß≥ ' + finalTotal.toLocaleString();
            document.getElementById('cart-count').innerText = cart.length + ' ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ';
        }

        function handleBarcode(e) {
            if(e.key === 'Enter') {
                let code = e.target.value.trim();
                let index = products.findIndex(p => p.barcode === code);
                if(index !== -1) {
                    addToCart(index);
                    e.target.value = "";
                } else {
                    showToast(translations[currentLanguage]['product-not-found'], "error");
                    e.target.value = "";
                }
            }
        }

        // ==================== CHECKOUT ====================
        function checkout() {
            if (currentUserRole === 'staff' && !currentUserPermissions.pos) {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            
            if(cart.length === 0) {
                showToast(translations[currentLanguage]['cart-empty'], "error");
                return;
            }
            
            let subtotal = 0, costPriceTotal = 0;
            let customer = document.getElementById('pos-customer').value || "‡¶®‡¶ó‡¶¶ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞";
            let customerPhone = document.getElementById('pos-customer-phone').value || "N/A";
            let discount = parseFloat(document.getElementById('pos-discount').value) || 0;
            let paymentMethod = document.getElementById('pos-payment-method').value;
            let paid = parseFloat(document.getElementById('pos-paid').value) || 0;
            
            let printRows = "";
            let a4Rows = "";
            let currentCartCopy = JSON.parse(JSON.stringify(cart));

            cart.forEach(item => {
                let lineTotal = item.sell * item.orderQty;
                subtotal += lineTotal;
                costPriceTotal += (item.buy * item.orderQty);
                products[item.originalIndex].qty -= item.orderQty;
                logStock(item.name, '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø (‡¶Ü‡¶â‡¶ü)', item.orderQty, item.unit);
                printRows += `<div class="flex justify-between text-xs"><span>${item.name} (x${item.orderQty} ${item.unit || ''})</span><span>‡ß≥ ${lineTotal}</span></div>`;
                a4Rows += `<tr><td>${item.name}</td><td>${item.orderQty} ${item.unit || ''}</td><td>${item.sell}</td><td>${lineTotal}</td></tr>`;
            });

            let taxAmount = 0;
            if (config.taxRates) {
                config.taxRates.forEach(rate => {
                    taxAmount += (subtotal * rate.rate) / 100;
                });
            } else {
                taxAmount = (subtotal * config.vat) / 100;
            }
            
            let finalSubtotal = (subtotal + taxAmount) - discount;
            let profit = (subtotal - costPriceTotal) - discount;
            let due = finalSubtotal - paid;
            
            let earnedPoints = Math.floor(finalSubtotal / 100);
            if(customerPhone !== "N/A") {
                if(!customers[customerPhone]) customers[customerPhone] = { name: customer, points: 0, purchases: [] };
                customers[customerPhone].points += earnedPoints;
                customers[customerPhone].purchases.push({
                    date: new Date().toISOString(),
                    amount: finalSubtotal,
                    inv: `INV-00${invoiceCount}`
                });
            }

            let record = { 
                inv: `INV-00${invoiceCount}`, 
                customer, 
                phone: customerPhone, 
                subtotal: subtotal,
                tax: taxAmount,
                discount: discount,
                amount: finalSubtotal, 
                profit: profit, 
                due, 
                status: due > 0 ? 'Due' : 'Paid',
                method: paymentMethod,
                date: new Date().toISOString(),
                cartItems: currentCartCopy,
                seller: currentUser,
                sellerRole: currentUserRole,
                branch: currentBranch
            };
            
            if (!isOnline) {
                addToOfflineQueue('sale', record);
                showToast("‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá", "success");
            } else {
                salesRecords.push(record);
                invoiceCount++;
                saveToStorage();
            }
            
            // Generate invoice
            document.querySelectorAll('.invoice-date-print').forEach(el => el.innerText = new Date().toLocaleDateString('bn-BD'));
            document.querySelectorAll('.invoice-qr').forEach(el => el.src = generateQR(record.inv));
            document.querySelectorAll('.invoice-note').forEach(el => el.innerText = config.invoiceNote);

            document.getElementById('print-content').innerHTML = `
                <div class="text-xs mb-2">
                    <p>‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏: ${record.inv}</p>
                    <p>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞: ${customer} (${customerPhone})</p>
                    <p>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü: ${paymentMethod}</p>
                    <p>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ: ${currentUser}</p>
                    <p>‡¶∂‡¶æ‡¶ñ‡¶æ: ${branches.find(b => b.id === currentBranch)?.name || '‡¶Æ‡ßÇ‡¶≤ ‡¶∂‡¶æ‡¶ñ‡¶æ'}</p>
                </div>
                <hr class="border-dotted my-1">
                ${printRows}
                <hr class="border-dotted my-1">
                <div class="flex justify-between text-xs"><span>‡¶∏‡¶æ‡¶¨-‡¶ü‡ßã‡¶ü‡¶æ‡¶≤:</span><span>‡ß≥ ${subtotal}</span></div>
                <div class="flex justify-between text-xs"><span>‡¶ü‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏:</span><span>‡ß≥ ${taxAmount}</span></div>
                <div class="flex justify-between text-xs"><span>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü:</span><span>- ‡ß≥ ${discount}</span></div>
                <div class="font-bold flex justify-between border-t border-dotted mt-1 pt-1"><span>‡¶Æ‡ßã‡¶ü:</span><span>‡ß≥ ${finalSubtotal}</span></div>
                <div class="flex justify-between text-[10px]"><span>‡¶™‡ßá‡¶á‡¶°:</span><span>‡ß≥ ${paid}</span></div>
                <div class="flex justify-between text-[10px] text-red-600 font-bold"><span>‡¶¨‡¶æ‡¶ï‡¶ø:</span><span>‡ß≥ ${due}</span></div>
            `;

            document.getElementById('a4-inv-no').innerText = record.inv;
            document.getElementById('a4-cust-name').innerText = "‡¶®‡¶æ‡¶Æ: " + customer;
            document.getElementById('a4-cust-phone').innerText = "‡¶´‡ßã‡¶®: " + customerPhone;
            document.getElementById('a4-table-body').innerHTML = a4Rows;
            document.getElementById('a4-subtotal').innerText = "‡ß≥ " + subtotal;
            document.getElementById('a4-vat').innerText = "‡ß≥ " + taxAmount;
            document.getElementById('a4-discount').innerText = "‡ß≥ " + discount;
            document.getElementById('a4-total').innerText = "‡ß≥ " + finalSubtotal;
            
            document.getElementById('pos-discount').value = "";
            document.getElementById('pos-paid').value = "";
            document.getElementById('pos-customer').value = "";
            document.getElementById('pos-customer-phone').value = "";

            cart = []; 
            renderCart(); 
            renderPOSProducts(); 
            renderRecentSales(); 
            calculateDashboardStats(); 
            closeModal('posModal');
            toggleInvoiceType('thermal');
            openModal('invoicePreviewModal');
            showToast(translations[currentLanguage]['sale-complete'], "success");
            
            checkDailyTarget();
        }

        // ==================== SALES & REPORTS ====================
        function renderRecentSales() {
            const body = document.getElementById('recent-sales-body');
            if(!body) return;
            body.innerHTML = salesRecords.slice().reverse().slice(0, 10).map(s => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-2 px-1 text-xs md:text-sm">${s.inv}</td>
                    <td class="py-2 text-xs md:text-sm">${s.customer}<br><span class="text-[10px] text-gray-400">${s.phone}</span></td>
                    <td class="py-2 font-bold text-xs md:text-sm">‡ß≥ ${s.amount}</td>
                    <td class="py-2"><span class="${s.status === 'Returned' ? 'bg-red-100 text-red-700' : (s.due > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700')} px-2 py-1 rounded-full text-[10px]">${s.status}</span></td>
                    <td class="py-2 text-[10px] md:text-xs">${s.seller || 'N/A'}</td>
                </tr>
            `).join('');
        }

        function calculateDashboardStats() {
            totalSales = 0; totalProfit = 0; totalDue = 0; totalStockValue = 0; totalExpense = 0;
            
            salesRecords.forEach(s => {
                totalSales += s.amount;
                totalProfit += s.profit;
                totalDue += s.due;
            });

            expenses.forEach(e => totalExpense += e.amount);
            
            let lowStockItems = [];
            let expiryItems = [];
            const today = new Date();
            const thirtyDaysLater = new Date();
            thirtyDaysLater.setDate(today.getDate() + 30);

            products.forEach(p => {
                totalStockValue += (p.buy * p.qty);
                if(p.qty < minStockThreshold) lowStockItems.push(`${p.name} (‡¶∏‡ßç‡¶ü‡¶ï: ${p.qty} ${p.unit || ''})`);
                
                if(p.expiry) {
                    let expDate = new Date(p.expiry);
                    if(expDate <= thirtyDaysLater) expiryItems.push(`${p.name} (‡¶Æ‡ßá‡ßü‡¶æ‡¶¶: ${p.expiry})`);
                }
            });

            const alertDiv = document.getElementById('low-stock-alert');
            const itemsDiv = document.getElementById('low-stock-items');
            if(lowStockItems.length > 0) {
                alertDiv.style.display = 'block';
                itemsDiv.innerHTML = lowStockItems.map(i => `<li class="text-xs md:text-sm">${i}</li>`).join('');
            } else { alertDiv.style.display = 'none'; }

            const expAlertDiv = document.getElementById('expiry-alert');
            const expItemsDiv = document.getElementById('expiry-items');
            if(expiryItems.length > 0) {
                expAlertDiv.style.display = 'block';
                expItemsDiv.innerHTML = expiryItems.map(i => `<li class="text-xs md:text-sm">${i}</li>`).join('');
            } else { expAlertDiv.style.display = 'none'; }

            updateDashboard();
        }

        function updateDashboard() {
            document.getElementById('stat-sales').innerText = '‡ß≥ ' + totalSales.toLocaleString();
            document.getElementById('stat-profit').innerText = '‡ß≥ ' + totalProfit.toLocaleString();
            document.getElementById('stat-expense').innerText = '‡ß≥ ' + totalExpense.toLocaleString();
            document.getElementById('stat-net-profit').innerText = '‡ß≥ ' + (totalProfit - totalExpense).toLocaleString();
            document.getElementById('stat-due').innerText = '‡ß≥ ' + totalDue.toLocaleString();
            document.getElementById('stat-stock').innerText = '‡ß≥ ' + totalStockValue.toLocaleString();
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('bn-BD', { day:'numeric', month:'long', year:'numeric' });
        }

        function initCharts() {
            const salesCtx = document.getElementById('salesChart')?.getContext('2d');
            if(salesCtx) {
                new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Today'],
                        datasets: [{
                            label: '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø (‡ß≥)',
                            data: [0, 0, 0, 0, 0, 0, totalSales],
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            const topCtx = document.getElementById('topProductsChart')?.getContext('2d');
            if(topCtx && products.length > 0) {
                new Chart(topCtx, {
                    type: 'doughnut',
                    data: {
                        labels: products.slice(0,5).map(p => p.name),
                        datasets: [{
                            data: products.slice(0,5).map(p => p.qty),
                            backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function generateDetailedReport() {
            if (currentUserRole === 'staff' && !currentUserPermissions.dailyClosing) {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            
            let start = document.getElementById('report-start').value;
            let end = document.getElementById('report-end').value;
            if(!start || !end) {
                showToast("‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®", "error");
                return;
            }

            let startDate = new Date(start);
            let endDate = new Date(end);
            endDate.setHours(23, 59, 59);

            let filteredSales = salesRecords.filter(s => {
                let d = new Date(s.date);
                return d >= startDate && d <= endDate;
            });

            let filteredExpenses = expenses.filter(e => {
                let d = new Date(e.date);
                return d >= startDate && d <= endDate;
            });

            let rangeSales = 0, rangeProfit = 0, rangeExpense = 0;
            filteredSales.forEach(s => { rangeSales += s.amount; rangeProfit += s.profit; });
            filteredExpenses.forEach(e => { rangeExpense += e.amount; });

            document.getElementById('report-result').innerHTML = `
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="p-4 bg-blue-50 rounded">
                        <p class="text-xs">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</p>
                        <h4 class="text-xl font-bold">‡ß≥ ${rangeSales}</h4>
                    </div>
                    <div class="p-4 bg-green-50 rounded">
                        <p class="text-xs">‡¶Æ‡ßã‡¶ü ‡¶ó‡ßç‡¶∞‡¶∏ ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü</p>
                        <h4 class="text-xl font-bold">‡ß≥ ${rangeProfit}</h4>
                    </div>
                    <div class="p-4 bg-red-50 rounded">
                        <p class="text-xs">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</p>
                        <h4 class="text-xl font-bold">‡ß≥ ${rangeExpense}</h4>
                    </div>
                    <div class="p-4 bg-purple-50 rounded">
                        <p class="text-xs">‡¶®‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü</p>
                        <h4 class="text-xl font-bold">‡ß≥ ${rangeProfit - rangeExpense}</h4>
                    </div>
                </div>
            `;
        }

        function downloadPDFReport() {
            if (currentUserRole === 'staff' && !currentUserPermissions.dailyClosing) {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let start = document.getElementById('report-start').value || "Start";
            let end = document.getElementById('report-end').value || "End";
            
            doc.setFontSize(18);
            doc.text(config.shopName, 105, 15, {align: 'center'});
            doc.setFontSize(12);
            doc.text(`Sales Report (${start} to ${end})`, 105, 25, {align: 'center'});

            let startD = new Date(start);
            let endD = new Date(end);
            endD.setHours(23,59,59);

            let filtered = salesRecords.filter(s => {
                let d = new Date(s.date);
                return d >= startD && d <= endD;
            });

            let tableData = filtered.map(s => [
                s.inv, 
                new Date(s.date).toLocaleDateString(), 
                s.customer, 
                s.amount, 
                s.profit, 
                s.status
            ]);

            doc.autoTable({
                startY: 35,
                head: [['Invoice', 'Date', 'Customer', 'Total (TK)', 'Profit (TK)', 'Status']],
                body: tableData,
            });

            let totalS = filtered.reduce((a, b) => a + b.amount, 0);
            let totalP = filtered.reduce((a, b) => a + b.profit, 0);
            
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total Sales: TK ${totalS}`, 14, finalY);
            doc.text(`Total Gross Profit: TK ${totalP}`, 14, finalY + 7);

            doc.save(`Report_${start}_to_${end}.pdf`);
        }

        // ==================== DUE COLLECTION ====================
        function searchDueRecords() {
            if (currentUserRole === 'staff' && !currentUserPermissions.dueCollection) {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            
            let q = document.getElementById('due-search').value.toLowerCase();
            let list = document.getElementById('due-records-list');
            let filtered = salesRecords.filter(s => s.due > 0 && (s.customer.toLowerCase().includes(q) || (s.phone && s.phone.includes(q))));
            
            list.innerHTML = filtered.map((s, idx) => `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-3 border-b hover:bg-gray-50">
                    <div class="mb-2 md:mb-0">
                        <p class="font-bold">${s.customer}</p>
                        <p class="text-xs text-red-500">‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥ ${s.due}</p>
                        <p class="text-xs text-gray-400">${s.inv}</p>
                    </div>
                    <button onclick="payDue('${s.inv}')" class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600 transition-all touch-target">
                        <i class="fas fa-hand-holding-usd mr-1"></i>‡¶Ü‡¶¶‡¶æ‡ßü
                    </button>
                </div>
            `).join('');
        }

        function payDue(invNo) {
            let amount = parseFloat(prompt("‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶ö‡ßç‡¶õ‡ßá‡¶®?"));
            if(!amount || amount <= 0) return;
            
            let record = salesRecords.find(s => s.inv === invNo);
            if(record) {
                if(amount > record.due) {
                    showToast("‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶ö‡ßá‡ßü‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü!", "error");
                    return;
                }
                record.due -= amount;
                if(record.due === 0) record.status = 'Paid';
                saveToStorage();
                calculateDashboardStats();
                searchDueRecords();
                renderRecentSales();
                showToast(translations[currentLanguage]['payment-success'], "success");
            }
        }

        // ==================== RETURN ====================
        function findInvoiceForReturn() {
            if (currentUserRole === 'staff' && !currentUserPermissions.return) {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            
            let invNo = document.getElementById('return-inv-input').value.trim();
            let record = salesRecords.find(s => s.inv === invNo);
            let area = document.getElementById('return-items-area');
            
            if(!record) {
                showToast("‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!", "error");
                return;
            }
            if(!record.cartItems) {
                showToast("‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ ‡¶®‡ßá‡¶á!", "error");
                return;
            }

            area.innerHTML = `
                <div class="p-3 bg-indigo-50 rounded text-xs mb-2">
                    <p><b>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞:</b> ${record.customer} | <b>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</b> ${new Date(record.date).toLocaleDateString()}</p>
                    <p><b>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤:</b> ‡ß≥ ${record.amount} | <b>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü:</b> ${record.method}</p>
                </div>
                <p class="text-[10px] font-bold text-gray-500 uppercase mb-2">‡¶´‡ßá‡¶∞‡¶§‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶∏‡¶Æ‡ßÇ‡¶π:</p>
                ${record.cartItems.map((item, idx) => `
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between bg-white border p-3 rounded shadow-sm mb-2">
                        <div class="flex-1 mb-2 md:mb-0">
                            <p class="font-bold text-sm">${item.name}</p>
                            <p class="text-xs text-gray-500">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶§ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ${item.orderQty} ${item.unit || ''}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="return-reason-${idx}" class="text-xs border rounded p-1">
                                <option value="damaged">${translations[currentLanguage]['damaged']}</option>
                                <option value="expired">${translations[currentLanguage]['expired']}</option>
                                <option value="wrong-item">${translations[currentLanguage]['wrong-item']}</option>
                                <option value="customer-return">${translations[currentLanguage]['customer-return']}</option>
                                <option value="warranty">${translations[currentLanguage]['warranty-claim']}</option>
                            </select>
                            <input type="number" id="return-qty-${idx}" value="0" min="0" max="${item.orderQty}" class="w-16 border rounded p-2 text-center font-bold text-red-600">
                            <button onclick="confirmItemReturn('${invNo}', ${idx})" class="bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600 transition-all touch-target">
                                <i class="fas fa-undo mr-1"></i>${translations[currentLanguage]['return']}
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function confirmItemReturn(invNo, itemIdx) {
            let returnQty = parseFloat(document.getElementById(`return-qty-${itemIdx}`).value) || 0;
            let returnReason = document.getElementById(`return-reason-${itemIdx}`).value;
            
            if(returnQty <= 0) {
                showToast("‡¶ï‡¶§‡¶ü‡ßÅ‡¶ï‡ßÅ ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡¶ø‡¶¨‡ßá‡¶®?", "error");
                return;
            }

            let record = salesRecords.find(s => s.inv === invNo);
            let item = record.cartItems[itemIdx];

            if(returnQty > item.orderQty) {
                showToast("‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶§ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£‡ßá‡¶∞ ‡¶ö‡ßá‡ßü‡ßá ‡¶¨‡ßá‡¶∂‡¶ø!", "error");
                return;
            }

            if(!confirm(`${item.name} ‡¶è‡¶∞ ${returnQty} ${item.unit || ''} ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶ö‡ßç‡¶õ‡ßá‡¶®?`)) return;

            let productInSystem = products.find(p => p.name === item.name);
            if(productInSystem) {
                productInSystem.qty += returnQty;
                logStock(item.name, '‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® (‡¶á‡¶®)', returnQty, item.unit);
            }

            item.orderQty -= returnQty;
            
            let returnAmount = item.sell * returnQty;
            let returnCost = item.buy * returnQty;
            
            record.subtotal -= returnAmount;
            record.profit -= (returnAmount - returnCost);
            record.amount -= returnAmount;

            if (!record.returns) record.returns = [];
            record.returns.push({
                itemName: item.name,
                qty: returnQty,
                reason: returnReason,
                date: new Date().toISOString()
            });

            if(record.cartItems.every(i => i.orderQty === 0)) record.status = 'Returned';

            saveToStorage();
            calculateDashboardStats();
            renderRecentSales();
            renderPOSProducts();
            
            showToast(translations[currentLanguage]['return-success'], "success");
            findInvoiceForReturn();
        }

        // ==================== SUPPLIER ====================
        function addSupplier() {
            let name = document.getElementById('sup-name').value;
            let due = parseFloat(document.getElementById('sup-due').value) || 0;
            if(!name) {
                showToast("‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®", "error");
                return;
            }
            suppliers.push({ name, due });
            saveToStorage();
            renderSupplierList();
            document.getElementById('sup-name').value = '';
            document.getElementById('sup-due').value = '';
            showToast(translations[currentLanguage]['supplier-added'], "success");
        }

        function renderSupplierList() {
            const body = document.getElementById('supplier-list-body');
            if(!body) return;
            body.innerHTML = suppliers.map((s, idx) => `
                <tr class="border-b text-xs hover:bg-gray-50">
                    <td class="p-2">${s.name}</td>
                    <td class="p-2 text-red-600 font-bold">‡ß≥ ${s.due}</td>
                    <td class="p-2">
                        <button onclick="paySupplier(${idx})" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600 transition-all touch-target">
                            <i class="fas fa-money-bill mr-1"></i>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function paySupplier(idx) {
            let amount = parseFloat(prompt("‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®?"));
            if(amount && amount > 0) {
                suppliers[idx].due -= amount;
                saveToStorage();
                renderSupplierList();
                showToast("‚úÖ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!", "success");
            }
        }

        // ==================== EXPENSE ====================
        function addExpense() {
            if (currentUserRole === 'staff' && !currentUserPermissions.expenseView) {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            
            let amount = parseFloat(document.getElementById('exp-amount').value) || 0;
            let title = document.getElementById('exp-title').value;
            let date = document.getElementById('exp-date').value || new Date().toISOString().split('T')[0];
            if(!title || !amount) {
                showToast(translations[currentLanguage]['fill-all-fields'], "error");
                return;
            }
            expenses.push({ title, amount, date });
            saveToStorage();
            calculateDashboardStats(); 
            closeModal('expenseModal'); 
            showToast(translations[currentLanguage]['expense-added'], "success");
        }

        // ==================== STOCK HISTORY ====================
        function logStock(productName, type, qty, unit = '') {
            stockHistory.push({
                date: new Date().toLocaleString('bn-BD'),
                name: productName,
                type: type, 
                qty: qty + (unit ? ' ' + unit : ''),
                rawDate: new Date().toISOString()
            });
            saveToStorage();
        }

        function renderStockHistory() {
            const body = document.getElementById('stock-history-body');
            if(!body) return;
            body.innerHTML = stockHistory.slice().reverse().map(h => `
                <tr class="border-b text-xs hover:bg-gray-50">
                    <td class="p-2">${h.date}</td>
                    <td class="p-2">${h.name}</td>
                    <td class="p-2"><span class="${h.type.includes('‡¶Ü‡¶â‡¶ü') || h.type.includes('‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®') ? 'text-red-500' : 'text-green-500'}">${h.type}</span></td>
                    <td class="p-2">${h.qty}</td>
                </tr>
            `).join('');
        }

        // ==================== CUSTOMER ====================
        function checkCustomerStatus() {
            let name = document.getElementById('pos-customer').value;
            let found = Object.values(customers).find(c => c.name === name);
            if(found) {
                document.getElementById('avail-points').innerText = found.points || 0;
            }
        }

        function renderCustomerDatalist() {
            let dl = document.getElementById('customer-list');
            if(!dl) return;
            dl.innerHTML = Object.keys(customers).map(c => `<option value="${customers[c].name}">`).join('');
        }

        // ==================== DAILY CLOSING ====================
        function dailyClosingReport() {
            if (currentUserRole === 'staff' && !currentUserPermissions.dailyClosing) {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            
            let today = new Date().toISOString().split('T')[0];
            let todaySales = salesRecords.filter(s => s.date.includes(today));
            let todayCash = todaySales.filter(s => s.method === 'Cash').reduce((acc, curr) => acc + curr.amount, 0);
            let todayBkash = todaySales.filter(s => s.method === 'Bkash').reduce((acc, curr) => acc + curr.amount, 0);
            let totalS = todaySales.reduce((acc, curr) => acc + curr.amount, 0);
            let totalE = expenses.filter(e => e.date === today).reduce((acc, curr) => acc + curr.amount, 0);

            alert(`üìä ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü\n\n‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø: ‡ß≥ ${totalS}\n‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ú‡¶Æ‡¶æ: ‡ß≥ ${todayCash}\n‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶ú‡¶Æ‡¶æ: ‡ß≥ ${todayBkash}\n‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö: ‡ß≥ ${totalE}\n‡¶®‡¶ø‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂: ‡ß≥ ${todayCash - totalE}`);
        }

        // ==================== SETTINGS ====================
        function previewLogo(event) {
            const reader = new FileReader();
            reader.onload = function(){
                config.logo = reader.result;
                const preview = document.getElementById('logo-preview-img');
                preview.src = reader.result;
                preview.classList.remove('hidden');
            }
            reader.readAsDataURL(event.target.files[0]);
        }

        function applyConfig() { 
            document.querySelectorAll('.shop-name-display').forEach(el => el.innerText = config.shopName);
            document.getElementById('conf-shop-name').value = config.shopName;
            document.getElementById('conf-vat').value = config.vat;
            document.getElementById('conf-note').value = config.invoiceNote;
            if(config.logo) {
                document.getElementById('logo-preview-img').src = config.logo;
                document.getElementById('logo-preview-img').classList.remove('hidden');
                document.getElementById('thermal-logo').src = config.logo;
                document.getElementById('thermal-logo').classList.remove('hidden');
                document.getElementById('a4-logo').src = config.logo;
                document.getElementById('a4-logo').classList.remove('hidden');
            }
        }

        function saveSettings() {
            config.shopName = document.getElementById('conf-shop-name').value;
            config.vat = parseFloat(document.getElementById('conf-vat').value) || 0;
            config.invoiceNote = document.getElementById('conf-note').value;
            config.dailyTarget = parseFloat(document.getElementById('daily-target')?.value) || 0;
            config.monthlyTarget = parseFloat(document.getElementById('monthly-target')?.value) || 0;
            config.yearlyTarget = parseFloat(document.getElementById('yearly-target')?.value) || 0;
            
            saveToStorage();
            applyConfig();
            closeModal('settingsModal');
            showToast(translations[currentLanguage]['settings-saved'], "success");
        }

        // ==================== INVOICE ====================
        function toggleInvoiceType(type) {
            const thermal = document.getElementById('print-section');
            const a4 = document.getElementById('a4-print-section');
            const btnT = document.getElementById('btn-thermal');
            const btnA = document.getElementById('btn-a4');

            if(type === 'a4') {
                thermal.classList.add('hidden');
                a4.classList.remove('hidden');
                btnA.className = "bg-indigo-600 text-white px-3 py-1 rounded text-xs";
                btnT.className = "bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs";
            } else {
                thermal.classList.remove('hidden');
                a4.classList.add('hidden');
                btnT.className = "bg-indigo-600 text-white px-3 py-1 rounded text-xs";
                btnA.className = "bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs";
            }
        }

        function generateQR(text) {
            return `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(text)}`;
        }

        function sendWhatsApp() {
            let phone = document.getElementById('pos-customer-phone').value;
            if(phone === "N/A" || !phone) {
                phone = prompt("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶® (Ex: 88017...):");
            }
            if(!phone) return;
            let invoiceText = document.getElementById('print-content').innerText;
            let msg = encodeURIComponent("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Æ‡ßá‡¶Æ‡ßã:\n" + invoiceText + "\n‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶!");
            window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
        }

        // ==================== EXPORT ====================
        function exportData() {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            
            let data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({
                products, 
                salesRecords, 
                expenses, 
                stockHistory, 
                customers, 
                config, 
                suppliers,
                branches,
                warehouses
            }));
            let link = document.createElement('a');
            link.setAttribute("href", data);
            link.setAttribute("download", `backup_${currentUser}_${new Date().toISOString().split('T')[0]}.json`);
            link.click();
            showToast(translations[currentLanguage]['backup-start'], "success");
        }

        function clearAllData() {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
                showToast(translations[currentLanguage]['permission-denied'], "error");
                return;
            }
            if(confirm(translations[currentLanguage]['data-reset'] + "?")) { 
                localStorage.clear(); 
                location.reload(); 
            }
        }

        // ==================== PRODUCT IMAGE UPLOAD ====================
        function previewProductImages(event) {
            const files = Array.from(event.target.files);
            const gallery = document.getElementById('product-image-gallery');
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    productImages.push(e.target.result);
                    gallery.innerHTML += `
                        <div class="gallery-item">
                            <img src="${e.target.result}" alt="Product">
                            <div class="remove-image" onclick="removeProductImage('${e.target.result}')">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            });
        }

        function removeProductImage(image) {
            productImages = productImages.filter(img => img !== image);
            renderProductImages();
        }

        function renderProductImages() {
            const gallery = document.getElementById('product-image-gallery');
            gallery.innerHTML = productImages.map(img => `
                <div class="gallery-item">
                    <img src="${img}" alt="Product">
                    <div class="remove-image" onclick="removeProductImage('${img}')">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
            `).join('');
        }

        // ==================== BRANCH MANAGEMENT ====================
        function addBranch() {
            const name = document.getElementById('branch-name').value.trim();
            const location = document.getElementById('branch-location').value.trim();
            const phone = document.getElementById('branch-phone').value.trim();
            
            if (!name) {
                showToast(translations[currentLanguage]['fill-all-fields'], "error");
                return;
            }
            
            const branch = {
                id: 'branch_' + Date.now(),
                name,
                location,
                phone
            };
            
            branches.push(branch);
            saveBranches();
            renderBranchList();
            
            const select = document.getElementById('branchSelect');
            select.innerHTML += `<option value="${branch.id}">${branch.name}</option>`;
            document.getElementById('branchSelector').classList.remove('hidden');
            
            document.getElementById('branch-name').value = '';
            document.getElementById('branch-location').value = '';
            document.getElementById('branch-phone').value = '';
            
            showToast(translations[currentLanguage]['branch-added'], "success");
        }

        function saveBranches() {
            localStorage.setItem('branches', JSON.stringify(branches));
        }

        function renderBranchList() {
            const listDiv = document.getElementById('branch-list');
            if (!listDiv) return;
            
            listDiv.innerHTML = branches.map(branch => `
                <div class="bg-white p-4 rounded-lg border hover:shadow-md transition-all">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold">${branch.name}</p>
                            <p class="text-sm text-gray-600">${branch.location || 'N/A'}</p>
                            <p class="text-xs text-gray-500">${branch.phone || 'N/A'}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="transferStock('${branch.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-all">
                                <i class="fas fa-exchange-alt mr-1"></i>‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞
                            </button>
                            <button onclick="deleteBranch('${branch.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-all">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function switchBranch(branchId) {
            currentBranch = branchId;
            loadUserData();
            showToast(`‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, "success");
        }

        function deleteBranch(branchId) {
            if (branchId === 'main') {
                showToast('‡¶Æ‡ßÇ‡¶≤ ‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ', 'error');
                return;
            }
            if (confirm('‡¶∂‡¶æ‡¶ñ‡¶æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?')) {
                branches = branches.filter(b => b.id !== branchId);
                saveBranches();
                renderBranchList();
                
                const select = document.getElementById('branchSelect');
                select.innerHTML = '<option value="main">‡¶Æ‡ßÇ‡¶≤ ‡¶∂‡¶æ‡¶ñ‡¶æ</option>' + 
                    branches.filter(b => b.id !== 'main').map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            }
        }

        function transferStock(branchId) {
            const productId = prompt('‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®:');
            const qty = parseInt(prompt('‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:'));
            if (productId && qty) {
                showToast(translations[currentLanguage]['stock-transferred'], 'success');
            }
        }

        // ==================== INVENTORY MANAGEMENT ====================
        function renderInventoryData() {
            renderWarehouseList();
            checkLowStock();
        }

        function addWarehouse() {
            const name = document.getElementById('warehouse-name').value.trim();
            const location = document.getElementById('warehouse-location').value.trim();
            
            if (!name) {
                showToast('‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®', 'error');
                return;
            }
            
            const warehouse = {
                id: 'wh_' + Date.now(),
                name,
                location
            };
            
            warehouses.push(warehouse);
            saveWarehouses();
            renderWarehouseList();
            
            document.getElementById('warehouse-name').value = '';
            document.getElementById('warehouse-location').value = '';
            
            const select = document.getElementById('p-warehouse');
            select.innerHTML = `<option value="main">‡¶Æ‡ßÇ‡¶≤ ‡¶ó‡ßã‡¶°‡¶æ‡¶â‡¶®</option>` + 
                warehouses.filter(w => w.id !== 'main').map(w => `<option value="${w.id}">${w.name}</option>`).join('');
            
            showToast('‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡¶π‡¶æ‡¶â‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        }

        function saveWarehouses() {
            localStorage.setItem('warehouses', JSON.stringify(warehouses));
        }

        function renderWarehouseList() {
            const listDiv = document.getElementById('warehouse-list');
            if (!listDiv) return;
            
            listDiv.innerHTML = warehouses.map(wh => `
                <div class="bg-white p-2 rounded border mb-2 flex justify-between items-center">
                    <div>
                        <p class="font-bold">${wh.name}</p>
                        <p class="text-xs text-gray-500">${wh.location || ''}</p>
                    </div>
                    <button onclick="deleteWarehouse('${wh.id}')" class="text-red-500">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function deleteWarehouse(whId) {
            if (whId === 'main') {
                showToast('‡¶Æ‡ßÇ‡¶≤ ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡¶π‡¶æ‡¶â‡¶∏ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ', 'error');
                return;
            }
            warehouses = warehouses.filter(w => w.id !== whId);
            saveWarehouses();
            renderWarehouseList();
        }

        function searchBatch() {
            const batch = document.getElementById('batch-search').value.trim();
            if (!batch) return;
            
            const results = products.filter(p => p.batch === batch);
            const div = document.getElementById('batch-results');
            div.innerHTML = results.map(p => `
                <div class="bg-white p-2 rounded border mb-1">
                    ${p.name} - ‡¶∏‡ßç‡¶ü‡¶ï: ${p.qty} ${p.unit}
                </div>
            `).join('');
        }

        function searchSerial() {
            const serial = document.getElementById('serial-search').value.trim();
            if (!serial) return;
            
            const results = products.filter(p => p.serials && p.serials.includes(serial));
            const div = document.getElementById('serial-results');
            div.innerHTML = results.map(p => `
                <div class="bg-white p-2 rounded border mb-1">
                    ${p.name} - ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤: ${serial}
                </div>
            `).join('');
        }

        function setMinStockThreshold() {
            const threshold = parseInt(document.getElementById('min-stock-threshold').value);
            if (threshold > 0) {
                minStockThreshold = threshold;
                showToast(`‡¶•‡ßç‡¶∞‡ßá‡¶∂‡¶π‡ßã‡¶≤‡ßç‡¶° ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${threshold}`, 'success');
                checkLowStock();
            }
        }

        function checkLowStock() {
            const lowStock = products.filter(p => p.qty < minStockThreshold);
            const div = document.getElementById('low-stock-list');
            if (div) {
                div.innerHTML = lowStock.map(p => `
                    <div class="bg-red-50 p-2 rounded border mb-1 text-red-600">
                        ${p.name} - ‡¶∏‡ßç‡¶ü‡¶ï: ${p.qty} ${p.unit}
                    </div>
                `).join('');
            }
            
            if (lowStock.length > 0) {
                document.getElementById('low-stock-alert').style.display = 'block';
                document.getElementById('low-stock-items').innerHTML = lowStock.map(i => 
                    `<li>${i.name} (‡¶∏‡ßç‡¶ü‡¶ï: ${i.qty} ${i.unit})</li>`
                ).join('');
            }
        }

        function generateAutoPO() {
            const lowStock = products.filter(p => p.qty < minStockThreshold);
            if (lowStock.length === 0) {
                showToast('‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶ï‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶®‡ßá‡¶á', 'info');
                return;
            }
            
            const po = {
                id: 'PO_' + Date.now(),
                date: new Date().toISOString(),
                items: lowStock.map(p => ({
                    name: p.name,
                    currentStock: p.qty,
                    requiredQty: minStockThreshold * 2 - p.qty
                }))
            };
            
            console.log('Purchase Order:', po);
            showToast('‡¶™‡¶ø‡¶ì ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        }

        // ==================== ADVANCED REPORTS ====================
        let trendChart, profitLossAdvancedChart, categoryChart, branchChart;

        function generateAdvancedReport() {
            const type = document.getElementById('report-type').value;
            const start = document.getElementById('report-start-date').value;
            const end = document.getElementById('report-end-date').value;
            
            let startDate, endDate;
            
            if (type === 'custom' && start && end) {
                startDate = new Date(start);
                endDate = new Date(end);
            } else {
                const now = new Date();
                switch(type) {
                    case 'daily':
                        startDate = new Date(now.setHours(0,0,0,0));
                        endDate = new Date(now.setHours(23,59,59,999));
                        break;
                    case 'weekly':
                        startDate = new Date(now.setDate(now.getDate() - 7));
                        endDate = new Date();
                        break;
                    case 'monthly':
                        startDate = new Date(now.setMonth(now.getMonth() - 1));
                        endDate = new Date();
                        break;
                    case 'yearly':
                        startDate = new Date(now.setFullYear(now.getFullYear() - 1));
                        endDate = new Date();
                        break;
                }
            }
            
            const filteredSales = salesRecords.filter(s => {
                const d = new Date(s.date);
                return d >= startDate && d <= endDate;
            });
            
            renderReportTable(filteredSales);
            updateTrendChart(filteredSales);
            updateProfitLossChart(filteredSales);
            updateCategoryChart();
            updateBranchChart(filteredSales);
        }

        function renderReportTable(sales) {
            const tbody = document.getElementById('report-table-body');
            const dailyData = {};
            
            sales.forEach(s => {
                const date = s.date.split('T')[0];
                if (!dailyData[date]) {
                    dailyData[date] = { sales: 0, profit: 0, expense: 0 };
                }
                dailyData[date].sales += s.amount;
                dailyData[date].profit += s.profit;
            });
            
            expenses.forEach(e => {
                if (dailyData[e.date]) {
                    dailyData[e.date].expense += e.amount;
                }
            });
            
            tbody.innerHTML = Object.entries(dailyData).map(([date, data]) => `
                <tr>
                    <td class="p-2 border">${new Date(date).toLocaleDateString('bn-BD')}</td>
                    <td class="p-2 border">‡ß≥ ${data.sales}</td>
                    <td class="p-2 border">‡ß≥ ${data.profit}</td>
                    <td class="p-2 border">‡ß≥ ${data.expense}</td>
                    <td class="p-2 border font-bold">‡ß≥ ${data.profit - data.expense}</td>
                </tr>
            `).join('');
        }

        function updateTrendChart(sales) {
            const ctx = document.getElementById('trendChart')?.getContext('2d');
            if (!ctx) return;
            
            if (trendChart) trendChart.destroy();
            
            const dates = [];
            const amounts = [];
            
            sales.slice(0, 30).reverse().forEach(s => {
                dates.push(new Date(s.date).toLocaleDateString('bn-BD'));
                amounts.push(s.amount);
            });
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø',
                        data: amounts,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                }
            });
        }

        function updateProfitLossChart(sales) {
            const ctx = document.getElementById('profitLossAdvancedChart')?.getContext('2d');
            if (!ctx) return;
            
            if (profitLossAdvancedChart) profitLossAdvancedChart.destroy();
            
            const dates = [];
            const profits = [];
            const losses = [];
            
            sales.slice(0, 30).reverse().forEach(s => {
                dates.push(new Date(s.date).toLocaleDateString('bn-BD'));
                profits.push(s.profit);
                losses.push(0);
            });
            
            profitLossAdvancedChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '‡¶≤‡¶æ‡¶≠',
                            data: profits,
                            backgroundColor: '#10b981'
                        },
                        {
                            label: '‡¶≤‡¶∏',
                            data: losses,
                            backgroundColor: '#ef4444'
                        }
                    ]
                }
            });
        }

        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart')?.getContext('2d');
            if (!ctx) return;
            
            if (categoryChart) categoryChart.destroy();
            
            const categories = {};
            products.forEach(p => {
                const cat = p.category || '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø';
                categories[cat] = (categories[cat] || 0) + p.qty;
            });
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                }
            });
        }

        function updateBranchChart(sales) {
            const ctx = document.getElementById('branchChart')?.getContext('2d');
            if (!ctx) return;
            
            if (branchChart) branchChart.destroy();
            
            const branchSales = {};
            sales.forEach(s => {
                const branch = s.branch || 'main';
                branchSales[branch] = (branchSales[branch] || 0) + s.amount;
            });
            
            const branchNames = {};
            branches.forEach(b => branchNames[b.id] = b.name);
            
            branchChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(branchSales).map(b => branchNames[b] || b),
                    datasets: [{
                        label: '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø',
                        data: Object.values(branchSales),
                        backgroundColor: '#4f46e5'
                    }]
                }
            });
        }

        function exportReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text(config.shopName, 105, 15, {align: 'center'});
            doc.setFontSize(12);
            doc.text('‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü', 105, 25, {align: 'center'});
            
            const tableData = [];
            document.querySelectorAll('#report-table-body tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => row.push(td.innerText));
                tableData.push(row);
            });
            
            doc.autoTable({
                startY: 35,
                head: [['‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ', '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø', '‡¶≤‡¶æ‡¶≠', '‡¶ñ‡¶∞‡¶ö', '‡¶®‡¶ø‡¶ü']],
                body: tableData
            });
            
            doc.save('report.pdf');
        }

        function exportReportExcel() {
            const wb = XLSX.utils.book_new();
            const wsData = [['‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ', '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø', '‡¶≤‡¶æ‡¶≠', '‡¶ñ‡¶∞‡¶ö', '‡¶®‡¶ø‡¶ü']];
            
            document.querySelectorAll('#report-table-body tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => row.push(td.innerText));
                wsData.push(row);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Report');
            XLSX.writeFile(wb, 'report.xlsx');
        }

        function printReport() {
            window.print();
        }

        // ==================== CLOUD BACKUP ====================
        function initGoogleDrive() {
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    apiKey: 'YOUR_API_KEY',
                    clientId: 'YOUR_CLIENT_ID',
                    scope: 'https://www.googleapis.com/auth/drive.file'
                });
            });
        }

        function backupToGoogleDrive() {
            const data = {
                products, salesRecords, expenses, stockHistory, customers, suppliers, config, users, branches, warehouses
            };
            
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const file = new File([blob], `backup_${Date.now()}.json`, {type: 'application/json'});
            
            showToast(translations[currentLanguage]['backup-start'], "success");
            createRecoveryPoint(data);
        }

        function restoreFromGoogleDrive() {
            showToast('‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®', 'success');
        }

        function backupToDropbox() {
            const data = {
                products, salesRecords, expenses, stockHistory, customers, suppliers, config, users, branches, warehouses
            };
            
            showToast(translations[currentLanguage]['backup-start'], "success");
            createRecoveryPoint(data);
        }

        function restoreFromDropbox() {
            showToast('‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®', 'success');
        }

        function createRecoveryPoint(data) {
            recoveryPoints.push({
                timestamp: Date.now(),
                data: data
            });
            localStorage.setItem('recovery_points', JSON.stringify(recoveryPoints));
        }

        function showRecoveryPoints() {
            const points = recoveryPoints.map((p, i) => 
                `${i + 1}. ${new Date(p.timestamp).toLocaleString()}`
            ).join('\n');
            
            alert('‡¶∞‡¶ø‡¶ï‡¶≠‡¶æ‡¶∞‡¶ø ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü:\n' + (points || '‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á'));
        }

        function setAutoBackup() {
            const schedule = document.getElementById('backup-schedule').value;
            config.autoBackup = true;
            config.backupSchedule = schedule;
            saveToStorage();
            
            let interval;
            switch(schedule) {
                case 'daily': interval = 24 * 60 * 60 * 1000; break;
                case 'weekly': interval = 7 * 24 * 60 * 60 * 1000; break;
                case 'monthly': interval = 30 * 24 * 60 * 60 * 1000; break;
                case 'yearly': interval = 365 * 24 * 60 * 60 * 1000; break;
            }
            
            if (backupSchedule) clearInterval(backupSchedule);
            backupSchedule = setInterval(() => {
                if (config.autoBackup) {
                    backupToGoogleDrive();
                }
            }, interval);
            
            showToast('‡¶Ö‡¶ü‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        }

        function syncDevices() {
            showToast('‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'info');
            setTimeout(() => showToast('‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®', 'success'), 2000);
        }

        // ==================== OFFLINE SYNC ====================
        function addToOfflineQueue(action, data) {
            offlineQueue.push({ action, data, timestamp: Date.now() });
            localStorage.setItem('offline_queue', JSON.stringify(offlineQueue));
        }

        function syncOfflineData() {
            const queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
            queue.forEach(async item => {
                try {
                    switch(item.action) {
                        case 'sale':
                            salesRecords.push(item.data);
                            break;
                        case 'product':
                            products.push(item.data);
                            break;
                    }
                    saveToStorage();
                } catch (error) {
                    console.error('Sync failed:', error);
                }
            });
            localStorage.removeItem('offline_queue');
            offlineQueue = [];
        }

        // ==================== DAILY TARGET ALERT ====================
        function checkDailyTarget() {
            if (!config.dailyTarget) return;
            
            const today = new Date().toISOString().split('T')[0];
            const todaySales = salesRecords.filter(s => s.date.startsWith(today));
            const total = todaySales.reduce((sum, s) => sum + s.amount, 0);
            
            if (total >= config.dailyTarget) {
                const alertDiv = document.getElementById('target-alert');
                if (!alertDiv) return;
                
                const itemsDiv = document.getElementById('target-items');
                if (itemsDiv) {
                    itemsDiv.innerHTML = `<li>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü (‡ß≥${config.dailyTarget}) ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø: ‡ß≥${total}</li>`;
                }
                alertDiv.style.display = 'block';
                
                if (Notification.permission === 'granted') {
                    new Notification('‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶™‡ßÇ‡¶∞‡ßç‡¶£!', { 
                        body: `‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡ß≥${config.dailyTarget} ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡ßü‡ßá‡¶õ‡ßá` 
                    });
                }
            }
        }

        // ==================== KEYBOARD SHORTCUTS ====================
        function showShortcuts() {
            alert(
                '‡¶ï‡ßÄ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶∂‡¶∞‡ßç‡¶ü‡¶ï‡¶æ‡¶ü:\n' +
                'F2 - POS ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®\n' +
                'Ctrl+N - ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º\n' +
                'Ctrl+S - ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£\n' +
                'Ctrl+P - ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü\n' +
                'Ctrl+F - ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö\n' +
                'F5 - ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂\n' +
                'Esc - ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®'
            );
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'F2') { 
                e.preventDefault(); 
                openModal('posModal'); 
            }
            if (e.key === 'Escape') { 
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
                document.body.style.overflow = '';
            }
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                openModal('posModal');
            }
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveToStorage();
                showToast('‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§', 'success');
            }
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('pos-search')?.focus();
            }
            if (e.key === 'F5') {
                e.preventDefault();
                loadUserData();
                showToast('‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'info');
            }
        });

        window.onclick = function(event) { 
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        function setLayoutPreference(layout) {
            localStorage.setItem('layout_preference', layout);
            document.body.setAttribute('data-layout', layout);
        }

        // ==================== INITIAL LOAD ====================
        window.onload = function() {
            initializeSystem();
            
            const savedLang = localStorage.getItem('preferred_language');
            if (savedLang) {
                setLanguage(savedLang);
            }
            
            updateOnlineStatus();
            
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            initGoogleDrive();
            
            const savedUser = localStorage.getItem('currentUser');
            const savedRole = localStorage.getItem('currentUserRole');
            const savedOwner = localStorage.getItem('currentUserOwner');
            const savedPermissions = localStorage.getItem('currentUserPermissions');
            
            if (savedUser && savedRole) {
                currentUser = savedUser;
                currentUserRole = savedRole;
                currentUserOwner = savedOwner || null;
                currentUserPermissions = savedPermissions ? JSON.parse(savedPermissions) : {};
                
                const user = users.find(u => u.username === savedUser);
                if (savedUser === 'admin' || (user && user.approved)) {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-content').classList.remove('hidden');
                    updateUserDisplay();
                    loadUserData();
                    applyPermissions();
                } else {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('currentUserRole');
                    localStorage.removeItem('currentUserOwner');
                    localStorage.removeItem('currentUserPermissions');
                }
            }
        };
    </script>
</body>
</html>
