<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶® - ‡¶™‡ßç‡¶∞‡¶´‡ßá‡¶∂‡¶®‡¶æ‡¶≤ POS ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f3f4f6;
        }
        
        body {
            font-family: 'Hind Siliguri', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* Modal Styles */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 9999; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            backdrop-filter: blur(5px);
            overflow-y: auto; 
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* POS Grid */
        .pos-grid { 
            display: grid; 
            grid-template-columns: 1fr 350px; 
            gap: 20px; 
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .pos-grid { 
                grid-template-columns: 1fr; 
                gap: 10px;
            }
            
            .pos-grid > div:first-child {
                order: 1;
            }
            
            .pos-grid > div:last-child {
                order: 2;
            }
            
            .mobile-menu-active { 
                display: block !important; 
                position: fixed !important;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                z-index: 9998;
                overflow-y: auto;
                animation: slideIn 0.3s ease-out;
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(-100%);
                }
                to {
                    transform: translateX(0);
                }
            }
            
            .modal-content {
                width: 95% !important;
                margin: 10px auto;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .text-2xl {
                font-size: 1.2rem !important;
            }
            
            .p-6 {
                padding: 1rem !important;
            }
            
            .product-card {
                padding: 0.75rem !important;
            }
            
            .product-card p {
                font-size: 0.85rem !important;
            }
            
            .cart-item {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.5rem !important;
                padding: 0.75rem !important;
            }
            
            #pos-search {
                font-size: 16px !important;
                padding: 12px !important;
            }
            
            .touch-target {
                min-height: 48px !important;
            }
            
            button, .btn-primary, .btn-success, .btn-danger {
                font-size: 16px !important;
                padding: 12px !important;
            }
            
            input, select, textarea {
                font-size: 16px !important;
                padding: 12px !important;
            }
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #barcode-print-area, #barcode-print-area * { visibility: visible; }
            #bulk-barcode-print-area, #bulk-barcode-print-area * { visibility: visible; }
            #a4-print-section, #a4-print-section * { visibility: visible; }
            
            #print-section { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 80mm; 
                padding: 5px;
            }
            #a4-print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                padding: 10mm;
                background: white;
            }
            #bulk-barcode-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: flex !important;
                flex-wrap: wrap;
                gap: 5px;
            }
            .no-print { display: none !important; }
        }

        /* Dark Mode */
        .dark-mode { 
            background: #1a1a1a; 
            color: #e5e5e5; 
        }
        
        .dark-mode .bg-white { 
            background-color: #2d2d2d; 
            color: #fff; 
        }
        
        .dark-mode header h1, 
        .dark-mode h3 { 
            color: #fff; 
        }

        /* Scrollbar */
        ::-webkit-scrollbar { 
            width: 8px; 
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb { 
            background: var(--primary); 
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Invoice Table */
        .a4-table th, 
        .a4-table td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }

        /* Auth Screen */
        #auth-screen {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, #818cf8 100%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 10000;
            padding: 10px;
        }
        
        /* Badges */
        .pending-badge {
            background-color: var(--warning);
            color: #000;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .owner-badge {
            background-color: #8b5cf6;
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 999px;
            display: inline-block;
        }
        
        .staff-badge {
            background-color: var(--secondary);
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 999px;
            display: inline-block;
        }
        
        /* Permission Chips */
        .permission-chip {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            margin: 2px;
            background-color: #e5e7eb;
            color: #374151;
            transition: all 0.3s;
        }
        
        .permission-chip.active {
            background-color: var(--secondary);
            color: white;
        }
        
        .permission-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Touch Targets */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .desktop-only {
                display: none !important;
            }
            
            .mobile-full {
                width: 100% !important;
            }
            
            .text-sm-mobile {
                font-size: 0.75rem !important;
            }
            
            .p-mobile {
                padding: 0.5rem !important;
            }
            
            .grid-cols-mobile {
                grid-template-columns: 1fr !important;
            }
            
            .overflow-x-mobile {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(79, 70, 229, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--secondary) 0%, #059669 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        /* Product Cards */
        .product-card {
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: var(--primary);
        }
        
        .product-card.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .product-card.out-of-stock:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Cart Items */
        .cart-item {
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .cart-item:hover {
            border-left-color: var(--primary);
            background-color: #f9fafb;
        }
        
        /* Forms */
        input, select, textarea {
            transition: all 0.3s;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
            z-index: 10001;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.success {
            border-left-color: var(--secondary);
        }
        
        .toast.error {
            border-left-color: var(--danger);
        }
        
        .toast.warning {
            border-left-color: var(--warning);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans transition-colors duration-300" data-layout="desktop">

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-md text-center max-h-[90vh] overflow-y-auto">
            <div class="flex justify-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-store text-white text-4xl"></i>
                </div>
            </div>
            <h2 class="text-2xl md:text-3xl font-bold text-indigo-700 mb-6 shop-name-display">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®</h2>
            
            <!-- Login Form -->
            <div id="login-form">
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block">‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ</label>
                    <input type="text" id="auth-username" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</label>
                    <input type="password" id="auth-pass" placeholder="********" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-bold mb-4 touch-target hover:from-indigo-700 hover:to-purple-700 transition-all">
                    <i class="fas fa-sign-in-alt mr-2"></i>‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <p class="text-sm text-gray-500">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï? <a href="#" onclick="toggleAuthForms()" class="text-indigo-600 underline font-bold">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</a></p>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form" class="hidden">
                <div class="bg-indigo-50 p-3 rounded-lg mb-4">
                    <p class="text-sm text-indigo-600 font-bold">‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø</p>
                </div>
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block">‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ</label>
                    <input type="text" id="reg-username" placeholder="‡ß© ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</label>
                    <input type="password" id="reg-pass" placeholder="‡ß™ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="reg-shop-name" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∞‡¶π‡¶ø‡¶Æ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <div class="mb-4 text-left">
                    <label class="text-sm text-gray-600 mb-1 block">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
                    <input type="text" id="reg-phone" placeholder="‡ß¶‡ßß‡ß≠XXXXXXXX" class="w-full border p-3 rounded-lg touch-target">
                </div>
                <button onclick="handleOwnerSignup()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 rounded-lg font-bold mb-4 touch-target hover:from-green-700 hover:to-emerald-700 transition-all">
                    <i class="fas fa-user-plus mr-2"></i>‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <p class="text-sm text-gray-500">‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <a href="#" onclick="toggleAuthForms()" class="text-indigo-600 underline font-bold">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</a></p>
            </div>
        </div>
    </div>

    <!-- Admin Approval Modal -->
    <div id="adminApprovalModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-2/3 p-4 md:p-6 shadow-xl modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-indigo-600">üë• ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï</h2>
                <button onclick="closeModal('adminApprovalModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="pending-users-list" class="space-y-3 overflow-y-auto max-h-[60vh]"></div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('adminApprovalModal')" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 transition-all touch-target">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Permission Edit Modal -->
    <div id="permissionEditModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/2 p-4 md:p-6 shadow-xl modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-purple-600">‚úèÔ∏è ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶® ‡¶è‡¶°‡¶ø‡¶ü</h2>
                <button onclick="closeModal('permissionEditModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <input type="hidden" id="edit-staff-username">
            
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="text-sm text-gray-600 mb-1 block">‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ</label>
                        <input type="text" id="edit-staff-username-display" class="w-full border p-2 rounded bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600 mb-1 block">‡¶∏‡ßç‡¶ü‡¶æ‡¶´‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                        <input type="text" id="edit-staff-name" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600 mb-1 block">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
                        <input type="text" id="edit-staff-phone" class="w-full border p-2 rounded">
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="font-bold text-sm mb-3">‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-pos" class="rounded"> <span>POS ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-product-list" class="rounded"> <span>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-due-collection" class="rounded"> <span>‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-return" class="rounded"> <span>‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-daily-closing" class="rounded"> <span>‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-customer-view" class="rounded"> <span>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-product-add" class="rounded"> <span>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-product-edit" class="rounded"> <span>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" id="edit-perm-expense-view" class="rounded"> <span>‡¶ñ‡¶∞‡¶ö ‡¶¶‡ßá‡¶ñ‡¶æ</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('permissionEditModal')" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 transition-all touch-target">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button onclick="saveStaffPermissions()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-all touch-target">
                    <i class="fas fa-save mr-2"></i>‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>

    <!-- Staff Management Modal -->
    <div id="staffManagementModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-2/3 p-4 md:p-6 shadow-xl modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-purple-600">üë• ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                <button onclick="closeModal('staffManagementModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Add New Staff -->
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-4 rounded-lg mb-6">
                <h3 class="font-bold mb-3 text-purple-700">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" id="staff-username" placeholder="‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ" class="border p-2 rounded touch-target">
                    <input type="password" id="staff-password" placeholder="‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="border p-2 rounded touch-target">
                    <input type="text" id="staff-name" placeholder="‡¶∏‡ßç‡¶ü‡¶æ‡¶´‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="border p-2 rounded touch-target">
                    <input type="text" id="staff-phone" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" class="border p-2 rounded touch-target">
                </div>
                
                <div class="mt-4">
                    <h4 class="font-bold text-sm mb-2">‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-pos" checked class="rounded"> <span>POS ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-product-list" checked class="rounded"> <span>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-due-collection" checked class="rounded"> <span>‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-return" checked class="rounded"> <span>‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-daily-closing" class="rounded"> <span>‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-customer-view" class="rounded"> <span>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-product-add" class="rounded"> <span>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-product-edit" class="rounded"> <span>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm bg-white p-2 rounded cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="perm-expense-view" class="rounded"> <span>‡¶ñ‡¶∞‡¶ö ‡¶¶‡ßá‡¶ñ‡¶æ</span>
                        </label>
                    </div>
                </div>
                
                <button onclick="addStaff()" class="mt-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-8 py-2 rounded-lg font-bold hover:from-purple-700 hover:to-indigo-700 transition-all touch-target">
                    <i class="fas fa-user-plus mr-2"></i>‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
            
            <!-- Staff List -->
            <h3 class="font-bold mb-3 text-gray-700">üìã ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h3>
            <div id="staff-list" class="space-y-3 mb-6 overflow-y-auto max-h-[40vh]"></div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('staffManagementModal')" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 transition-all touch-target">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="hidden">
        <!-- Mobile Header -->
        <div class="md:hidden bg-gradient-to-r from-indigo-900 to-purple-900 text-white p-3 flex justify-between items-center sticky top-0 z-[100] shadow-lg">
            <h2 class="text-lg font-bold flex items-center gap-2">
                <i class="fas fa-store"></i> 
                <span class="shop-name-display truncate max-w-[150px]">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®</span>
            </h2>
            <div class="flex gap-2 items-center">
                <span id="current-username-mobile" class="text-xs bg-indigo-700 px-2 py-1 rounded-full"></span>
                <span id="user-role-badge-mobile" class="text-xs px-2 py-1 rounded-full"></span>
                <button onclick="toggleDarkMode()" class="text-lg p-2 touch-target hover:bg-indigo-800 rounded-full transition-all">
                    <i class="fas fa-moon"></i>
                </button>
                <button onclick="toggleMobileMenu()" class="text-xl p-2 touch-target hover:bg-indigo-800 rounded-full transition-all">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row min-h-screen">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-full md:w-64 bg-gradient-to-b from-indigo-900 to-purple-900 text-white p-4 md:p-6 hidden md:block fixed md:relative h-full z-[90] overflow-y-auto transition-all duration-300">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-white/10 rounded-2xl flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-store text-white text-3xl"></i>
                    </div>
                    <h2 class="text-xl md:text-2xl font-bold shop-name-display">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®</h2>
                </div>
                
                <div class="mb-4 p-3 bg-white/10 rounded-lg text-center backdrop-blur-sm">
                    <div><span id="current-username-sidebar" class="font-bold text-sm md:text-base"></span></div>
                    <div><span id="user-role-badge-sidebar" class="text-xs mt-1 inline-block"></span></div>
                </div>
                
                <nav class="space-y-1 md:space-y-2">
                    <!-- Dashboard -->
                    <a href="#" onclick="event.preventDefault(); closeMobileMenu();" class="block py-3 px-4 rounded-lg transition bg-white/20 text-sm md:text-base touch-target hover:bg-white/30">
                        <i class="fas fa-home mr-2"></i> ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°
                    </a>
                    
                    <!-- Owner Only Sections -->
                    <div id="owner-menu-items" class="owner-only space-y-1">
                        <a href="#" onclick="event.preventDefault(); openModal('productModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-white/20 text-sm md:text-base touch-target">
                            <i class="fas fa-box mr-2"></i> ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°
                        </a>
                        <a href="#" onclick="event.preventDefault(); openModal('bulkBarcodeModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-white/20 text-sm md:text-base touch-target">
                            <i class="fas fa-print mr-2"></i> ‡¶¨‡¶æ‡¶≤‡ßç‡¶ï ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶°
                        </a>
                        <a href="#" onclick="event.preventDefault(); openModal('supplierModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-white/20 text-sm md:text-base touch-target">
                            <i class="fas fa-truck mr-2"></i> ‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á‡ßü‡¶æ‡¶∞
                        </a>
                        <a href="#" onclick="event.preventDefault(); openModal('stockHistoryModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-white/20 text-sm md:text-base touch-target">
                            <i class="fas fa-history mr-2"></i> ‡¶∏‡ßç‡¶ü‡¶ï ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø
                        </a>
                        <a href="#" onclick="event.preventDefault(); openModal('expenseModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-red-400/20 text-sm md:text-base touch-target">
                            <i class="fas fa-minus-circle mr-2"></i> ‡¶ñ‡¶∞‡¶ö ‡¶è‡¶°
                        </a>
                        <a href="#" onclick="event.preventDefault(); openModal('profitReportModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-white/20 text-sm md:text-base touch-target">
                            <i class="fas fa-chart-line mr-2"></i> ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
                        </a>
                        <a href="#" onclick="event.preventDefault(); openModal('settingsModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-white/20 text-sm md:text-base touch-target">
                            <i class="fas fa-cog mr-2"></i> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏
                        </a>
                        <a href="#" onclick="event.preventDefault(); openModal('staffManagementModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-purple-600 text-sm md:text-base touch-target">
                            <i class="fas fa-users-cog mr-2"></i> ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü
                        </a>
                    </div>
                    
                    <!-- Common Sections -->
                    <a href="#" onclick="event.preventDefault(); openModal('productListModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-white/20 text-sm md:text-base touch-target" id="menu-product-list">
                        <i class="fas fa-list mr-2"></i> ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü
                    </a>
                    <a href="#" onclick="event.preventDefault(); openModal('dueCollectionModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-yellow-600 text-sm md:text-base touch-target" id="menu-due-collection">
                        <i class="fas fa-hand-holding-usd mr-2"></i> ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü
                    </a>
                    <a href="#" onclick="event.preventDefault(); openModal('returnModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-orange-600 text-sm md:text-base touch-target" id="menu-return">
                        <i class="fas fa-undo mr-2"></i> ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®
                    </a>
                    <a href="#" onclick="event.preventDefault(); openModal('posModal'); closeMobileMenu();" class="block py-3 px-4 rounded-lg bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 mt-2 text-center font-bold text-sm md:text-base touch-target" id="menu-pos">
                        <i class="fas fa-shopping-cart mr-2"></i> ‡¶ì‡¶™‡ßá‡¶® POS (F2)
                    </a>
                    <a href="#" onclick="event.preventDefault(); dailyClosingReport(); closeMobileMenu();" class="block py-3 px-4 rounded-lg hover:bg-orange-600 text-sm md:text-base touch-target" id="menu-daily-closing">
                        <i class="fas fa-file-invoice-dollar mr-2"></i> ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç
                    </a>
                    
                    <!-- Admin Only -->
                    <a href="#" onclick="event.preventDefault(); openAdminApprovalModal();" class="block py-3 px-4 rounded-lg hover:bg-purple-600 admin-only relative text-sm md:text-base touch-target">
                        <i class="fas fa-users mr-2"></i> ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠‡¶æ‡¶≤
                        <span id="pending-badge" class="absolute right-2 top-1/2 -translate-y-1/2 hidden pending-badge">new</span>
                    </a>
                    
                    <!-- Owner Only - Backup -->
                    <a href="#" onclick="event.preventDefault(); exportData();" class="block py-3 px-4 rounded-lg hover:bg-white/20 owner-only text-sm md:text-base touch-target">
                        <i class="fas fa-file-export mr-2"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™
                    </a>
                    
                    <!-- Logout & Dark Mode -->
                    <button onclick="handleLogout()" class="w-full text-left py-3 px-4 rounded-lg hover:bg-red-600 text-red-300 hover:text-white mt-2 text-sm md:text-base touch-target transition-all">
                        <i class="fas fa-sign-out-alt mr-2"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
                    </button>
                    <button onclick="toggleDarkMode()" class="w-full text-left py-3 px-4 rounded-lg hover:bg-white/20 text-sm md:text-base touch-target transition-all">
                        <i class="fas fa-adjust mr-2"></i> ‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶Æ‡ßã‡¶°
                    </button>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-3 md:p-8 w-full bg-gray-50">
                <!-- Desktop Header -->
                <header class="hidden md:flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm">
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800">
                        <i class="fas fa-tachometer-alt text-indigo-600 mr-2"></i>
                        ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°
                    </h1>
                    <div class="flex items-center gap-4">
                        <span class="text-gray-600 hidden sm:block" id="current-date"></span>
                        <span class="text-sm font-bold text-indigo-600 hidden sm:block" id="current-username-header"></span>
                        <span class="text-xs hidden sm:block" id="user-role-badge-header"></span>
                        <button onclick="clearAllData()" class="text-xs text-red-500 underline hover:text-red-700 owner-only" id="reset-data-btn">‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ</button>
                        <div class="w-10 h-10 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-full flex items-center justify-center text-white shadow-lg">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </header>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 md:gap-6 stats-grid">
                    <div class="bg-white p-3 md:p-6 rounded-xl shadow-sm border-l-4 border-blue-500 hover:shadow-lg transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs md:text-sm text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</p>
                                <h3 id="stat-sales" class="text-lg md:text-2xl font-bold text-gray-800">‡ß≥ ‡ß¶</h3>
                            </div>
                            <i class="fas fa-shopping-cart text-blue-200 text-xl md:text-3xl"></i>
                        </div>
                    </div>
                    
                    <div class="bg-white p-3 md:p-6 rounded-xl shadow-sm border-l-4 border-green-500 owner-only hover:shadow-lg transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs md:text-sm text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶≤‡¶æ‡¶≠</p>
                                <h3 id="stat-profit" class="text-lg md:text-2xl font-bold text-gray-800">‡ß≥ ‡ß¶</h3>
                            </div>
                            <i class="fas fa-hand-holding-usd text-green-200 text-xl md:text-3xl"></i>
                        </div>
                    </div>
                    
                    <div class="bg-white p-3 md:p-6 rounded-xl shadow-sm border-l-4 border-red-500 owner-only hover:shadow-lg transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs md:text-sm text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</p>
                                <h3 id="stat-expense" class="text-lg md:text-2xl font-bold text-gray-800">‡ß≥ ‡ß¶</h3>
                            </div>
                            <i class="fas fa-money-bill-wave text-red-200 text-xl md:text-3xl"></i>
                        </div>
                    </div>
                    
                    <div class="bg-white p-3 md:p-6 rounded-xl shadow-sm border-l-4 border-purple-500 owner-only hover:shadow-lg transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs md:text-sm text-gray-500">‡¶®‡¶ø‡¶ü ‡¶≤‡¶æ‡¶≠</p>
                                <h3 id="stat-net-profit" class="text-lg md:text-2xl font-bold text-gray-800">‡ß≥ ‡ß¶</h3>
                            </div>
                            <i class="fas fa-wallet text-purple-200 text-xl md:text-3xl"></i>
                        </div>
                    </div>
                    
                    <div class="bg-white p-3 md:p-6 rounded-xl shadow-sm border-l-4 border-yellow-500 hover:shadow-lg transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs md:text-sm text-gray-500">‡¶¨‡¶æ‡¶ï‡¶ø</p>
                                <h3 id="stat-due" class="text-lg md:text-2xl font-bold text-gray-800">‡ß≥ ‡ß¶</h3>
                            </div>
                            <i class="fas fa-user-clock text-yellow-200 text-xl md:text-3xl"></i>
                        </div>
                    </div>
                    
                    <div class="bg-white p-3 md:p-6 rounded-xl shadow-sm border-l-4 border-indigo-500 owner-only hover:shadow-lg transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs md:text-sm text-gray-500">‡¶∏‡ßç‡¶ü‡¶ï ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</p>
                                <h3 id="stat-stock" class="text-lg md:text-2xl font-bold text-gray-800">‡ß≥ ‡ß¶</h3>
                            </div>
                            <i class="fas fa-boxes text-indigo-200 text-xl md:text-3xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Charts (Owner Only) -->
                <div class="hidden md:grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8 owner-only">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold mb-4 text-gray-700">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶´ (‡¶ó‡¶§ ‡ß≠ ‡¶¶‡¶ø‡¶®)</h3>
                        <canvas id="salesChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold mb-4 text-gray-700">‡¶¨‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡ßá‡¶≤‡¶ø‡¶Ç ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü</h3>
                        <canvas id="topProductsChart"></canvas>
                    </div>
                </div>

                <!-- Alerts -->
                <div id="low-stock-alert" class="mt-4 md:mt-6 hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-3 md:p-4 rounded text-sm animate-pulse" role="alert">
                    <p class="font-bold"><i class="fas fa-exclamation-triangle mr-2"></i>‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü!</p>
                    <div id="low-stock-items" class="text-xs md:text-sm list-disc pl-5 mt-2"></div>
                </div>

                <div id="expiry-alert" class="mt-4 hidden bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-3 md:p-4 rounded text-sm animate-pulse" role="alert">
                    <p class="font-bold"><i class="fas fa-calendar-times mr-2"></i>‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶•‡ßá!</p>
                    <div id="expiry-items" class="text-xs md:text-sm list-disc pl-5 mt-2"></div>
                </div>

                <!-- Recent Sales -->
                <div class="mt-6 md:mt-10 bg-white p-3 md:p-6 rounded-xl shadow-sm overflow-x-auto">
                    <h3 class="text-base md:text-lg font-bold mb-4 text-gray-800">
                        <i class="fas fa-history text-indigo-600 mr-2"></i>
                        ‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø
                    </h3>
                    <div class="overflow-x-auto -mx-3 md:mx-0">
                        <table class="w-full text-left min-w-[500px] md:min-w-full">
                            <thead>
                                <tr class="text-gray-400 border-b text-xs md:text-sm">
                                    <th class="pb-3 font-medium">‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏</th>
                                    <th class="pb-3 font-medium">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th>
                                    <th class="pb-3 font-medium">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                                    <th class="pb-3 font-medium">‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th>
                                    <th class="pb-3 font-medium">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ</th>
                                </tr>
                            </thead>
                            <tbody id="recent-sales-body" class="text-gray-600 text-xs md:text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- All Modals -->
    <div id="bulkBarcodeModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/2 p-6 shadow-xl modal-content">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 text-indigo-600">‡¶¨‡¶æ‡¶≤‡ßç‡¶ï ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡¶∞</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-gray-500">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <select id="bulk-p-select" class="w-full border p-2 rounded">
                        <option value="">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-gray-500">‡¶ï‡¶§‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡ßç‡¶ü‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?</label>
                    <input type="number" id="bulk-p-qty" value="1" min="1" class="w-full border p-2 rounded">
                </div>
                <button onclick="generateBulkBarcodes()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="closeModal('bulkBarcodeModal')" class="bg-gray-400 text-white px-4 py-2 rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <div id="returnModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/2 p-6 shadow-xl modal-content">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 text-orange-600">‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® / ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶´‡ßá‡¶∞‡¶§</h2>
            <div class="space-y-4">
                <div class="flex gap-2">
                    <input type="text" id="return-inv-input" placeholder="‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶®‡¶Ç (‡¶Ø‡ßá‡¶Æ‡¶®: INV-001)" class="flex-1 border p-2 rounded">
                    <button onclick="findInvoiceForReturn()" class="bg-orange-600 text-white px-4 py-2 rounded">‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
                </div>
                <div id="return-items-area" class="max-h-80 overflow-y-auto space-y-2"></div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="closeModal('returnModal')" class="bg-gray-400 text-white px-4 py-2 rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <div id="supplierModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/2 p-6 shadow-xl modal-content">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 text-indigo-600">‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á‡ßü‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="sup-name" placeholder="‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á‡ßü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="flex-1 border p-2 rounded">
                <input type="number" id="sup-due" placeholder="‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ" class="flex-1 border p-2 rounded">
                <button onclick="addSupplier()" class="bg-indigo-600 text-white px-4 py-2 rounded">‡¶è‡¶°</button>
            </div>
            <div class="max-h-60 overflow-y-auto">
                <table class="w-full text-left border-collapse">
                    <thead><tr class="bg-gray-100"><th class="p-2 text-xs">‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á‡ßü‡¶æ‡¶∞</th><th class="p-2 text-xs">‡¶¨‡¶æ‡¶ï‡¶ø (‡¶¶‡ßá‡¶®‡¶æ)</th><th class="p-2 text-xs">‡¶è‡¶ï‡¶∂‡¶®</th></tr></thead>
                    <tbody id="supplier-list-body"></tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6"><button onclick="closeModal('supplierModal')" class="bg-gray-400 text-white px-4 py-2 rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/3 p-6 shadow-xl modal-content">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-gray-500">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶≤‡ßã‡¶ó‡ßã</label>
                    <input type="file" id="conf-logo" accept="image/*" onchange="previewLogo(event)" class="w-full border p-1 rounded">
                    <img id="logo-preview-img" src="" class="h-12 mt-2 hidden">
                </div>
                <div>
                    <label class="text-sm text-gray-500">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="conf-shop-name" class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="text-sm text-gray-500">‡¶≠‡ßç‡¶Ø‡¶æ‡¶ü ‡¶π‡¶æ‡¶∞ (%)</label>
                    <input type="number" id="conf-vat" class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="text-sm text-gray-500">‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶®‡ßã‡¶ü</label>
                    <textarea id="conf-note" class="w-full border p-2 rounded"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('settingsModal')" class="bg-gray-400 text-white px-4 py-2 rounded">‡¶¨‡¶®‡ßç‡¶ß</button>
                <button onclick="saveSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded">‡¶∏‡ßá‡¶≠ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
            </div>
        </div>
    </div>

    <div id="dueCollectionModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/2 p-6 shadow-xl modal-content">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 text-yellow-600">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶¶‡¶æ‡ßü</h2>
            <div class="space-y-4">
                <input type="text" id="due-search" onkeyup="searchDueRecords()" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶´‡ßã‡¶® ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full border p-2 rounded">
                <div class="max-h-60 overflow-y-auto" id="due-records-list"></div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="closeModal('dueCollectionModal')" class="bg-gray-400 text-white px-4 py-2 rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <div id="stockHistoryModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-2/3 p-6 shadow-xl max-h-[80vh] flex flex-col modal-content">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®/‡¶Ü‡¶â‡¶ü ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h2>
            <div class="overflow-y-auto flex-1">
                <table class="w-full text-left">
                    <thead class="sticky top-0 bg-gray-100">
                        <tr><th class="p-2">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th class="p-2">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü</th><th class="p-2">‡¶ß‡¶∞‡¶£</th><th class="p-2">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th></tr>
                    </thead>
                    <tbody id="stock-history-body"></tbody>
                </table>
            </div>
            <button onclick="closeModal('stockHistoryModal')" class="mt-4 bg-gray-400 text-white px-4 py-2 rounded self-end">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- POS Modal -->
    <div id="posModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 h-5/6 p-4 md:p-6 shadow-xl flex flex-col modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl md:text-2xl font-bold text-indigo-800 italic">
                    <i class="fas fa-calculator mr-2"></i> POS ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ
                </h2>
                <div class="flex gap-4">
                    <div class="hidden md:flex items-center gap-2 bg-gray-100 px-3 py-1 rounded">
                        <i class="fas fa-barcode text-gray-500"></i>
                        <input type="text" id="barcode-input" placeholder="‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®..." class="bg-transparent outline-none w-24 text-sm" onkeypress="handleBarcode(event)">
                    </div>
                    <button onclick="closeModal('posModal')" class="text-red-500 text-2xl font-bold hover:text-red-700 transition-all">&times;</button>
                </div>
            </div>
            
            <div class="pos-grid flex-1 overflow-hidden">
                <!-- Products Grid -->
                <div class="overflow-y-auto pr-0 md:pr-4">
                    <input type="text" id="pos-search" onkeyup="filterPOSProducts()" placeholder="üîç ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full border p-3 mb-4 rounded-lg shadow-sm">
                    <div id="pos-product-list" class="grid grid-cols-2 lg:grid-cols-3 gap-2 md:gap-4"></div>
                </div>
                
                <!-- Cart -->
                <div class="bg-gray-50 p-4 rounded-lg flex flex-col shadow-inner border mt-4 md:mt-0">
                    <h3 class="font-bold border-b mb-3 pb-2 flex items-center justify-between">
                        <span><i class="fas fa-shopping-cart text-indigo-600 mr-2"></i>‡¶ï‡¶æ‡¶∞‡ßç‡¶ü</span>
                        <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded" id="cart-count">0 ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ</span>
                    </h3>
                    
                    <div id="cart-items" class="flex-1 overflow-y-auto space-y-2 mb-4">
                        <p class="text-gray-400 text-sm italic text-center py-5">‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡ßá‡¶á</p>
                    </div>
                    
                    <div class="border-t pt-3 space-y-3">
                        <div class="flex justify-between text-sm">
                            <span>‡¶∏‡¶æ‡¶¨-‡¶ü‡ßã‡¶ü‡¶æ‡¶≤:</span>
                            <span id="cart-subtotal" class="font-bold">‡ß≥ ‡ß¶</span>
                        </div>
                        
                        <div class="flex justify-between text-sm text-green-600">
                            <span>‡¶≠‡ßç‡¶Ø‡¶æ‡¶ü (<span id="vat-rate-label">0</span>%):</span>
                            <span id="cart-vat" class="font-bold">‡ß≥ ‡ß¶</span>
                        </div>
                        
                        <div class="flex justify-between text-lg font-bold text-indigo-600">
                            <span>‡¶Æ‡ßã‡¶ü:</span>
                            <span id="cart-total">‡ß≥ ‡ß¶</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="pos-customer" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full text-sm border p-2 rounded" list="customer-list" onchange="checkCustomerStatus()">
                            <datalist id="customer-list"></datalist>
                            <input type="text" id="pos-customer-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" class="w-full text-sm border p-2 rounded">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="pos-discount" oninput="renderCart()" placeholder="‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü (‡ß≥)" class="w-full text-sm border p-2 rounded">
                            <select id="pos-payment-method" class="w-full text-sm border p-2 rounded">
                                <option value="Cash">üíµ Cash (‡¶®‡¶ó‡¶¶)</option>
                                <option value="Bkash">üì± Bkash</option>
                                <option value="Nagad">üì± Nagad</option>
                                <option value="Bank">üí≥ Bank/Card</option>
                            </select>
                        </div>

                        <div id="loyalty-info" class="text-xs text-indigo-600 font-bold bg-indigo-50 p-2 rounded">
                            ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶≤‡ßü‡ßç‡¶Ø‡¶æ‡¶≤‡¶ü‡¶ø ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü: <span id="avail-points">0</span>
                        </div>
                        
                        <input type="number" id="pos-paid" placeholder="‡¶™‡ßá‡¶á‡¶° ‡¶ü‡¶æ‡¶ï‡¶æ" class="w-full text-sm border p-2 rounded">
                        
                        <button onclick="checkout()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 rounded-lg font-bold hover:from-green-700 hover:to-emerald-700 transition-all">
                            <i class="fas fa-check-circle mr-2"></i>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-[600px] p-6 shadow-xl relative modal-content">
            <div class="flex justify-between border-b pb-2 mb-4 no-print">
                <h3 class="font-bold">‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</h3>
                <div class="flex gap-2">
                    <button onclick="toggleInvoiceType('thermal')" id="btn-thermal" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">Thermal</button>
                    <button onclick="toggleInvoiceType('a4')" id="btn-a4" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs">A4/A5</button>
                </div>
            </div>

            <div id="print-section" class="p-4 bg-white text-black text-sm mx-auto w-[80mm]">
                <div class="text-center mb-2">
                    <img id="thermal-logo" src="" class="h-10 mx-auto mb-1 hidden">
                    <h1 class="font-bold text-xl shop-name-display">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®</h1>
                    <p class="text-xs">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá</p>
                    <p class="text-xs">‡¶´‡ßã‡¶®: ‡ß¶‡ßß‡ß≠XXXXXXXX</p>
                </div>
                <div class="border-t border-b border-black py-1 my-2 flex justify-between">
                    <span>‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Æ‡ßá‡¶Æ‡ßã</span>
                    <span class="invoice-date-print"></span>
                </div>
                <div id="print-content"></div>
                <div class="border-t border-black mt-2 pt-2 text-[10px]">
                    <p class="invoice-note italic"></p>
                </div>
                <div class="mt-4 flex flex-col items-center">
                    <img class="invoice-qr w-20 h-20 mb-1" src="">
                </div>
                <p class="text-center mt-4 text-xs italic">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶, ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶∏‡¶¨‡ßá‡¶®!</p>
            </div>

            <div id="a4-print-section" class="hidden p-8 bg-white text-black">
                <div class="flex justify-between items-start mb-8">
                    <div>
                        <img id="a4-logo" src="" class="h-16 mb-2 hidden">
                        <h1 class="text-3xl font-bold shop-name-display text-indigo-700">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®</h1>
                        <p>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá</p>
                        <p>‡¶´‡ßã‡¶®: ‡ß¶‡ßß‡ß≠XXXXXXXX</p>
                    </div>
                    <div class="text-right">
                        <h2 class="text-2xl font-bold text-gray-400 uppercase">Invoice</h2>
                        <p class="font-bold">‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶®‡¶Ç: <span id="a4-inv-no"></span></p>
                        <p>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: <span class="invoice-date-print"></span></p>
                    </div>
                </div>
                <div class="mb-6 pb-4 border-b">
                    <h3 class="font-bold text-gray-700">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏:</h3>
                    <p id="a4-cust-name"></p>
                    <p id="a4-cust-phone"></p>
                </div>
                <table class="w-full a4-table mb-6">
                    <thead class="bg-gray-100">
                        <tr><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th><th>‡¶¶‡¶∞</th><th>‡¶Æ‡ßã‡¶ü</th></tr>
                    </thead>
                    <tbody id="a4-table-body"></tbody>
                </table>
                <div class="flex justify-end">
                    <div class="w-64 space-y-2">
                        <div class="flex justify-between"><span>‡¶∏‡¶æ‡¶¨-‡¶ü‡ßã‡¶ü‡¶æ‡¶≤:</span><span id="a4-subtotal"></span></div>
                        <div class="flex justify-between"><span>‡¶≠‡ßç‡¶Ø‡¶æ‡¶ü:</span><span id="a4-vat"></span></div>
                        <div class="flex justify-between"><span>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü:</span><span id="a4-discount"></span></div>
                        <div class="flex justify-between font-bold border-t pt-2 text-xl"><span>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤:</span><span id="a4-total"></span></div>
                    </div>
                </div>
                <div class="mt-20 flex justify-between">
                    <div class="border-t border-black w-48 text-center pt-1">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞</div>
                    <div class="border-t border-black w-48 text-center pt-1">‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</div>
                </div>
            </div>

            <div class="flex flex-wrap gap-2 mt-6 no-print">
                <button onclick="closeModal('invoicePreviewModal')" class="flex-1 bg-gray-500 text-white py-2 rounded font-bold">‡¶¨‡¶®‡ßç‡¶ß</button>
                <button onclick="window.print()" class="flex-1 bg-indigo-600 text-white py-2 rounded font-bold">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                <button onclick="sendWhatsApp()" class="w-full bg-green-500 text-white py-2 rounded font-bold"><i class="fab fa-whatsapp"></i> ‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Profit Report Modal -->
    <div id="profitReportModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-2/3 p-6 shadow-xl modal-content">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2>
            <div class="flex gap-2 mb-4">
                <input type="date" id="report-start" class="border p-2 rounded text-sm">
                <input type="date" id="report-end" class="border p-2 rounded text-sm">
                <button onclick="generateDetailedReport()" class="bg-indigo-600 text-white px-4 rounded text-sm">‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</button>
                <button onclick="downloadPDFReport()" class="bg-red-600 text-white px-4 rounded text-sm"><i class="fas fa-file-pdf"></i> PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
            </div>
            <div id="report-result" class="space-y-2"></div>
            <div class="flex justify-end mt-6">
                <button onclick="closeModal('profitReportModal')" class="bg-gray-400 text-white px-4 py-2 rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Product List Modal -->
    <div id="productListModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-4/5 max-h-[90vh] p-6 shadow-xl flex flex-col modal-content">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-xl font-bold">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h2>
                <button onclick="closeModal('productListModal')" class="text-red-500 font-bold text-2xl">&times;</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse min-w-[600px]">
                    <thead>
                        <tr class="bg-gray-100 border-b text-gray-700">
                            <th class="p-3">‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶°/‡¶®‡¶æ‡¶Æ</th>
                            <th class="p-3">‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                            <th class="p-3">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                            <th class="p-3">‡¶∏‡ßç‡¶ü‡¶ï/‡¶Æ‡ßá‡ßü‡¶æ‡¶¶</th>
                            <th class="p-3 text-center">‡¶è‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="full-product-list" class="text-gray-600"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/3 p-6 shadow-xl modal-content">
            <h2 id="productModalTitle" class="text-xl font-bold mb-4 border-b pb-2">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            <div class="space-y-4">
                <input type="hidden" id="p-index">
                <div class="flex gap-1">
                    <input type="text" id="p-barcode" placeholder="‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶°" class="flex-1 border p-2 rounded">
                    <button onclick="generateRandomBarcode()" class="bg-gray-200 px-2 rounded text-xs">‡¶Ö‡¶ü‡ßã</button>
                </div>
                <input type="text" id="p-name" placeholder="‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full border p-2 rounded">
                
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="p-buy" placeholder="‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="w-full border p-2 rounded">
                    <input type="number" id="p-sell" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="w-full border p-2 rounded">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="p-qty" placeholder="‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" class="w-full border p-2 rounded">
                    <select id="p-unit" class="w-full border p-2 rounded">
                        <option value="Pcs">Pcs (‡¶™‡¶ø‡¶∏)</option>
                        <option value="Kg">Kg (‡¶ï‡ßá‡¶ú‡¶ø)</option>
                        <option value="Ltr">Ltr (‡¶≤‡¶ø‡¶ü‡¶æ‡¶∞)</option>
                        <option value="Pkt">Pkt (‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü)</option>
                        <option value="Gm">Gm (‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ)</option>
                        <option value="Dozen">Dozen (‡¶°‡¶ú‡¶®)</option>
                    </select>
                </div>

                <div class="text-xs text-gray-500">‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡ßÄ‡¶∞‡ßç‡¶£‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</div>
                <input type="date" id="p-expiry" class="w-full border p-2 rounded">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('productModal')" class="bg-gray-400 text-white px-4 py-2 rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button onclick="addProduct()" class="bg-indigo-600 text-white px-4 py-2 rounded">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="bg-white rounded-lg w-11/12 md:w-1/3 p-6 shadow-xl modal-content">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 text-red-600">‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            <div class="space-y-4">
                <input type="date" id="exp-date" class="w-full border p-2 rounded">
                <input type="text" id="exp-title" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£" class="w-full border p-2 rounded">
                <input type="number" id="exp-amount" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" class="w-full border p-2 rounded">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('expenseModal')" class="bg-gray-400 text-white px-4 py-2 rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button onclick="addExpense()" class="bg-red-600 text-white px-4 py-2 rounded">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <div id="barcode-print-area" class="hidden"></div>
    <div id="bulk-barcode-print-area" class="hidden"></div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let currentUserRole = null;
        let currentUserOwner = null;
        let currentUserPermissions = {};
        let users = [];
        let pendingUsers = [];
        let products = [];
        let salesRecords = [];
        let expenses = [];
        let stockHistory = [];
        let customers = {};
        let suppliers = [];
        let cart = [];
        let totalSales = 0, totalProfit = 0, totalExpense = 0, totalDue = 0, totalStockValue = 0;
        let invoiceCount = 1;
        let config = { 
            shopName: "‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®", 
            vat: 5, 
            invoiceNote: "‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶§ ‡¶Æ‡¶æ‡¶≤ ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü ‡¶®‡¶æ‡•§", 
            logo: "" 
        };
        let isMobileMenuOpen = false;

        // ==================== INITIALIZATION ====================
        function initializeSystem() {
            const storedUsers = localStorage.getItem('all_users');
            if (storedUsers) {
                users = JSON.parse(storedUsers);
            } else {
                users = [{ 
                    username: 'admin', 
                    password: 'admin', 
                    role: 'admin',
                    approved: true,
                    createdAt: new Date().toISOString()
                }];
                localStorage.setItem('all_users', JSON.stringify(users));
            }
            
            const storedPending = localStorage.getItem('pending_owners');
            if (storedPending) {
                pendingUsers = JSON.parse(storedPending);
            } else {
                pendingUsers = [];
                localStorage.setItem('pending_owners', JSON.stringify(pendingUsers));
            }
            
            const savedLayout = localStorage.getItem('layout_preference');
            if (savedLayout === 'desktop' || savedLayout === 'mobile') {
                document.body.setAttribute('data-layout', savedLayout);
            }
        }

        function getUserStorageKey(baseKey) {
            if (!currentUser) return baseKey;
            if (currentUserRole === 'staff' && currentUserOwner) {
                return `${currentUserOwner}_${baseKey}`;
            }
            return `${currentUser}_${baseKey}`;
        }

        // ==================== AUTH FUNCTIONS ====================
        function toggleAuthForms() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('signup-form').classList.toggle('hidden');
        }

        function handleOwnerSignup() {
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-pass').value.trim();
            const shopName = document.getElementById('reg-shop-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            
            if (!username || !password || !shopName || !phone) {
                showToast("‚ö†Ô∏è ‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®", "error");
                return;
            }

            if (username.length < 3) {
                showToast("‚ö†Ô∏è ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß© ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá", "error");
                return;
            }

            if (password.length < 4) {
                showToast("‚ö†Ô∏è ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß™ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá", "error");
                return;
            }

            if (users.some(u => u.username === username)) {
                showToast("‚ùå ‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§!", "error");
                return;
            }

            if (pendingUsers.some(u => u.username === username)) {
                showToast("‚è≥ ‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠‡¶æ‡¶≤‡ßá‡¶∞ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶õ‡ßá!", "warning");
                return;
            }

            pendingUsers.push({ 
                username, 
                password,
                shopName,
                phone,
                role: 'owner',
                registeredAt: new Date().toISOString(),
                status: 'pending'
            });
            
            localStorage.setItem('pending_owners', JSON.stringify(pendingUsers));
            showToast("‚úÖ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶´‡¶≤! ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠‡¶æ‡¶≤‡ßá‡¶∞ ‡¶™‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§", "success");
            
            document.getElementById('reg-username').value = '';
            document.getElementById('reg-pass').value = '';
            document.getElementById('reg-shop-name').value = '';
            document.getElementById('reg-phone').value = '';
            toggleAuthForms();
            
            if (currentUser === 'admin') {
                updatePendingBadge();
            }
        }

        function handleLogin() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-pass').value.trim();

            if (!username || !password) {
                showToast("‚ö†Ô∏è ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®", "error");
                return;
            }

            if (username === 'admin' && password === 'admin') {
                currentUser = 'admin';
                currentUserRole = 'admin';
                currentUserOwner = null;
                currentUserPermissions = {};
                localStorage.setItem('currentUser', 'admin');
                localStorage.setItem('currentUserRole', 'admin');
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                updateUserDisplay();
                loadUserData();
                showToast("‚úÖ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤!", "success");
                return;
            }

            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                if (!user.approved) {
                    showToast("‚è≥ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠‡¶æ‡¶≤‡ßá‡¶∞ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶õ‡ßá!", "warning");
                    return;
                }
                
                currentUser = username;
                currentUserRole = user.role;
                currentUserOwner = user.owner || null;
                currentUserPermissions = user.permissions || {};
                
                localStorage.setItem('currentUser', username);
                localStorage.setItem('currentUserRole', user.role);
                if (user.owner) localStorage.setItem('currentUserOwner', user.owner);
                if (user.permissions) localStorage.setItem('currentUserPermissions', JSON.stringify(user.permissions));
                
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                updateUserDisplay();
                loadUserData();
                applyPermissions();
                showToast(`‚úÖ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ ${user.name || username}!`, "success");
            } else {
                showToast("‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!", "error");
            }
        }

        function handleLogout() {
            currentUser = null;
            currentUserRole = null;
            currentUserOwner = null;
            currentUserPermissions = {};
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentUserRole');
            localStorage.removeItem('currentUserOwner');
            localStorage.removeItem('currentUserPermissions');
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('auth-username').value = '';
            document.getElementById('auth-pass').value = '';
            closeMobileMenu();
            showToast("üëã ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®", "info");
        }

        function updateUserDisplay() {
            const displayName = currentUser === 'admin' ? '‡¶è‡¶°‡¶Æ‡¶ø‡¶®' : currentUser;
            const roleText = currentUserRole === 'admin' ? '‡¶è‡¶°‡¶Æ‡¶ø‡¶®' : (currentUserRole === 'owner' ? '‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï' : '‡¶∏‡ßç‡¶ü‡¶æ‡¶´');
            
            document.querySelectorAll('#current-username-header, #current-username-sidebar, #current-username-mobile').forEach(el => {
                if (el) el.innerText = displayName;
            });
            
            document.querySelectorAll('#user-role-badge-header, #user-role-badge-sidebar, #user-role-badge-mobile').forEach(el => {
                if (el) {
                    el.innerText = roleText;
                    el.className = `text-xs ${currentUserRole === 'owner' ? 'owner-badge' : (currentUserRole === 'staff' ? 'staff-badge' : 'bg-purple-600')} px-2 py-1 rounded-full`;
                }
            });
            
            if (currentUserRole === 'owner' || currentUserRole === 'admin') {
                document.body.classList.add('role-owner');
                document.body.classList.remove('role-staff');
            } else {
                document.body.classList.add('role-staff');
                document.body.classList.remove('role-owner');
            }
        }

        function applyPermissions() {
            if (currentUserRole !== 'staff') return;
            
            const menuProductList = document.getElementById('menu-product-list');
            const menuDueCollection = document.getElementById('menu-due-collection');
            const menuReturn = document.getElementById('menu-return');
            const menuPos = document.getElementById('menu-pos');
            const menuDailyClosing = document.getElementById('menu-daily-closing');
            
            if (menuProductList) menuProductList.style.display = currentUserPermissions.productList ? 'block' : 'none';
            if (menuDueCollection) menuDueCollection.style.display = currentUserPermissions.dueCollection ? 'block' : 'none';
            if (menuReturn) menuReturn.style.display = currentUserPermissions.return ? 'block' : 'none';
            if (menuPos) menuPos.style.display = currentUserPermissions.pos ? 'block' : 'none';
            if (menuDailyClosing) menuDailyClosing.style.display = currentUserPermissions.dailyClosing ? 'block' : 'none';
            
            document.querySelectorAll('.owner-only').forEach(el => el.style.display = 'none');
            const resetBtn = document.getElementById('reset-data-btn');
            if (resetBtn) resetBtn.style.display = 'none';
            
            // Store permissions in localStorage for persistence
            localStorage.setItem('currentUserPermissions', JSON.stringify(currentUserPermissions));
        }

        // ==================== STAFF MANAGEMENT ====================
        function addStaff() {
            if (currentUserRole !== 'owner') {
                showToast("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®!", "error");
                return;
            }
            
            const username = document.getElementById('staff-username').value.trim();
            const password = document.getElementById('staff-password').value.trim();
            const name = document.getElementById('staff-name').value.trim();
            const phone = document.getElementById('staff-phone').value.trim();
            
            if (!username || !password || !name) {
                showToast("‚ö†Ô∏è ‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®", "error");
                return;
            }
            
            if (users.some(u => u.username === username)) {
                showToast("‚ùå ‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§!", "error");
                return;
            }
            
            const permissions = {
                pos: document.getElementById('perm-pos').checked,
                productList: document.getElementById('perm-product-list').checked,
                dueCollection: document.getElementById('perm-due-collection').checked,
                return: document.getElementById('perm-return').checked,
                dailyClosing: document.getElementById('perm-daily-closing').checked,
                customerView: document.getElementById('perm-customer-view').checked,
                productAdd: document.getElementById('perm-product-add').checked,
                productEdit: document.getElementById('perm-product-edit').checked,
                expenseView: document.getElementById('perm-expense-view').checked
            };
            
            const staffUser = {
                username,
                password,
                name,
                phone,
                role: 'staff',
                owner: currentUser,
                permissions,
                approved: true,
                createdAt: new Date().toISOString(),
                createdBy: currentUser
            };
            
            users.push(staffUser);
            localStorage.setItem('all_users', JSON.stringify(users));
            
            document.getElementById('staff-username').value = '';
            document.getElementById('staff-password').value = '';
            document.getElementById('staff-name').value = '';
            document.getElementById('staff-phone').value = '';
            
            renderStaffList();
            showToast(`‚úÖ ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ${name} ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!`, "success");
        }

        function renderStaffList() {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') return;
            
            const staffList = users.filter(u => u.role === 'staff' && u.owner === currentUser);
            const listDiv = document.getElementById('staff-list');
            if (!listDiv) return;
            
            if (staffList.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-4">‡¶ï‡ßã‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶®‡ßá‡¶á</p>';
            } else {
                listDiv.innerHTML = staffList.map(staff => `
                    <div class="bg-white p-4 rounded-lg border hover:shadow-md transition-all">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="mb-2 md:mb-0">
                                <div class="flex items-center gap-2">
                                    <p class="font-bold text-lg">${staff.name}</p>
                                    <span class="staff-badge text-xs">‡¶∏‡ßç‡¶ü‡¶æ‡¶´</span>
                                </div>
                                <p class="text-sm text-gray-600">@${staff.username}</p>
                                <p class="text-xs text-gray-500">‡¶´‡ßã‡¶®: ${staff.phone || 'N/A'}</p>
                                <p class="text-xs text-gray-500">‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§: ${new Date(staff.createdAt).toLocaleDateString('bn-BD')}</p>
                            </div>
                            <div class="flex gap-2 mt-2 md:mt-0">
                                <button onclick="openPermissionEditModal('${staff.username}')" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-all touch-target">
                                    <i class="fas fa-edit mr-1"></i> ‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶®
                                </button>
                                <button onclick="removeStaff('${staff.username}')" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition-all touch-target">
                                    <i class="fas fa-trash mr-1"></i> ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠
                                </button>
                            </div>
                        </div>
                        <div class="mt-3 flex flex-wrap gap-1">
                            ${Object.entries(staff.permissions || {}).map(([key, value]) => 
                                value ? `<span class="permission-chip active">${getPermissionName(key)}</span>` : ''
                            ).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }

        function getPermissionName(key) {
            const names = {
                pos: 'POS',
                productList: '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü',
                dueCollection: '‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü',
                return: '‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®',
                dailyClosing: '‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç',
                customerView: '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ',
                productAdd: '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°',
                productEdit: '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü',
                expenseView: '‡¶ñ‡¶∞‡¶ö ‡¶¶‡ßá‡¶ñ‡¶æ'
            };
            return names[key] || key;
        }

        function openPermissionEditModal(username) {
            const staff = users.find(u => u.username === username);
            if (!staff) return;
            
            document.getElementById('edit-staff-username').value = staff.username;
            document.getElementById('edit-staff-username-display').value = staff.username;
            document.getElementById('edit-staff-name').value = staff.name || '';
            document.getElementById('edit-staff-phone').value = staff.phone || '';
            
            document.getElementById('edit-perm-pos').checked = staff.permissions?.pos || false;
            document.getElementById('edit-perm-product-list').checked = staff.permissions?.productList || false;
            document.getElementById('edit-perm-due-collection').checked = staff.permissions?.dueCollection || false;
            document.getElementById('edit-perm-return').checked = staff.permissions?.return || false;
            document.getElementById('edit-perm-daily-closing').checked = staff.permissions?.dailyClosing || false;
            document.getElementById('edit-perm-customer-view').checked = staff.permissions?.customerView || false;
            document.getElementById('edit-perm-product-add').checked = staff.permissions?.productAdd || false;
            document.getElementById('edit-perm-product-edit').checked = staff.permissions?.productEdit || false;
            document.getElementById('edit-perm-expense-view').checked = staff.permissions?.expenseView || false;
            
            openModal('permissionEditModal');
        }

        function saveStaffPermissions() {
            const username = document.getElementById('edit-staff-username').value;
            const name = document.getElementById('edit-staff-name').value.trim();
            const phone = document.getElementById('edit-staff-phone').value.trim();
            
            const staffIndex = users.findIndex(u => u.username === username);
            if (staffIndex === -1) return;
            
            const permissions = {
                pos: document.getElementById('edit-perm-pos').checked,
                productList: document.getElementById('edit-perm-product-list').checked,
                dueCollection: document.getElementById('edit-perm-due-collection').checked,
                return: document.getElementById('edit-perm-return').checked,
                dailyClosing: document.getElementById('edit-perm-daily-closing').checked,
                customerView: document.getElementById('edit-perm-customer-view').checked,
                productAdd: document.getElementById('edit-perm-product-add').checked,
                productEdit: document.getElementById('edit-perm-product-edit').checked,
                expenseView: document.getElementById('edit-perm-expense-view').checked
            };
            
            users[staffIndex].name = name;
            users[staffIndex].phone = phone;
            users[staffIndex].permissions = permissions;
            
            localStorage.setItem('all_users', JSON.stringify(users));
            
            closeModal('permissionEditModal');
            renderStaffList();
            
            if (currentUser === username) {
                currentUserPermissions = permissions;
                applyPermissions();
                localStorage.setItem('currentUserPermissions', JSON.stringify(permissions));
            }
            
            showToast(`‚úÖ ${username} ‡¶è‡¶∞ ‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶∂‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!`, "success");
        }

        function removeStaff(username) {
            if (!confirm(`${username} ‡¶ï‡ßá ‡¶∏‡ßç‡¶ü‡¶æ‡¶´ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶¨‡ßá‡¶®?`)) return;
            
            const index = users.findIndex(u => u.username === username);
            if (index !== -1) {
                users.splice(index, 1);
                localStorage.setItem('all_users', JSON.stringify(users));
                renderStaffList();
                showToast(`‚úÖ ${username} ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, "success");
            }
        }

        // ==================== ADMIN FUNCTIONS ====================
        function updatePendingBadge() {
            if (currentUserRole !== 'admin') return;
            const pendingCount = pendingUsers.length;
            const badge = document.getElementById('pending-badge');
            
            if (pendingCount > 0) {
                if (badge) {
                    badge.classList.remove('hidden');
                    badge.innerText = `${pendingCount} new`;
                }
            } else {
                if (badge) badge.classList.add('hidden');
            }
        }

        function openAdminApprovalModal() {
            if (currentUserRole !== 'admin') {
                showToast("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶è‡¶á ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®!", "error");
                return;
            }
            
            const listDiv = document.getElementById('pending-users-list');
            
            if (pendingUsers.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">‚úÖ ‡¶ï‡ßã‡¶® ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶®‡ßá‡¶á</p>';
            } else {
                listDiv.innerHTML = pendingUsers.map((user, index) => `
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between border-b pb-3 hover:bg-gray-50 p-3 rounded">
                        <div class="flex-1 mb-2 md:mb-0">
                            <p class="font-bold text-lg">${user.username}</p>
                            <p class="text-sm">‡¶¶‡ßã‡¶ï‡¶æ‡¶®: ${user.shopName}</p>
                            <p class="text-xs">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${user.phone}</p>
                            <p class="text-xs text-gray-500">
                                <i class="far fa-clock"></i> ‡¶∞‡ßá‡¶ú‡¶ø: ${new Date(user.registeredAt).toLocaleString('bn-BD')}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="approveOwner(${index})" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-all touch-target">
                                <i class="fas fa-check"></i> ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠
                            </button>
                            <button onclick="rejectOwner(${index})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm transition-all touch-target">
                                <i class="fas fa-times"></i> ‡¶∞‡¶ø‡¶ú‡ßá‡¶ï‡ßç‡¶ü
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            openModal('adminApprovalModal');
        }

        function approveOwner(index) {
            if (!confirm(`${pendingUsers[index].username} ‡¶ï‡ßá ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`)) return;
            
            const user = pendingUsers[index];
            
            users.push({ 
                username: user.username, 
                password: user.password,
                shopName: user.shopName,
                phone: user.phone,
                role: 'owner',
                approved: true,
                approvedAt: new Date().toISOString(),
                approvedBy: currentUser
            });
            
            pendingUsers.splice(index, 1);
            
            localStorage.setItem('all_users', JSON.stringify(users));
            localStorage.setItem('pending_owners', JSON.stringify(pendingUsers));
            
            const emptyData = [];
            localStorage.setItem(`${user.username}_shop_products`, JSON.stringify(emptyData));
            localStorage.setItem(`${user.username}_shop_sales`, JSON.stringify(emptyData));
            localStorage.setItem(`${user.username}_shop_expense_list`, JSON.stringify(emptyData));
            
            updatePendingBadge();
            openAdminApprovalModal();
            showToast(`‚úÖ ${user.username} ‡¶è‡¶™‡ßç‡¶∞‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`, "success");
        }

        function rejectOwner(index) {
            if (!confirm(`${pendingUsers[index].username} ‡¶ï‡ßá ‡¶∞‡¶ø‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`)) return;
            pendingUsers.splice(index, 1);
            localStorage.setItem('pending_owners', JSON.stringify(pendingUsers));
            updatePendingBadge();
            openAdminApprovalModal();
            showToast(`‚ùå ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, "info");
        }

        // ==================== UI FUNCTIONS ====================
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            isMobileMenuOpen = !isMobileMenuOpen;
            
            if (isMobileMenuOpen) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('mobile-menu-active');
                document.body.style.overflow = 'hidden';
            } else {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('mobile-menu-active');
                document.body.style.overflow = '';
            }
        }

        function closeMobileMenu() {
            if (window.innerWidth < 768 && isMobileMenuOpen) {
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('mobile-menu-active');
                isMobileMenuOpen = false;
                document.body.style.overflow = '';
            }
        }

        window.addEventListener('resize', function() {
            if (window.innerWidth >= 768) {
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('sidebar').classList.remove('mobile-menu-active');
                isMobileMenuOpen = false;
                document.body.style.overflow = '';
            }
        });

        function openModal(id) { 
            if(id === 'productModal' && !document.getElementById('p-index').value) {
                document.getElementById('productModalTitle').innerText = "‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®";
            }
            
            if (currentUserRole === 'staff') {
                if (id === 'productModal' && !currentUserPermissions.productAdd) {
                    showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶á ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                    return;
                }
                if (id === 'expenseModal' && !currentUserPermissions.expenseView) {
                    showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶á ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                    return;
                }
                if (id === 'profitReportModal' && !currentUserPermissions.dailyClosing) {
                    showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶á ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                    return;
                }
            }
            
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = 'flex';
                
                if(id === 'productListModal') renderFullProductList(); 
                if(id === 'dueCollectionModal') searchDueRecords();
                if(id === 'bulkBarcodeModal') prepareBulkBarcodeSelect();
                
                if(id === 'posModal') {
                    document.getElementById('vat-rate-label').innerText = config.vat;
                    const barcodeInput = document.getElementById('barcode-input');
                    if(barcodeInput) barcodeInput.focus();
                    renderCustomerDatalist();
                }
                
                if(id === 'staffManagementModal') {
                    renderStaffList();
                }
            }
        }

        function closeModal(id) { 
            const modal = document.getElementById(id);
            if (modal) {
                if(id === 'productModal') {
                    document.getElementById('p-index').value = "";
                    document.getElementById('p-barcode').value = "";
                    document.getElementById('p-name').value = "";
                    document.getElementById('p-buy').value = "";
                    document.getElementById('p-sell').value = "";
                    document.getElementById('p-qty').value = "";
                    document.getElementById('p-expiry').value = "";
                    document.getElementById('p-unit').value = "Pcs";
                }
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // ==================== TOAST NOTIFICATION ====================
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle')} text-${type === 'success' ? 'green' : (type === 'error' ? 'red' : 'blue')}-500"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ==================== DATA LOAD/SAVE ====================
        function loadUserData() {
            const storedProducts = localStorage.getItem(getUserStorageKey('shop_products'));
            const storedSales = localStorage.getItem(getUserStorageKey('shop_sales'));
            const storedExpense = localStorage.getItem(getUserStorageKey('shop_expense_list'));
            const storedStockHistory = localStorage.getItem(getUserStorageKey('shop_stock_history'));
            const storedCustomers = localStorage.getItem(getUserStorageKey('shop_customers'));
            const storedSuppliers = localStorage.getItem(getUserStorageKey('shop_suppliers'));
            const storedConfig = localStorage.getItem(getUserStorageKey('shop_config'));
            const storedInvoiceCount = localStorage.getItem(getUserStorageKey('shop_invoice_count'));

            if (storedProducts) products = JSON.parse(storedProducts);
            else products = [];
            
            if (storedSales) salesRecords = JSON.parse(storedSales);
            else salesRecords = [];
            
            if (storedExpense) expenses = JSON.parse(storedExpense);
            else expenses = [];
            
            if (storedStockHistory) stockHistory = JSON.parse(storedStockHistory);
            else stockHistory = [];
            
            if (storedCustomers) customers = JSON.parse(storedCustomers);
            else customers = {};
            
            if (storedSuppliers) suppliers = JSON.parse(storedSuppliers);
            else suppliers = [];
            
            if (storedConfig) config = JSON.parse(storedConfig);
            else config = { shopName: "‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®", vat: 5, invoiceNote: "‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶§ ‡¶Æ‡¶æ‡¶≤ ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü ‡¶®‡¶æ‡•§", logo: "" };
            
            if (storedInvoiceCount) invoiceCount = parseInt(storedInvoiceCount);
            else invoiceCount = 1;

            applyConfig();
            calculateDashboardStats();
            renderPOSProducts();
            renderRecentSales();
            initCharts();
            renderStockHistory();
            renderSupplierList();
            
            if (currentUserRole === 'admin') {
                updatePendingBadge();
            }
            
            if (currentUserRole === 'owner') {
                renderStaffList();
            }
        }

        function saveToStorage() {
            if (!currentUser) return;
            localStorage.setItem(getUserStorageKey('shop_products'), JSON.stringify(products));
            localStorage.setItem(getUserStorageKey('shop_sales'), JSON.stringify(salesRecords));
            localStorage.setItem(getUserStorageKey('shop_expense_list'), JSON.stringify(expenses));
            localStorage.setItem(getUserStorageKey('shop_invoice_count'), invoiceCount.toString());
            localStorage.setItem(getUserStorageKey('shop_customers'), JSON.stringify(customers));
            localStorage.setItem(getUserStorageKey('shop_suppliers'), JSON.stringify(suppliers));
            localStorage.setItem(getUserStorageKey('shop_stock_history'), JSON.stringify(stockHistory));
            localStorage.setItem(getUserStorageKey('shop_config'), JSON.stringify(config));
        }

        // ==================== PRODUCT FUNCTIONS ====================
        function addProduct() {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
                if (!currentUserPermissions.productAdd) {
                    showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                    return;
                }
            }
            
            let index = document.getElementById('p-index').value;
            let barcode = document.getElementById('p-barcode').value;
            let name = document.getElementById('p-name').value;
            let buy = parseFloat(document.getElementById('p-buy').value) || 0;
            let sell = parseFloat(document.getElementById('p-sell').value) || 0;
            let qty = parseFloat(document.getElementById('p-qty').value) || 0;
            let unit = document.getElementById('p-unit').value;
            let expiry = document.getElementById('p-expiry').value;
            
            if(!name) {
                showToast("‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®", "error");
                return;
            }

            let productData = { barcode, name, buy, sell, qty, unit, expiry };

            if(index !== "") {
                products[index] = productData;
                logStock(name, '‡¶è‡¶°‡¶ú‡¶æ‡¶∏‡ßç‡¶ü/‡¶Ü‡¶™‡¶°‡ßá‡¶ü', qty, unit);
                showToast("‚úÖ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
            } else {
                products.push(productData);
                logStock(name, '‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®', qty, unit);
                showToast("‚úÖ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
            }
            
            saveToStorage();
            calculateDashboardStats();
            renderPOSProducts();
            closeModal('productModal');
        }

        function editProduct(index) {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
                if (!currentUserPermissions.productEdit) {
                    showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                    return;
                }
            }
            let p = products[index];
            document.getElementById('p-index').value = index;
            document.getElementById('p-barcode').value = p.barcode || "";
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-buy').value = p.buy;
            document.getElementById('p-sell').value = p.sell;
            document.getElementById('p-qty').value = p.qty;
            document.getElementById('p-unit').value = p.unit || "Pcs";
            document.getElementById('p-expiry').value = p.expiry || "";
            document.getElementById('productModalTitle').innerText = "‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®";
            openModal('productModal');
        }

        function deleteProduct(index) {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
                showToast("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®!", "error");
                return;
            }
            if(confirm("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) {
                products.splice(index, 1);
                saveToStorage();
                renderFullProductList();
                calculateDashboardStats();
                renderPOSProducts();
                showToast("‚úÖ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
            }
        }

        function renderFullProductList() {
            const list = document.getElementById('full-product-list');
            if(!list) return;
            list.innerHTML = products.map((p, index) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-2 md:p-3">
                        <span class="text-xs text-gray-400">#${p.barcode || 'N/A'}</span><br>
                        <span class="font-medium ${p.qty < 5 ? 'text-red-500 font-bold' : ''}">${p.name}</span>
                    </td>
                    <td class="p-2 md:p-3">‡ß≥ ${p.buy}</td>
                    <td class="p-2 md:p-3">‡ß≥ ${p.sell}</td>
                    <td class="p-2 md:p-3">
                        ${p.qty} ${p.unit || 'Pcs'} ${p.qty < 5 ? '‚ö†Ô∏è' : ''}<br>
                        <span class="text-[10px] text-gray-500">${p.expiry || 'No Expiry'}</span>
                    </td>
                    <td class="p-2 md:p-3 text-center">
                        <button onclick="printBarcode('${p.barcode}','${p.name}',${p.sell})" title="‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü" class="text-gray-500 p-1 hover:text-indigo-600 transition-all touch-target">
                            <i class="fas fa-barcode"></i>
                        </button>
                        <button onclick="editProduct(${index})" class="text-blue-500 p-1 hover:text-blue-700 transition-all touch-target">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteProduct(${index})" class="text-red-500 p-1 hover:text-red-700 transition-all touch-target ${currentUserRole === 'staff' && !currentUserPermissions.productEdit ? 'hidden' : ''}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderPOSProducts() {
            let list = document.getElementById('pos-product-list');
            if(!list) return;
            list.innerHTML = products.map((p, index) => `
                <div onclick="addToCart(${index})" class="product-card ${p.qty <= 0 ? 'out-of-stock' : ''}">
                    <p class="font-bold truncate">${p.name}</p>
                    <p class="text-indigo-600 font-bold">‡ß≥ ${p.sell}</p>
                    <p class="text-xs ${p.qty < 5 ? 'text-red-500 font-bold' : 'text-gray-400'}">
                        ‡¶∏‡ßç‡¶ü‡¶ï: ${p.qty} ${p.unit || ''}
                    </p>
                </div>
            `).join('');
        }

        function generateRandomBarcode() {
            document.getElementById('p-barcode').value = Math.floor(Math.random() * 9000000000000) + 1000000000000;
        }

        function printBarcode(barcode, name, price) {
            const area = document.getElementById('barcode-print-area');
            area.innerHTML = `
                <div style="text-align:center; padding:10px; border:1px solid #000; width:40mm;">
                    <p style="font-size:10px; margin:0;">${config.shopName}</p>
                    <p style="font-size:12px; font-weight:bold; margin:0;">${name}</p>
                    <img src="https://bwipjs-api.metafloor.com/?bcid=code128&text=${barcode}&scale=1&rotate=N" style="width:35mm;">
                    <p style="font-size:12px; margin:0;">Price: ‡ß≥${price}</p>
                </div>
            `;
            window.print();
        }

        function prepareBulkBarcodeSelect() {
            let select = document.getElementById('bulk-p-select');
            if(!select) return;
            select.innerHTML = '<option value="">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>' + 
                products.map((p, idx) => `<option value="${idx}">${p.name} (‡¶∏‡ßç‡¶ü‡¶ï: ${p.qty})</option>`).join('');
        }

        function generateBulkBarcodes() {
            let idx = document.getElementById('bulk-p-select').value;
            let qty = parseInt(document.getElementById('bulk-p-qty').value) || 0;
            if(idx === "" || qty <= 0) {
                showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶ì ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®‡•§", "error");
                return;
            }

            let p = products[idx];
            if(!p.barcode) {
                showToast("‡¶è‡¶á ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° ‡¶®‡ßá‡¶á! ‡¶Ü‡¶ó‡ßá ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° ‡¶è‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "error");
                return;
            }

            let area = document.getElementById('bulk-barcode-print-area');
            let content = "";

            for(let i=0; i < qty; i++) {
                content += `
                    <div style="text-align:center; padding:5px; border:1px solid #ccc; width:45mm; height:30mm; margin:2px; display:inline-block; page-break-inside: avoid;">
                        <p style="font-size:8px; margin:0; overflow:hidden; white-space:nowrap;">${config.shopName}</p>
                        <p style="font-size:10px; font-weight:bold; margin:0; overflow:hidden; white-space:nowrap;">${p.name}</p>
                        <img src="https://bwipjs-api.metafloor.com/?bcid=code128&text=${p.barcode}&scale=1&rotate=N" style="width:38mm; height:12mm;">
                        <p style="font-size:10px; margin:0; font-weight:bold;">Price: ‡ß≥ ${p.sell}</p>
                    </div>
                `;
            }
            area.innerHTML = content;
            window.print();
        }

        function filterPOSProducts() {
            let query = document.getElementById('pos-search').value.toLowerCase();
            let items = document.getElementById('pos-product-list').children;
            for(let item of items) {
                let name = item.querySelector('p').innerText.toLowerCase();
                item.style.display = name.includes(query) ? 'block' : 'none';
            }
        }

        // ==================== CART FUNCTIONS ====================
        function addToCart(index) {
            let p = products[index];
            if(p.qty <= 0) {
                showToast("‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡ßá‡¶∑!", "error");
                return;
            }
            
            let existingItem = cart.find(item => item.originalIndex === index);
            if(existingItem) {
                if(existingItem.orderQty < p.qty) {
                    existingItem.orderQty++;
                } else {
                    showToast("‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡ßü!", "warning");
                }
            } else {
                cart.push({...p, originalIndex: index, orderQty: 1});
            }
            renderCart();
        }

        function updateCartQty(index, newQty) {
            let qty = parseFloat(newQty) || 0;
            let originalP = products[cart[index].originalIndex];
            
            if(qty > originalP.qty) {
                showToast("‡¶∏‡ßç‡¶ü‡¶ï ‡¶´‡ßÅ‡¶∞‡¶ø‡ßü‡ßá ‡¶ó‡ßá‡¶õ‡ßá!", "warning");
                qty = originalP.qty;
            }
            
            if(qty <= 0) {
                cart.splice(index, 1);
            } else {
                cart[index].orderQty = qty;
            }
            renderCart();
        }

        function renderCart() {
            let cartDiv = document.getElementById('cart-items');
            let subtotal = 0;
            let discount = parseFloat(document.getElementById('pos-discount').value) || 0;

            if(cart.length === 0) {
                cartDiv.innerHTML = '<p class="text-gray-400 text-sm italic text-center py-5">‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶®‡ßá‡¶á</p>';
                document.getElementById('cart-subtotal').innerText = '‡ß≥ ‡ß¶';
                document.getElementById('cart-vat').innerText = '‡ß≥ ‡ß¶';
                document.getElementById('cart-total').innerText = '‡ß≥ ‡ß¶';
                document.getElementById('cart-count').innerText = '0 ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ';
                return;
            }
            
            cartDiv.innerHTML = cart.map((item, index) => {
                let lineTotal = item.sell * item.orderQty;
                subtotal += lineTotal;
                return `
                <div class="cart-item flex items-center justify-between text-xs bg-white p-2 border-b gap-2">
                    <div class="flex-1">
                        <p class="font-bold">${item.name}</p>
                        <p class="text-gray-500">‡ß≥ ${item.sell} / ${item.unit || 'Pcs'}</p>
                    </div>
                    <div class="flex items-center gap-1">
                        <span>√ó</span>
                        <input type="number" value="${item.orderQty}" onchange="updateCartQty(${index}, this.value)" class="w-12 border rounded text-center p-1 text-sm">
                        <span class="text-[10px] text-gray-400">${item.unit || ''}</span>
                    </div>
                    <span class="font-bold w-16 text-right">‡ß≥ ${lineTotal}</span>
                </div>`;
            }).join('');
            
            let vatAmount = (subtotal * config.vat) / 100;
            let finalTotal = (subtotal + vatAmount) - discount;

            document.getElementById('cart-subtotal').innerText = '‡ß≥ ' + subtotal.toLocaleString();
            document.getElementById('cart-vat').innerText = '‡ß≥ ' + vatAmount.toLocaleString();
            document.getElementById('cart-total').innerText = '‡ß≥ ' + finalTotal.toLocaleString();
            document.getElementById('cart-count').innerText = cart.length + ' ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ';
        }

        function handleBarcode(e) {
            if(e.key === 'Enter') {
                let code = e.target.value.trim();
                let index = products.findIndex(p => p.barcode === code);
                if(index !== -1) {
                    addToCart(index);
                    e.target.value = "";
                } else {
                    showToast("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!", "error");
                    e.target.value = "";
                }
            }
        }

        // ==================== CHECKOUT ====================
        function checkout() {
            if (currentUserRole === 'staff' && !currentUserPermissions.pos) {
                showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ POS ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                return;
            }
            
            if(cart.length === 0) {
                showToast("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!", "error");
                return;
            }
            
            let subtotal = 0, costPriceTotal = 0;
            let customer = document.getElementById('pos-customer').value || "‡¶®‡¶ó‡¶¶ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞";
            let customerPhone = document.getElementById('pos-customer-phone').value || "N/A";
            let discount = parseFloat(document.getElementById('pos-discount').value) || 0;
            let paymentMethod = document.getElementById('pos-payment-method').value;
            let paid = parseFloat(document.getElementById('pos-paid').value) || 0;
            
            let printRows = "";
            let a4Rows = "";
            let currentCartCopy = JSON.parse(JSON.stringify(cart));

            cart.forEach(item => {
                let lineTotal = item.sell * item.orderQty;
                subtotal += lineTotal;
                costPriceTotal += (item.buy * item.orderQty);
                products[item.originalIndex].qty -= item.orderQty;
                logStock(item.name, '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø (‡¶Ü‡¶â‡¶ü)', item.orderQty, item.unit);
                printRows += `<div class="flex justify-between text-xs"><span>${item.name} (x${item.orderQty} ${item.unit || ''})</span><span>‡ß≥ ${lineTotal}</span></div>`;
                a4Rows += `<tr><td>${item.name}</td><td>${item.orderQty} ${item.unit || ''}</td><td>${item.sell}</td><td>${lineTotal}</td></tr>`;
            });

            let vatAmount = (subtotal * config.vat) / 100;
            let finalSubtotal = (subtotal + vatAmount) - discount;
            let profit = (subtotal - costPriceTotal) - discount;
            let due = finalSubtotal - paid;
            
            let earnedPoints = Math.floor(finalSubtotal / 100);
            if(customerPhone !== "N/A") {
                if(!customers[customerPhone]) customers[customerPhone] = { name: customer, points: 0 };
                customers[customerPhone].points += earnedPoints;
            }

            let record = { 
                inv: `INV-00${invoiceCount}`, 
                customer, 
                phone: customerPhone, 
                subtotal: subtotal,
                vat: vatAmount,
                discount: discount,
                amount: finalSubtotal, 
                profit: profit, 
                due, 
                status: due > 0 ? 'Due' : 'Paid',
                method: paymentMethod,
                date: new Date().toISOString(),
                cartItems: currentCartCopy,
                seller: currentUser,
                sellerRole: currentUserRole
            };
            salesRecords.push(record);
            invoiceCount++;
            
            saveToStorage();
            
            document.querySelectorAll('.invoice-date-print').forEach(el => el.innerText = new Date().toLocaleDateString('bn-BD'));
            document.querySelectorAll('.invoice-qr').forEach(el => el.src = generateQR(record.inv));
            document.querySelectorAll('.invoice-note').forEach(el => el.innerText = config.invoiceNote);

            document.getElementById('print-content').innerHTML = `
                <div class="text-xs mb-2">
                    <p>‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏: ${record.inv}</p>
                    <p>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞: ${customer} (${customerPhone})</p>
                    <p>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü: ${paymentMethod}</p>
                    <p>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ: ${currentUser}</p>
                </div>
                <hr class="border-dotted my-1">
                ${printRows}
                <hr class="border-dotted my-1">
                <div class="flex justify-between text-xs"><span>‡¶∏‡¶æ‡¶¨-‡¶ü‡ßã‡¶ü‡¶æ‡¶≤:</span><span>‡ß≥ ${subtotal}</span></div>
                <div class="flex justify-between text-xs"><span>‡¶≠‡ßç‡¶Ø‡¶æ‡¶ü (${config.vat}%):</span><span>‡ß≥ ${vatAmount}</span></div>
                <div class="flex justify-between text-xs"><span>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü:</span><span>- ‡ß≥ ${discount}</span></div>
                <div class="font-bold flex justify-between border-t border-dotted mt-1 pt-1"><span>‡¶Æ‡ßã‡¶ü:</span><span>‡ß≥ ${finalSubtotal}</span></div>
                <div class="flex justify-between text-[10px]"><span>‡¶™‡ßá‡¶á‡¶°:</span><span>‡ß≥ ${paid}</span></div>
                <div class="flex justify-between text-[10px] text-red-600 font-bold"><span>‡¶¨‡¶æ‡¶ï‡¶ø:</span><span>‡ß≥ ${due}</span></div>
            `;

            document.getElementById('a4-inv-no').innerText = record.inv;
            document.getElementById('a4-cust-name').innerText = "‡¶®‡¶æ‡¶Æ: " + customer;
            document.getElementById('a4-cust-phone').innerText = "‡¶´‡ßã‡¶®: " + customerPhone;
            document.getElementById('a4-table-body').innerHTML = a4Rows;
            document.getElementById('a4-subtotal').innerText = "‡ß≥ " + subtotal;
            document.getElementById('a4-vat').innerText = "‡ß≥ " + vatAmount;
            document.getElementById('a4-discount').innerText = "‡ß≥ " + discount;
            document.getElementById('a4-total').innerText = "‡ß≥ " + finalSubtotal;
            
            document.getElementById('pos-discount').value = "";
            document.getElementById('pos-paid').value = "";
            document.getElementById('pos-customer').value = "";
            document.getElementById('pos-customer-phone').value = "";

            cart = []; 
            renderCart(); 
            renderPOSProducts(); 
            renderRecentSales(); 
            calculateDashboardStats(); 
            closeModal('posModal');
            toggleInvoiceType('thermal');
            openModal('invoicePreviewModal');
            showToast("‚úÖ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        }

        // ==================== SALES & REPORTS ====================
        function renderRecentSales() {
            const body = document.getElementById('recent-sales-body');
            if(!body) return;
            body.innerHTML = salesRecords.slice().reverse().slice(0, 10).map(s => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-2 px-1 text-xs md:text-sm">${s.inv}</td>
                    <td class="py-2 text-xs md:text-sm">${s.customer}<br><span class="text-[10px] text-gray-400">${s.phone}</span></td>
                    <td class="py-2 font-bold text-xs md:text-sm">‡ß≥ ${s.amount}</td>
                    <td class="py-2"><span class="${s.status === 'Returned' ? 'bg-red-100 text-red-700' : (s.due > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700')} px-2 py-1 rounded-full text-[10px]">${s.status}</span></td>
                    <td class="py-2 text-[10px] md:text-xs">${s.seller || 'N/A'}</td>
                </tr>
            `).join('');
        }

        function calculateDashboardStats() {
            totalSales = 0; totalProfit = 0; totalDue = 0; totalStockValue = 0; totalExpense = 0;
            
            salesRecords.forEach(s => {
                totalSales += s.amount;
                totalProfit += s.profit;
                totalDue += s.due;
            });

            expenses.forEach(e => totalExpense += e.amount);
            
            let lowStockItems = [];
            let expiryItems = [];
            const today = new Date();
            const thirtyDaysLater = new Date();
            thirtyDaysLater.setDate(today.getDate() + 30);

            products.forEach(p => {
                totalStockValue += (p.buy * p.qty);
                if(p.qty < 5) lowStockItems.push(`${p.name} (‡¶∏‡ßç‡¶ü‡¶ï: ${p.qty} ${p.unit || ''})`);
                
                if(p.expiry) {
                    let expDate = new Date(p.expiry);
                    if(expDate <= thirtyDaysLater) expiryItems.push(`${p.name} (‡¶Æ‡ßá‡ßü‡¶æ‡¶¶: ${p.expiry})`);
                }
            });

            const alertDiv = document.getElementById('low-stock-alert');
            const itemsDiv = document.getElementById('low-stock-items');
            if(lowStockItems.length > 0) {
                alertDiv.style.display = 'block';
                itemsDiv.innerHTML = lowStockItems.map(i => `<li class="text-xs md:text-sm">${i}</li>`).join('');
            } else { alertDiv.style.display = 'none'; }

            const expAlertDiv = document.getElementById('expiry-alert');
            const expItemsDiv = document.getElementById('expiry-items');
            if(expiryItems.length > 0) {
                expAlertDiv.style.display = 'block';
                expItemsDiv.innerHTML = expiryItems.map(i => `<li class="text-xs md:text-sm">${i}</li>`).join('');
            } else { expAlertDiv.style.display = 'none'; }

            updateDashboard();
        }

        function updateDashboard() {
            document.getElementById('stat-sales').innerText = '‡ß≥ ' + totalSales.toLocaleString();
            document.getElementById('stat-profit').innerText = '‡ß≥ ' + totalProfit.toLocaleString();
            document.getElementById('stat-expense').innerText = '‡ß≥ ' + totalExpense.toLocaleString();
            document.getElementById('stat-net-profit').innerText = '‡ß≥ ' + (totalProfit - totalExpense).toLocaleString();
            document.getElementById('stat-due').innerText = '‡ß≥ ' + totalDue.toLocaleString();
            document.getElementById('stat-stock').innerText = '‡ß≥ ' + totalStockValue.toLocaleString();
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('bn-BD', { day:'numeric', month:'long', year:'numeric' });
        }

        function initCharts() {
            const salesCtx = document.getElementById('salesChart')?.getContext('2d');
            if(salesCtx) {
                new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Today'],
                        datasets: [{
                            label: '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø (‡ß≥)',
                            data: [0, 0, 0, 0, 0, 0, totalSales],
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            const topCtx = document.getElementById('topProductsChart')?.getContext('2d');
            if(topCtx && products.length > 0) {
                new Chart(topCtx, {
                    type: 'doughnut',
                    data: {
                        labels: products.slice(0,5).map(p => p.name),
                        datasets: [{
                            data: products.slice(0,5).map(p => p.qty),
                            backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function generateDetailedReport() {
            if (currentUserRole === 'staff' && !currentUserPermissions.dailyClosing) {
                showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                return;
            }
            
            let start = document.getElementById('report-start').value;
            let end = document.getElementById('report-end').value;
            if(!start || !end) {
                showToast("‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®", "error");
                return;
            }

            let startDate = new Date(start);
            let endDate = new Date(end);
            endDate.setHours(23, 59, 59);

            let filteredSales = salesRecords.filter(s => {
                let d = new Date(s.date);
                return d >= startDate && d <= endDate;
            });

            let filteredExpenses = expenses.filter(e => {
                let d = new Date(e.date);
                return d >= startDate && d <= endDate;
            });

            let rangeSales = 0, rangeProfit = 0, rangeExpense = 0;
            filteredSales.forEach(s => { rangeSales += s.amount; rangeProfit += s.profit; });
            filteredExpenses.forEach(e => { rangeExpense += e.amount; });

            document.getElementById('report-result').innerHTML = `
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="p-4 bg-blue-50 rounded">
                        <p class="text-xs">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</p>
                        <h4 class="text-xl font-bold">‡ß≥ ${rangeSales}</h4>
                    </div>
                    <div class="p-4 bg-green-50 rounded">
                        <p class="text-xs">‡¶Æ‡ßã‡¶ü ‡¶ó‡ßç‡¶∞‡¶∏ ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü</p>
                        <h4 class="text-xl font-bold">‡ß≥ ${rangeProfit}</h4>
                    </div>
                    <div class="p-4 bg-red-50 rounded">
                        <p class="text-xs">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</p>
                        <h4 class="text-xl font-bold">‡ß≥ ${rangeExpense}</h4>
                    </div>
                    <div class="p-4 bg-purple-50 rounded">
                        <p class="text-xs">‡¶®‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü</p>
                        <h4 class="text-xl font-bold">‡ß≥ ${rangeProfit - rangeExpense}</h4>
                    </div>
                </div>
            `;
        }

        function downloadPDFReport() {
            if (currentUserRole === 'staff' && !currentUserPermissions.dailyClosing) {
                showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let start = document.getElementById('report-start').value || "Start";
            let end = document.getElementById('report-end').value || "End";
            
            doc.setFontSize(18);
            doc.text(config.shopName, 105, 15, {align: 'center'});
            doc.setFontSize(12);
            doc.text(`Sales Report (${start} to ${end})`, 105, 25, {align: 'center'});

            let startD = new Date(start);
            let endD = new Date(end);
            endD.setHours(23,59,59);

            let filtered = salesRecords.filter(s => {
                let d = new Date(s.date);
                return d >= startD && d <= endD;
            });

            let tableData = filtered.map(s => [
                s.inv, 
                new Date(s.date).toLocaleDateString(), 
                s.customer, 
                s.amount, 
                s.profit, 
                s.status
            ]);

            doc.autoTable({
                startY: 35,
                head: [['Invoice', 'Date', 'Customer', 'Total (TK)', 'Profit (TK)', 'Status']],
                body: tableData,
            });

            let totalS = filtered.reduce((a, b) => a + b.amount, 0);
            let totalP = filtered.reduce((a, b) => a + b.profit, 0);
            
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total Sales: TK ${totalS}`, 14, finalY);
            doc.text(`Total Gross Profit: TK ${totalP}`, 14, finalY + 7);

            doc.save(`Report_${start}_to_${end}.pdf`);
        }

        // ==================== DUE COLLECTION ====================
        function searchDueRecords() {
            if (currentUserRole === 'staff' && !currentUserPermissions.dueCollection) {
                showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                return;
            }
            
            let q = document.getElementById('due-search').value.toLowerCase();
            let list = document.getElementById('due-records-list');
            let filtered = salesRecords.filter(s => s.due > 0 && (s.customer.toLowerCase().includes(q) || (s.phone && s.phone.includes(q))));
            
            list.innerHTML = filtered.map((s, idx) => `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-3 border-b hover:bg-gray-50">
                    <div class="mb-2 md:mb-0">
                        <p class="font-bold">${s.customer}</p>
                        <p class="text-xs text-red-500">‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥ ${s.due}</p>
                        <p class="text-xs text-gray-400">${s.inv}</p>
                    </div>
                    <button onclick="payDue('${s.inv}')" class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600 transition-all touch-target">
                        <i class="fas fa-hand-holding-usd mr-1"></i>‡¶Ü‡¶¶‡¶æ‡ßü
                    </button>
                </div>
            `).join('');
        }

        function payDue(invNo) {
            let amount = parseFloat(prompt("‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶ö‡ßç‡¶õ‡ßá‡¶®?"));
            if(!amount || amount <= 0) return;
            
            let record = salesRecords.find(s => s.inv === invNo);
            if(record) {
                if(amount > record.due) {
                    showToast("‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶ö‡ßá‡ßü‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü!", "error");
                    return;
                }
                record.due -= amount;
                if(record.due === 0) record.status = 'Paid';
                saveToStorage();
                calculateDashboardStats();
                searchDueRecords();
                renderRecentSales();
                showToast("‚úÖ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
            }
        }

        // ==================== RETURN ====================
        function findInvoiceForReturn() {
            if (currentUserRole === 'staff' && !currentUserPermissions.return) {
                showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                return;
            }
            
            let invNo = document.getElementById('return-inv-input').value.trim();
            let record = salesRecords.find(s => s.inv === invNo);
            let area = document.getElementById('return-items-area');
            
            if(!record) {
                showToast("‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!", "error");
                return;
            }
            if(!record.cartItems) {
                showToast("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶á ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏‡ßá‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§", "error");
                return;
            }

            area.innerHTML = `
                <div class="p-3 bg-indigo-50 rounded text-xs mb-2">
                    <p><b>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞:</b> ${record.customer} | <b>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</b> ${new Date(record.date).toLocaleDateString()}</p>
                    <p><b>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤:</b> ‡ß≥ ${record.amount} | <b>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü:</b> ${record.method}</p>
                </div>
                <p class="text-[10px] font-bold text-gray-500 uppercase mb-2">‡¶´‡ßá‡¶∞‡¶§‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶∏‡¶Æ‡ßÇ‡¶π:</p>
                ${record.cartItems.map((item, idx) => `
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between bg-white border p-3 rounded shadow-sm mb-2">
                        <div class="flex-1 mb-2 md:mb-0">
                            <p class="font-bold text-sm">${item.name}</p>
                            <p class="text-xs text-gray-500">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶§ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ${item.orderQty} ${item.unit || ''}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="return-qty-${idx}" value="0" min="0" max="${item.orderQty}" class="w-16 border rounded p-2 text-center font-bold text-red-600">
                            <button onclick="confirmItemReturn('${invNo}', ${idx})" class="bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600 transition-all touch-target">
                                <i class="fas fa-undo mr-1"></i>‡¶´‡ßá‡¶∞‡¶§
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function confirmItemReturn(invNo, itemIdx) {
            let returnQty = parseFloat(document.getElementById(`return-qty-${itemIdx}`).value) || 0;
            if(returnQty <= 0) {
                showToast("‡¶ï‡¶§‡¶ü‡ßÅ‡¶ï‡ßÅ ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡¶ø‡¶¨‡ßá‡¶® ‡¶§‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡¶ø‡¶®‡•§", "error");
                return;
            }

            let record = salesRecords.find(s => s.inv === invNo);
            let item = record.cartItems[itemIdx];

            if(returnQty > item.orderQty) {
                showToast("‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶§ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£‡ßá‡¶∞ ‡¶ö‡ßá‡ßü‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡ßü‡•§", "error");
                return;
            }

            if(!confirm(`${item.name} ‡¶è‡¶∞ ${returnQty} ${item.unit || ''} ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶ö‡ßç‡¶õ‡ßá‡¶®? ‡¶è‡¶∞ ‡¶´‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá‡•§`)) return;

            let productInSystem = products.find(p => p.name === item.name);
            if(productInSystem) {
                productInSystem.qty += returnQty;
                logStock(item.name, '‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® (‡¶á‡¶®)', returnQty, item.unit);
            }

            item.orderQty -= returnQty;
            
            let returnAmount = item.sell * returnQty;
            let returnCost = item.buy * returnQty;
            
            record.subtotal -= returnAmount;
            record.profit -= (returnAmount - returnCost);
            record.amount -= returnAmount;

            if(record.cartItems.every(i => i.orderQty === 0)) record.status = 'Returned';

            saveToStorage();
            calculateDashboardStats();
            renderRecentSales();
            renderPOSProducts();
            
            showToast("‚úÖ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
            findInvoiceForReturn();
        }

        // ==================== SUPPLIER ====================
        function addSupplier() {
            let name = document.getElementById('sup-name').value;
            let due = parseFloat(document.getElementById('sup-due').value) || 0;
            if(!name) {
                showToast("‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®", "error");
                return;
            }
            suppliers.push({ name, due });
            saveToStorage();
            renderSupplierList();
            document.getElementById('sup-name').value = '';
            document.getElementById('sup-due').value = '';
            showToast("‚úÖ ‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á‡ßü‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        }

        function renderSupplierList() {
            const body = document.getElementById('supplier-list-body');
            if(!body) return;
            body.innerHTML = suppliers.map((s, idx) => `
                <tr class="border-b text-xs hover:bg-gray-50">
                    <td class="p-2">${s.name}</td>
                    <td class="p-2 text-red-600 font-bold">‡ß≥ ${s.due}</td>
                    <td class="p-2">
                        <button onclick="paySupplier(${idx})" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600 transition-all touch-target">
                            <i class="fas fa-money-bill mr-1"></i>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function paySupplier(idx) {
            let amount = parseFloat(prompt("‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®?"));
            if(amount && amount > 0) {
                suppliers[idx].due -= amount;
                saveToStorage();
                renderSupplierList();
                showToast("‚úÖ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!", "success");
            }
        }

        // ==================== EXPENSE ====================
        function addExpense() {
            if (currentUserRole === 'staff' && !currentUserPermissions.expenseView) {
                showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ñ‡¶∞‡¶ö ‡¶è‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                return;
            }
            
            let amount = parseFloat(document.getElementById('exp-amount').value) || 0;
            let title = document.getElementById('exp-title').value;
            let date = document.getElementById('exp-date').value || new Date().toISOString().split('T')[0];
            if(!title || !amount) {
                showToast("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®", "error");
                return;
            }
            expenses.push({ title, amount, date });
            saveToStorage();
            calculateDashboardStats(); 
            closeModal('expenseModal'); 
            showToast("‚úÖ ‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        }

        // ==================== STOCK HISTORY ====================
        function logStock(productName, type, qty, unit = '') {
            stockHistory.push({
                date: new Date().toLocaleString('bn-BD'),
                name: productName,
                type: type, 
                qty: qty + (unit ? ' ' + unit : ''),
                rawDate: new Date().toISOString()
            });
            saveToStorage();
        }

        function renderStockHistory() {
            const body = document.getElementById('stock-history-body');
            if(!body) return;
            body.innerHTML = stockHistory.slice().reverse().map(h => `
                <tr class="border-b text-xs hover:bg-gray-50">
                    <td class="p-2">${h.date}</td>
                    <td class="p-2">${h.name}</td>
                    <td class="p-2"><span class="${h.type.includes('‡¶Ü‡¶â‡¶ü') || h.type.includes('‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®') ? 'text-red-500' : 'text-green-500'}">${h.type}</span></td>
                    <td class="p-2">${h.qty}</td>
                </tr>
            `).join('');
        }

        // ==================== CUSTOMER ====================
        function checkCustomerStatus() {
            let name = document.getElementById('pos-customer').value;
            let found = Object.values(customers).find(c => c.name === name);
            if(found) {
                document.getElementById('avail-points').innerText = found.points || 0;
            }
        }

        function renderCustomerDatalist() {
            let dl = document.getElementById('customer-list');
            if(!dl) return;
            dl.innerHTML = Object.keys(customers).map(c => `<option value="${customers[c].name}">`).join('');
        }

        // ==================== DAILY CLOSING ====================
        function dailyClosingReport() {
            if (currentUserRole === 'staff' && !currentUserPermissions.dailyClosing) {
                showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
                return;
            }
            
            let today = new Date().toISOString().split('T')[0];
            let todaySales = salesRecords.filter(s => s.date.includes(today));
            let todayCash = todaySales.filter(s => s.method === 'Cash').reduce((acc, curr) => acc + curr.amount, 0);
            let todayBkash = todaySales.filter(s => s.method === 'Bkash').reduce((acc, curr) => acc + curr.amount, 0);
            let totalS = todaySales.reduce((acc, curr) => acc + curr.amount, 0);
            let totalE = expenses.filter(e => e.date === today).reduce((acc, curr) => acc + curr.amount, 0);

            alert(`üìä ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü\n\n‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø: ‡ß≥ ${totalS}\n‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ú‡¶Æ‡¶æ: ‡ß≥ ${todayCash}\n‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶ú‡¶Æ‡¶æ: ‡ß≥ ${todayBkash}\n‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö: ‡ß≥ ${totalE}\n‡¶®‡¶ø‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂: ‡ß≥ ${todayCash - totalE}`);
        }

        // ==================== SETTINGS ====================
        function previewLogo(event) {
            const reader = new FileReader();
            reader.onload = function(){
                config.logo = reader.result;
                const preview = document.getElementById('logo-preview-img');
                preview.src = reader.result;
                preview.classList.remove('hidden');
            }
            reader.readAsDataURL(event.target.files[0]);
        }

        function applyConfig() { 
            document.querySelectorAll('.shop-name-display').forEach(el => el.innerText = config.shopName);
            document.getElementById('conf-shop-name').value = config.shopName;
            document.getElementById('conf-vat').value = config.vat;
            document.getElementById('conf-note').value = config.invoiceNote;
            if(config.logo) {
                document.getElementById('logo-preview-img').src = config.logo;
                document.getElementById('logo-preview-img').classList.remove('hidden');
                document.getElementById('thermal-logo').src = config.logo;
                document.getElementById('thermal-logo').classList.remove('hidden');
                document.getElementById('a4-logo').src = config.logo;
                document.getElementById('a4-logo').classList.remove('hidden');
            }
        }

        function saveSettings() {
            config.shopName = document.getElementById('conf-shop-name').value;
            config.vat = parseFloat(document.getElementById('conf-vat').value) || 0;
            config.invoiceNote = document.getElementById('conf-note').value;
            saveToStorage();
            applyConfig();
            closeModal('settingsModal');
            showToast("‚úÖ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        }

        // ==================== INVOICE ====================
        function toggleInvoiceType(type) {
            const thermal = document.getElementById('print-section');
            const a4 = document.getElementById('a4-print-section');
            const btnT = document.getElementById('btn-thermal');
            const btnA = document.getElementById('btn-a4');

            if(type === 'a4') {
                thermal.classList.add('hidden');
                a4.classList.remove('hidden');
                btnA.className = "bg-indigo-600 text-white px-3 py-1 rounded text-xs";
                btnT.className = "bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs";
            } else {
                thermal.classList.remove('hidden');
                a4.classList.add('hidden');
                btnT.className = "bg-indigo-600 text-white px-3 py-1 rounded text-xs";
                btnA.className = "bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs";
            }
        }

        function generateQR(text) {
            return `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(text)}`;
        }

        function sendWhatsApp() {
            let phone = document.getElementById('pos-customer-phone').value;
            if(phone === "N/A" || !phone) {
                phone = prompt("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶® (Ex: 88017...):");
            }
            if(!phone) return;
            let invoiceText = document.getElementById('print-content').innerText;
            let msg = encodeURIComponent("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Æ‡ßá‡¶Æ‡ßã:\n" + invoiceText + "\n‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶!");
            window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
        }

        // ==================== EXPORT ====================
        function exportData() {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
                showToast("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶®‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®!", "error");
                return;
            }
            
            let data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({
                products, 
                salesRecords, 
                expenses, 
                stockHistory, 
                customers, 
                config, 
                suppliers
            }));
            let link = document.createElement('a');
            link.setAttribute("href", data);
            link.setAttribute("download", `backup_${currentUser}_${new Date().toISOString().split('T')[0]}.json`);
            link.click();
            showToast("‚úÖ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá!", "success");
        }

        function clearAllData() {
            if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
                showToast("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®!", "error");
                return;
            }
            if(confirm("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶¨‡ßá‡•§ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) { 
                localStorage.clear(); 
                location.reload(); 
            }
        }

        // ==================== KEYBOARD SHORTCUTS ====================
        window.addEventListener('keydown', (e) => {
            if(e.key === 'F2') { 
                e.preventDefault(); 
                openModal('posModal'); 
            }
            if(e.key === 'Escape') { 
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
                document.body.style.overflow = '';
            }
        });

        window.onclick = function(event) { 
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        function setLayoutPreference(layout) {
            localStorage.setItem('layout_preference', layout);
            document.body.setAttribute('data-layout', layout);
        }

        window.onload = function() {
            initializeSystem();
            
            const savedUser = localStorage.getItem('currentUser');
            const savedRole = localStorage.getItem('currentUserRole');
            const savedOwner = localStorage.getItem('currentUserOwner');
            const savedPermissions = localStorage.getItem('currentUserPermissions');
            
            if (savedUser && savedRole) {
                currentUser = savedUser;
                currentUserRole = savedRole;
                currentUserOwner = savedOwner || null;
                currentUserPermissions = savedPermissions ? JSON.parse(savedPermissions) : {};
                
                const user = users.find(u => u.username === savedUser);
                if (savedUser === 'admin' || (user && user.approved)) {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-content').classList.remove('hidden');
                    updateUserDisplay();
                    loadUserData();
                    applyPermissions();
                } else {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('currentUserRole');
                    localStorage.removeItem('currentUserOwner');
                    localStorage.removeItem('currentUserPermissions');
                }
            }
        };
    </script>
</body>
</html>
